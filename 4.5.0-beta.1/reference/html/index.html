<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Cloud Azure - Reference Documentation</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "b9g1q6wz23"); </script>

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud Azure - Reference Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#getting-help">1. Getting Help</a></li>
<li><a href="#what-is-new-in-4-0-since-3-10-x">2. What Is New in 4.0 Since 3.10.x</a></li>
<li><a href="#migration-guide-for-4-0">3. Migration Guide for 4.0</a></li>
<li><a href="#getting-started">4. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#setting-up-dependencies">4.1. Setting up Dependencies</a></li>
<li><a href="#learning-spring-cloud-azure">4.2. Learning Spring Cloud Azure</a></li>
</ul>
</li>
<li><a href="#configuration">5. Configuration</a></li>
<li><a href="#authentication">6. Authentication</a>
<ul class="sectlevel2">
<li><a href="#defaultazurecredential">6.1. DefaultAzureCredential</a></li>
<li><a href="#managed-identities">6.2. Managed Identities</a></li>
<li><a href="#other-credential-types">6.3. Other Credential Types</a></li>
</ul>
</li>
<li><a href="#production-ready">7. Production Ready</a>
<ul class="sectlevel2">
<li><a href="#enable-health-indicator">7.1. Enable Health Indicator</a></li>
<li><a href="#enable-sleuth">7.2. Enable Sleuth</a></li>
</ul>
</li>
<li><a href="#autoconfigure-azure-sdk-clients">8. Autoconfigure Azure SDK Clients</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup">8.1. Dependency Setup</a></li>
<li><a href="#configuration-2">8.2. Configuration</a></li>
<li><a href="#basic-usage">8.3. Basic Usage</a></li>
<li><a href="#samples">8.4. Samples</a></li>
</ul>
</li>
<li><a href="#resource-handling">9. Resource Handling</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-2">9.1. Dependency Setup</a></li>
<li><a href="#configuration-3">9.2. Configuration</a></li>
<li><a href="#basic-usage-2">9.3. Basic Usage</a></li>
<li><a href="#samples-2">9.4. Samples</a></li>
</ul>
</li>
<li><a href="#secret-management">10. Secret Management</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-3">10.1. Dependency Setup</a></li>
<li><a href="#basic-usage-3">10.2. Basic Usage</a></li>
<li><a href="#advanced-usage">10.3. Advanced Usage</a></li>
<li><a href="#samples-3">10.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-data-support">11. Spring Data Support</a>
<ul class="sectlevel2">
<li><a href="#spring-data-cosmosdb-support">11.1. Spring Data CosmosDB Support</a></li>
<li><a href="#dependency-setup-4">11.2. Dependency Setup</a></li>
<li><a href="#configuration-4">11.3. Configuration</a></li>
<li><a href="#key-concepts">11.4. Key Concepts</a></li>
<li><a href="#basic-usage-4">11.5. Basic Usage</a></li>
<li><a href="#samples-4">11.6. Samples</a></li>
</ul>
</li>
<li><a href="#spring-security-support">12. Spring Security Support</a>
<ul class="sectlevel2">
<li><a href="#spring-security-with-azure-active-directory">12.1. Spring Security With Azure Active Directory</a></li>
<li><a href="#spring-security-with-azure-active-directory-b2c">12.2. Spring Security With Azure Active Directory B2C</a></li>
</ul>
</li>
<li><a href="#spring-integration-support">13. Spring Integration Support</a>
<ul class="sectlevel2">
<li><a href="#spring-integration-with-azure-event-hubs">13.1. Spring Integration with Azure Event Hubs</a></li>
<li><a href="#spring-integration-with-azure-service-bus">13.2. Spring Integration with Azure Service Bus</a></li>
<li><a href="#spring-integration-with-azure-storage-queue">13.3. Spring Integration with Azure Storage Queue</a></li>
</ul>
</li>
<li><a href="#spring-cloud-stream-support">14. Spring Cloud Stream Support</a>
<ul class="sectlevel2">
<li><a href="#spring-cloud-stream-binder-for-azure-event-hubs">14.1. Spring Cloud Stream Binder for Azure Event Hubs</a></li>
<li><a href="#spring-cloud-stream-binder-for-azure-service-bus">14.2. Spring Cloud Stream Binder for Azure Service Bus</a></li>
</ul>
</li>
<li><a href="#spring-jms-support">15. Spring JMS Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-11">15.1. Dependency Setup</a></li>
<li><a href="#configuration-12">15.2. Configuration</a></li>
<li><a href="#basic-usage-11">15.3. Basic Usage</a></li>
<li><a href="#samples-15">15.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-native-support">16. Spring Native Support</a>
<ul class="sectlevel2">
<li><a href="#spring-native">16.1. Spring Native</a></li>
<li><a href="#support">16.2. Support</a></li>
<li><a href="#project-setup">16.3. Project Setup</a></li>
<li><a href="#build-the-native-application">16.4. Build the native application</a></li>
<li><a href="#run-the-native-application">16.5. Run the native application</a></li>
<li><a href="#samples-16">16.6. Samples</a></li>
</ul>
</li>
<li><a href="#mysql-support">17. MySQL support</a>
<ul class="sectlevel2">
<li><a href="#supported-mysql-version">17.1. Supported MySQL version</a></li>
<li><a href="#core-features">17.2. Core Features</a></li>
<li><a href="#how-it-works">17.3. How it works</a></li>
<li><a href="#configuration-13">17.4. Configuration</a></li>
<li><a href="#dependency-setup-12">17.5. Dependency setup</a></li>
<li><a href="#basic-usage-12">17.6. Basic usage</a></li>
<li><a href="#migrate-an-application-to-use-passwordless-connections-with-azure-database-for-mysql">17.7. Migrate an application to use passwordless connections with Azure Database for MySQL</a></li>
</ul>
</li>
<li><a href="#kafka-support">18. Kafka Support</a>
<ul class="sectlevel2">
<li><a href="#supported-kafka-version">18.1. Supported Kafka version</a></li>
<li><a href="#supported-authentication-types">18.2. Supported authentication types</a></li>
<li><a href="#how-it-works-2">18.3. How it works</a></li>
<li><a href="#configuration-14">18.4. Configuration</a></li>
<li><a href="#dependency-setup-13">18.5. Dependency Setup</a></li>
<li><a href="#basic-usage-13">18.6. Basic usage</a></li>
<li><a href="#samples-18">18.7. Samples</a></li>
<li><a href="#migrate-an-application-to-use-passwordless-connections-with-azure-event-hubs-for-kafka">18.8. Migrate an application to use passwordless connections with Azure Event Hubs for Kafka</a></li>
</ul>
</li>
<li><a href="#redis-support">19. Redis Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-17">19.1. Dependency Setup</a></li>
<li><a href="#configuration-17">19.2. Configuration</a></li>
<li><a href="#basic-usage-14">19.3. Basic Usage</a></li>
<li><a href="#samples-19">19.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-cloud-azure-resourcemanager">20. Azure Resource Manager</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-18">20.1. Dependency Setup</a></li>
<li><a href="#configuration-18">20.2. Configuration</a></li>
<li><a href="#resource-manager-basic-usage">20.3. Basic Usage</a></li>
<li><a href="#samples-20">20.4. Samples</a></li>
</ul>
</li>
<li><a href="#configuration-properties-2">21. Configuration Properties</a></li>
<li><a href="#appendix">22. Appendix</a>
<ul class="sectlevel2">
<li><a href="#configuration-properties-3">22.1. Configuration properties</a></li>
<li><a href="#migration-guide-for-4-0-2">22.2. Migration guide for 4.0</a></li>
<li><a href="#known-issues">22.3. Known issues</a></li>
<li><a href="#create-and-configure-a-managed-identity-on-azure-hosting-services">22.4. Create and configure a managed identity on Azure hosting services</a></li>
<li><a href="#deploy-application-to-azure-hosting-services">22.5. Deploy application to Azure hosting services</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document is only for Spring Cloud Azure: <strong>4.5.0-beta.1</strong>. See <a href="https://github.com/Azure/azure-sdk-for-java/wiki/Spring-Versions-Mapping">Spring Versions Mapping</a> to get more information about supported versions.</p>
</div>
<div class="paragraph">
<p>&#169; 2016-2022 the original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring is an open-source application framework developed by VMware that provides a simplified, modular approach for creating Java applications. Spring Cloud Azure is an open-source project that provides seamless Spring integration with Azure services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-help"><a class="anchor" href="#getting-help"></a><a class="link" href="#getting-help">1. Getting Help</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have any questions about this document, please ask by creating GitHub issues. And Pull Request is welcome.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 1. GitHub repositories</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">GitHub repositories</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_4.5.0-beta.1/sdk/spring">Azure/azure-sdk-for-java</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the source code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/microsoft/spring-cloud-azure">microsoft/spring-cloud-azure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the document which is displaying in current page.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="what-is-new-in-4-0-since-3-10-x"><a class="anchor" href="#what-is-new-in-4-0-since-3-10-x"></a><a class="link" href="#what-is-new-in-4-0-since-3-10-x">2. What Is New in 4.0 Since 3.10.x</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page covers changes made in 4.0 since 3.10. With this major release, we aim to bring better security, leaner dependencies, support for production readiness, and more.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following list summarizes some of the changes that Spring Cloud Azure 4.0 provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A unified development experience, with unified project name, artifact ID, and properties.</p>
</li>
<li>
<p>Simplified dependency management using a single <code>spring-cloud-azure-dependencies</code> BOM.</p>
</li>
<li>
<p>Expanded Azure support on <a href="https://start.spring.io">Spring Initializr</a> to cover Kafka, Event Hubs, Azure Cache for Redis, and Azure App Configuration.</p>
</li>
<li>
<p>Rearchitected Spring module dependencies to remove excess layers and entanglement.</p>
</li>
<li>
<p>Managed Identity support for Azure App Configuration, Event Hubs, Service Bus, Cosmos DB, Key Vault, Storage Blob, and Storage Queue.</p>
</li>
<li>
<p>Continued support for authentication methods in the underlying Azure SDK from our Spring libraries, such as SAS token and token credential authentication with Service Bus and Event Hubs.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/java/api/overview/azure/identity-readme?view=azure-java-stable&amp;preserve-view=true#defaultazurecredential">Credential chain</a> is now enabled by default, enabling applications to obtain credentials from application properties, environment variables, managed identity, IDEs, and so on.</p>
</li>
<li>
<p>Granular access control at the resource level (such as Service Bus queue) to enable better security governance and adherence to IT policies.</p>
</li>
<li>
<p>More options exposed in a Spring-idiomatic way through significantly improved auto-configuration coverage of Azure SDK clients for both synchronous and asynchronous scenarios.</p>
</li>
<li>
<p>Added health indicators for Azure App Configuration, Event Hubs, Cosmos DB, Key Vault, Storage Blob, Storage Queue, and Storage File.</p>
</li>
<li>
<p>Spring Cloud Sleuth support for all HTTP-based Azure SDKs.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migration-guide-for-4-0"><a class="anchor" href="#migration-guide-for-4-0"></a><a class="link" href="#migration-guide-for-4-0">3. Migration Guide for 4.0</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a><a class="link" href="#getting-started">4. Getting Started</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="setting-up-dependencies"><a class="anchor" href="#setting-up-dependencies"></a><a class="link" href="#setting-up-dependencies">4.1. Setting up Dependencies</a></h3>
<div class="sect3">
<h4 id="bill-of-material-bom"><a class="anchor" href="#bill-of-material-bom"></a><a class="link" href="#bill-of-material-bom">4.1.1. Bill of Material (BOM)</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
      &lt;version&gt;4.5.0-beta.1&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="starter-dependencies"><a class="anchor" href="#starter-dependencies"></a><a class="link" href="#starter-dependencies">4.1.2. Starter Dependencies</a></h4>
<div class="paragraph">
<p>Spring Cloud Azure Starters are a set of convenient dependency descriptors to include in your application. Each starter includes all the dependencies and transitive dependencies needed to begin using its corresponding Spring Cloud Azure module. They boost your Spring Boot application development with Azure services.</p>
</div>
<div class="paragraph">
<p>For example, if you want to get started using Azure Cosmos DB for data persistence, include the <code>spring-cloud-azure-starter-cosmos</code> dependency in your project.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Azure provides the following starters under the <code>com.azure.spring</code> group:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Spring Cloud Azure starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core starter, including autoconfiguration support</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory-b2c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory B2C with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-appconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure App Configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Key Vault</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault-certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Key Vault Certificates</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault-secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Key Vault Secrets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus-jms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and JMS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Blob</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage File Share</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-actuator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Spring Bootâ€™s Actuator which provides production ready features</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Data</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Spring Data related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-data-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB and Spring Data Cosmos DB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Integration</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Spring Integration related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue and Spring Integration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Cloud Stream</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Spring Cloud Stream related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starters for using Azure Event Hubs and Spring Cloud Stream Binder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Cloud Stream Binder</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="learning-spring-cloud-azure"><a class="anchor" href="#learning-spring-cloud-azure"></a><a class="link" href="#learning-spring-cloud-azure">4.2. Learning Spring Cloud Azure</a></h3>
<div class="paragraph">
<p>We prepared a full list of samples to show the usages, can be found at <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">Spring Cloud Azure Samples</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a><a class="link" href="#configuration">5. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of Azure SDKs could be divided into two categories by transport type, HTTP-based and AMQP-based. There are properties that are common to all SDKs such as authentication principals and Azure environment settings. Or common to HTTP-based clients, such as logging level to log HTTP requests and responses. Spring Cloud Azure 4.0 provides five common categories of configuration properties, which could be specified to each Azure service.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Service common properties</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients underneath one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to one Azure service SDK. The retry options has supported part of the SDKs, there&#8217;s no <code>spring.cloud.azure.cosmos.retry</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are some properties that could be shared among different Azure services, for example using the same service principal to access Azure Cosmos DB and Azure Event Hubs. Spring Cloud Azure 4.0 allows application developers to specify properties that apply to all Azure SDKs with the prefix <code>spring.cloud.azure</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Global properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients apply to all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options apply to all Azure SDK clients by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to all Azure SDK clients by default.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties configured under each Azure service will override the global configurations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Cloud Azure unifies configuration properties' prefixes to <code>spring.cloud.azure</code> since 4.0, which will make configuration properties more consistent and more intuitive. Here&#8217;s a quick review of the serivce specific properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Service specific properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Configuration Property Prefix</th>
<th class="tableblock halign-left valign-top">Configuration Properties Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>appconfiguration</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_app_configuration_proeprties">App Configuration Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>cosmos</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_cosmos_proeprties">Cosmos Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>eventhubs</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_event_hubs_proeprties">Event Hubs Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.certificate</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_key_vault_certificates_proeprties">Key Vault Certificates Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.secret</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_key_vault_secrets_proeprties">Key Vault Secrets Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>servicebus</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_service_bus_proeprties">Service Bus Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.blob</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_storage_blob_proeprties">Storage Blob Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.fileshare</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_storage_file_share_proeprties">Storage File Share Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.queue</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#azure_storage_queue_proeprties">Storage Queue Properties</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a><a class="link" href="#authentication">6. Authentication</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defaultazurecredential"><a class="anchor" href="#defaultazurecredential"></a><a class="link" href="#defaultazurecredential">6.1. DefaultAzureCredential</a></h3>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> is appropriate for most scenarios where the application is intended to be run in the Azure Cloud. This is because the DefaultAzureCredential combines credentials commonly used to authenticate when deployed, with credentials used to authenticate in a development environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DefaultAzureCredential is intended to simplify getting started with the SDK by handling common scenarios with reasonable default behaviors. Developers who want more control or whose scenario isn&#8217;t served by the default settings should use other credential types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> will attempt to authenticate via the following mechanisms in order.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://user-images.githubusercontent.com/13167207/143148654-f3a37180-85e2-4360-a47d-c1af2da8fada.png" alt="DefaultAzureCredential">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment - The <code>DefaultAzureCredential</code> will read account information specified via environment variables and use it to authenticate.</p>
</li>
<li>
<p>Managed Identity - If the application is deployed to an Azure host with Managed Identity enabled, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>IntelliJ - If the developer has authenticated via Azure Toolkit for IntelliJ, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Visual Studio Code - If the developer has authenticated via the Visual Studio Code Azure Account plugin, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Azure CLI - If the developer has authenticated an account via the Azure CLI az login command, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since Spring Cloud Azure AutoConfigure 4.1.0, a <code>ThreadPoolTaskExecutor</code> bean named <code>springCloudAzureCredentialTaskExecutor</code> will be automatically registered by default and will manage all threads created by Azure Identity. The name of each thread managed by this thread pool is prefixed with <code>az-identity-</code>. This <code>ThreadPoolTaskExecutor</code> bean is independent of the <code>Executor</code> bean provided by Spring Boot.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-identities"><a class="anchor" href="#managed-identities"></a><a class="link" href="#managed-identities">6.2. Managed Identities</a></h3>
<div class="paragraph">
<p>A common challenge for developers is the management of secrets and credentials used to secure communication between different components making up a solution. Managed identities eliminate the need for developers to manage credentials. Managed identities provide an identity for applications to use when connecting to resources that support Azure Active Directory (Azure AD) authentication. Applications may use the managed identity to obtain Azure AD tokens. For example, an application may use a managed identity to access resources like Azure Key Vault where developers can store credentials in a secure manner or to access storage accounts.</p>
</div>
<div class="paragraph">
<p>We encourage using managed identity instead of using connection string or key in your application for it&#8217;s more secure and will save the trouble of managing secrets and credentials. In this case, <code>DefaultAzureCredential</code> could better serve the scenario of developing locally using account information stored locally and deploying the application to Azure Cloud and using Managed Identity.</p>
</div>
<div class="sect3">
<h4 id="managed-identity-types"><a class="anchor" href="#managed-identity-types"></a><a class="link" href="#managed-identity-types">6.2.1. Managed Identity Types</a></h4>
<div class="paragraph">
<p>There are two types of managed identities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System-assigned</strong> Some Azure services allow you to enable a managed identity directly on a service instance. When you enable a system-assigned managed identity an identity is created in Azure AD that&#8217;s tied to the lifecycle of that service instance. So when the resource is deleted, Azure automatically deletes the identity for you. By design, only that Azure resource can use this identity to request tokens from Azure AD.</p>
</li>
<li>
<p><strong>User-assigned</strong> You may also create a managed identity as a standalone Azure resource. You can create a user-assigned managed identity and assign it to one or more instances of an Azure service. In the case of user-assigned managed identities, the identity is managed separately from the resources that use it.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using a user-assigned managed identity, you can specify the client ID by <code>spring.cloud.azure.credential.client-id</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential.client-id</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a> for more details about managed identity.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="other-credential-types"><a class="anchor" href="#other-credential-types"></a><a class="link" href="#other-credential-types">6.3. Other Credential Types</a></h3>
<div class="paragraph">
<p>Developers who want more control or whose scenario isn&#8217;t served by the <code>DefaultAzureCredential</code> or whose scenario isn&#8217;t served by the default settings should use other credential types.</p>
</div>
<div class="sect3">
<h4 id="authentication-and-authorization-with-azure-active-directory"><a class="anchor" href="#authentication-and-authorization-with-azure-active-directory"></a><a class="link" href="#authentication-and-authorization-with-azure-active-directory">6.3.1. Authentication and Authorization with Azure Active Directory</a></h4>
<div class="paragraph">
<p>With Azure AD, you can use Azure role-based access control (Azure RBAC) to grant permissions to a security principal, which may be a user or an application service principal. When a security principal (a user, or an application) attempts to access an Azure resource, for example, an Event Hubs resource, the request must be authorized. With Azure AD, access to a resource is a two-step process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, the security principal&#8217;s identity is authenticated, and an OAuth 2.0 token is returned.</p>
</li>
<li>
<p>Next, the token is passed as part of a request to the Azure service to authorize access to the specified resource.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="authenticate-with-azure-active-directory"><a class="anchor" href="#authenticate-with-azure-active-directory"></a><a class="link" href="#authenticate-with-azure-active-directory">Authenticate with Azure Active Directory</a></h5>
<div class="paragraph">
<p>For applications want to connect to resources that support Azure AD authentication, below configurations could be set with prefix <code>spring.cloud.azure.credential</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Authentication properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application will look in several places to find an available credential, and will use <code>DefaultAzureCredential</code> if no credential properties are configured. If you want to use specific credential, see the following examples for guidance.</p>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a system-assigned managed identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    managed-identity-enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a user-assigned managed identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    managed-identity-enabled: true
    client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a service principal with a client secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    client-id: ${AZURE_CLIENT_ID}
    client-secret: ${AZURE_CLIENT_SECRET}
  profile:
    tenant-id: ${AZURE_TENANT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a service principal with a client PFX certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    client-id: ${AZURE_CLIENT_ID}
    client-certificate-path: ${AZURE_CLIENT_CERTIFICATE_PATH}
    client-certificate-password: ${AZURE_CLIENT_CERTIFICATE_PASSWORD}
  profile:
    tenant-id: ${AZURE_TENANT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a service principal with client PEM certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    client-id: ${AZURE_CLIENT_ID}
    client-certificate-path: ${AZURE_CLIENT_CERTIFICATE_PATH}
  profile:
    tenant-id: ${AZURE_TENANT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate using a user credential:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    client-id: ${AZURE_CLIENT_ID}
    username: ${AZURE_USER_USERNAME}
    password: ${AZURE_USER_PASSWORD}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows you how to authenticate with Key Vault using a different service principal. This example configures the application with two credentials: one system-assigned managed identity and one service principal. The Key Vault Secret client will use the service principal, but any other components will use managed identity instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring.cloud.azure:
  credential:
    managed-identity-enabled: true
  keyvault.secret:
    credential:
      client-id: ${AZURE_CLIENT_ID}
      client-secret: ${AZURE_CLIENT_SECRET}
    profile:
      tenant-id: ${AZURE_TENANT_ID}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="authorize-access-with-azure-active-directory"><a class="anchor" href="#authorize-access-with-azure-active-directory"></a><a class="link" href="#authorize-access-with-azure-active-directory">Authorize Access with Azure Active Directory</a></h5>
<div class="paragraph">
<p>The authorization step requires that one or more Azure roles be assigned to the security principal. The roles that are assigned to a security principal decide the permissions that the principal will have.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Azure built-in roles please check <a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles">Azure built-in roles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Following are the Azure built-in roles for authorizing access to Azure services supported in Spring Cloud Azure:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Azure built-in roles</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-owner">App Configuration Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows full access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-reader">App Configuration Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows read access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-owner">Azure Event Hubs Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-receiver">Azure Event Hubs Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows receive access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-send">Azure Event Hubs Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows send access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-owner">Azure Service Bus Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-receiver">Azure Service Bus Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for receive access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-sender">Azure Service Bus Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for send access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-owner">Storage Blob Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides full access to Azure Storage blob containers and data, including assigning POSIX access control.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-reader">Storage Blob Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage containers and blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-queue-data-reader">Storage Queue Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage queues and queue messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#redis-cache-contributor">Redis Cache Contributor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Redis caches.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using Spring Cloud Azure Resource Manager to get the connection strings of Event Hubs, Service Bus, and Storage Queue, or properties of Cache for Redis, assign the Azure built-in role <code>Contributor</code>. Azure Cache for Redis is special, and you can also assign the <code>Redis Cache Contributor</code> role to get the Redis properties.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Key Vault access policy determines whether a given security principal, namely a user, application or user group, can perform different operations on Key Vault secrets, keys, and certificates. You can assign access policies using the Azure portal, the Azure CLI, or Azure PowerShell. Check <a href="https://docs.microsoft.com/azure/key-vault/general/assign-access-policy">here</a> for more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Azure Cosmos DB exposes 2 built-in role definitions: <code>Cosmos DB Built-in Data Reader</code> and <code>Cosmos DB Built-in Data Contributor</code>. However, Azure portal support for role management isn&#8217;t available yet. Check <a href="https://docs.microsoft.com/azure/cosmos-db/how-to-setup-rbac">here</a> for more details about the permission model, role definitions, and role assignment.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sas-tokens"><a class="anchor" href="#sas-tokens"></a><a class="link" href="#sas-tokens">6.3.2. SAS tokens</a></h4>
<div class="paragraph">
<p>It&#8217;s also configurable for services support authenticating with Shared Access Signature (SAS). <code>spring.cloud.azure.&lt;azure-service&gt;.sas-token</code> is the property to configure. For example, using <code>spring.cloud.azure.storage.blob.sas-token</code> to authenticate to Storage Blob service.</p>
</div>
</div>
<div class="sect3">
<h4 id="connection-strings"><a class="anchor" href="#connection-strings"></a><a class="link" href="#connection-strings">6.3.3. Connection Strings</a></h4>
<div class="paragraph">
<p>Connection strings are supported by some Azure services to provide connection information as well as credentials. To connect to those Azure services using a connection string, just configure <code>spring.cloud.azure.&lt;azure-service&gt;.connection-string</code> will do. For example, <code>spring.cloud.azure.eventhubs.connection-string</code> to connect to Event Hubs service.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="production-ready"><a class="anchor" href="#production-ready"></a><a class="link" href="#production-ready">7. Production Ready</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure 4.0 supports health indicators for App Configuration, Event Hubs, Cosmos, Key Vault Certificate, Key Vault Secret, Storage Blob, Storage Queue, and Storage File Share. It also provides integrations with Spring Cloud Sleuth for all HTTP-based Azure SDKs. As an example, you now can prob if storage blob is up or down via Spring Boot actuator endpoint, as well as track dependencies and latencies going from your application to Key Vault.</p>
</div>
<div class="sect2">
<h3 id="enable-health-indicator"><a class="anchor" href="#enable-health-indicator"></a><a class="link" href="#enable-health-indicator">7.1. Enable Health Indicator</a></h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Actuator Starter dependency. This dependency will also include the <code>spring-boot-starter-actuator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Configurable properties to enable or disable health indicators for each Azure service</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Property</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-appconfiguration</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-cosmos</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-eventhubs</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-certificate</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-secret</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-blob</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-fileshare</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-queue</strong>.enabled</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Calling the health endpoint of Azure services may cause extra charge. For example, calling <code><a href="http://HOST_NAME:{port}/actuator/health/cosmos" class="bare">HOST_NAME:{port}/actuator/health/cosmos</a></code> to get the Cosmos DB health info, it will calculate <a href="https://docs.microsoft.com/azure/cosmos-db/request-units">RUs</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For calling the health endpoint of <code>Cosmos</code>, the option <code>spring.cloud.azure.cosmos.database</code> should be configured; Otherwise, the health status of <code>unknown</code> will be returned.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For calling the health endpoint of <code>Storage Queue</code>, role of <code>Storage Account Contributor</code> is required if <code>Azure AD</code> is used for authorizing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="enable-sleuth"><a class="anchor" href="#enable-sleuth"></a><a class="link" href="#enable-sleuth">7.2. Enable Sleuth</a></h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Trace Sleuth dependency when you want to trace Azure SDK activities with using Spring Cloud Sleuth.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-trace-sleuth&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only HTTP-based Azure SDK clients are supported now, for example, Eventhub and ServiceBus with AMQP transport are currently not supported, we recommend to use <a href="https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview">Azure Application Insights</a> for such requirement.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="autoconfigure-azure-sdk-clients"><a class="anchor" href="#autoconfigure-azure-sdk-clients"></a><a class="link" href="#autoconfigure-azure-sdk-clients">8. Autoconfigure Azure SDK Clients</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Boot simplifies the Spring Cloud Azure development experience. Spring Cloud Azure starters are a set of convenient dependency descriptors to include in your application. They handle the object instantiation and configuration logic, so you donâ€™t have to. Every starter depends on the <code>spring-cloud-azure-starter</code> to provide critical bits of configuration, like the Azure cloud environment and authentication information. You can configure these as properties in, for example, a yaml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        cloud-type: Azure <i class="conum" data-value="1"></i><b>(1)</b>
      credential:
        client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>cloud-type</code> is optional for it has default value set to <code>Azure</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These properties are optional and, if not specified, Spring Boot will try to automatically find them for you. For details on how Spring Boot finds these properties, refer to the documentation.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup"><a class="anchor" href="#dependency-setup"></a><a class="link" href="#dependency-setup">8.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>There are two ways to use Spring Cloud Azure starters. One is using Azure SDKs with this <code>spring-cloud-azure-starter</code> dependency. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or including the Spring Cloud Azure starter directly without adding Azure SDK dependencies. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#starter-dependencies">Starter Dependencies</a> for the list of starters Spring Cloud Azure supports.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-2"><a class="anchor" href="#configuration-2"></a><a class="link" href="#configuration-2">8.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuration properties for each Azure service are under prefix <code>spring.cloud.azure.&lt;azure-service&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage"><a class="anchor" href="#basic-usage"></a><a class="link" href="#basic-usage">8.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Adding below properties to your <code>application.yaml</code> will autoconfigure the Cosmos clients for you, both <code>CosmosClient</code> and <code>CosmosAsyncClient</code> are available in the context and could be autowired.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      cosmos:
        database: ${AZURE_COSMOS_DATABASE_NAME}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        consistency-level: eventual
        connection-mode: direct</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @Autowired
    private CosmosClient cosmosClient;

    @Override
    public void run() {
        User item = User.randomUser();
        CosmosContainer container = cosmosClient.getDatabase(databaseName).getContainer(containerName);
        container.createItem(item);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples"><a class="anchor" href="#samples"></a><a class="link" href="#samples">8.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-handling"><a class="anchor" href="#resource-handling"></a><a class="link" href="#resource-handling">9. Resource Handling</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring project provides <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#resources">Spring Resources</a> abstraction to access a number of low-level resources. It provides interfaces like <code>Resource</code>, <code>ResourceLoader</code> and <code>ResourcePatternResolver</code>. Spring Cloud Azure implements these interfaces for Azure Storage services which allows you to interact with Azure Storage Blob and File Share using Spring programming model. It provides <code>spring-cloud-azure-starter-storage-blob</code> and <code>spring-cloud-azure-starter-storage-file-share</code> to autoconfigure Azure Storage Blob and Azure Storage File Share.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Azure Storage related libraries.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 12.5%;">
<col style="width: 62.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Starter</th>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows unstructured data to be stored and accessed at a massive scale in block blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offers fully managed cloud file shares that you can access from anywhere via the industry standard Server Message Block (SMB) protocol.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="dependency-setup-2"><a class="anchor" href="#dependency-setup-2"></a><a class="link" href="#dependency-setup-2">9.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-blob&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-file-share&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only required when you&#8217;re using Azure Storage Blob.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only required when you&#8217;re using Azure Storage File Share.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We also provide <code>spring-cloud-azure-starter-storage</code> to support all the features of Storage. If you choose to use it, <code>spring.cloud.azure.storage.enable</code> is the property to configure, the default value is <code>true</code>. Then you can use <code>spring.cloud.azure.storage.&lt;storage-service&gt;.enable</code> to disable unneeded services.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-3"><a class="anchor" href="#configuration-3"></a><a class="link" href="#configuration-3">9.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Configurable properties of spring-cloud-azure-starter-storage-blob</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage Blob service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob account name.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Configurable properties of spring-cloud-azure-starter-storage-file-share</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage File Share service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share account name.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="basic-usage-2"><a class="anchor" href="#basic-usage-2"></a><a class="link" href="#basic-usage-2">9.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Provide the properties below in your configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint: ${STORAGE_BLOB_ENDPOINT}
        fileshare:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint:  ${STORAGE_FILESHARE_ENDPOINT}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="get-a-resource"><a class="anchor" href="#get-a-resource"></a><a class="link" href="#get-a-resource">9.3.1. Get a Resource</a></h4>
<div class="sect4">
<h5 id="get-a-resource-with-value"><a class="anchor" href="#get-a-resource-with-value"></a><a class="link" href="#get-a-resource-with-value">Get a Resource with @Value</a></h5>
<div class="paragraph">
<p>You can use the annotation of <code>@Value("azure-blob://[your-container-name]/[your-blob-name]")</code> to autowire a blob resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the annotation of @Value("azure-file://[your-fileshare-name]/[your-file-name]") to autowire a file resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-a-resource-with-resourceloader"><a class="anchor" href="#get-a-resource-with-resourceloader"></a><a class="link" href="#get-a-resource-with-resourceloader">Get a resource with ResourceLoader</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private ResourceLoader resourceLoader;
...
// get a BlobResource
Resource storageBlobResource = resourceLoader.getResource("azure-blob://[your-container-name]/[your-blob-name]");
// get a FileResource
Resource storageFileResource = resourceLoader.getResource("azure-file://[your-fileshare-name]/[your-file-name]");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-resources-by-searching-pattern"><a class="anchor" href="#get-resources-by-searching-pattern"></a><a class="link" href="#get-resources-by-searching-pattern">Get Resources by Searching Pattern</a></h5>
<div class="paragraph">
<p>You can use implementation class of <code>ResourcePatternResolver</code> to search resources. Use <code>AzureStorageBlobProtocolResolver</code> to search <code>blob</code> resources, and <code>AzureStorageFileProtocolResolver</code> to search <code>file</code> resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pattern search, the <strong>searchPattern</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>. Such as <code>azure-blob://**/**</code>, it means list all blobs in all containers; <code>azure-blob://demo-container/**</code>, it means list all blobs in the demo-container container, including any sub-folders.</p>
</li>
<li>
<p>Location search, the <strong>searchLocation</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>, the remaining file path should exist, otherwise an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private AzureStorageBlobProtocolResolver azureStorageBlobProtocolResolver;

@Autowired
private AzureStorageFileProtocolResolver azureStorageFileProtocolResolver;

// get all text blobs
Resource[] blobTextResources = azureStorageBlobProtocolResolver.getResources("azure-blob://[container-pattern]/*.txt");
// get all text files
Resource[] fileTextResources = azureStorageFileProtocolResolver.getResources("azure-file://[fileshare-pattern]/*.txt");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling-with-resource"><a class="anchor" href="#handling-with-resource"></a><a class="link" href="#handling-with-resource">9.3.2. Handling with Resource</a></h4>
<div class="sect4">
<h5 id="download-data-from-specific-resource"><a class="anchor" href="#download-data-from-specific-resource"></a><a class="link" href="#download-data-from-specific-resource">Download Data from Specific Resource</a></h5>
<div class="paragraph">
<p>You can download a resource from Azure Stroage Blob or File Share with the <code>getInputStream()</code> method of <code>Resource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

....

// download data as stream from blob resource
InputStream inputblobStream = storageBlobResource.getInputStream();
// download data as stream from file resource
InputStream inputfileStream = storageFileResource.getInputStream();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="upload-data-to-specific-resource"><a class="anchor" href="#upload-data-to-specific-resource"></a><a class="link" href="#upload-data-to-specific-resource">Upload Data to Specific Resource</a></h5>
<div class="paragraph">
<p>You can upload to a resource to Azure Storage Blob or File Share by casting the Spring <code>Resource</code> to <code>WritableResource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

String data = "sampledata";

// upload string data to blob
try (OutputStream blobos = ((WritableResource) this.storageBlobResource).getOutputStream()) {
  blobos.write(data.getBytes());
}
// upload string data to file
try (OutputStream fileos = ((WritableResource) this.storageFileResource).getOutputStream()) {
  fileos.write(data.getBytes());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multipart-upload"><a class="anchor" href="#multipart-upload"></a><a class="link" href="#multipart-upload">9.3.3. Multipart Upload</a></h4>
<div class="paragraph">
<p>Files larger than 4 MiB will be uploaded to Azure Storage in parallel.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-2"><a class="anchor" href="#samples-2"></a><a class="link" href="#samples-2">9.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/storage/spring-cloud-azure-starter-storage-blob/storage-blob-sample">storage-blob-sample</a> and <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/storage/spring-cloud-azure-starter-storage-file-share/storage-file-sample">storage-file-sample</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secret-management"><a class="anchor" href="#secret-management"></a><a class="link" href="#secret-management">10. Secret Management</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure construct <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-property-source-abstraction">PropertySource</a> which holds secrets stored in Azure Key Vault Secrets.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-3"><a class="anchor" href="#dependency-setup-3"></a><a class="link" href="#dependency-setup-3">10.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We also provide <code>spring-cloud-azure-starter-keyvault</code> to support all the features of Key Vault. If you choose to use it, <code>spring.cloud.azure.keyvault.enable</code> is the property to configure, the default value is <code>true</code>. Then you can use <code>spring.cloud.azure.keyvault.&lt;keyvault-service&gt;.enable</code> to disable unneeded services.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-3"><a class="anchor" href="#basic-usage-3"></a><a class="link" href="#basic-usage-3">10.2. Basic Usage</a></h3>
<div class="paragraph">
<p>If you want to authenticate by <code>client-id</code> and <code>client-secret</code>, the following properties are required:</p>
</div>
<div class="sect3">
<h4 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a><a class="link" href="#configuration-properties">10.2.1. Configuration Properties</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yml" class="language-yml hljs">spring:
  cloud:
    azure:
      keyvault:
        secret:
          property-sources:
            - name: key-vault-property-souece-1
              endpoint: ${ENDPOINT_1}
            - name: key-vault-property-souece-2
              endpoint: ${ENDPOINT_2}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-code"><a class="anchor" href="#java-code"></a><a class="link" href="#java-code">10.2.2. Java Code</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class SampleApplication implements CommandLineRunner {

    @Value("${sampleProperty1}")
    private String sampleProperty1;
    @Value("${sampleProperty2}")
    private String sampleProperty2;
    @Value("${samplePropertyInMultipleKeyVault}")
    private String samplePropertyInMultipleKeyVault;

    public static void main(String[] args) {
        SpringApplication.run(SampleApplication.class, args);
    }

    public void run(String[] args) {
        System.out.println("sampleProperty1: " + sampleProperty1);
        System.out.println("sampleProperty2: " + sampleProperty2);
        System.out.println("samplePropertyInMultipleKeyVault: " + samplePropertyInMultipleKeyVault);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a><a class="link" href="#advanced-usage">10.3. Advanced Usage</a></h3>
<div class="sect3">
<h4 id="special-characters-in-property-name"><a class="anchor" href="#special-characters-in-property-name"></a><a class="link" href="#special-characters-in-property-name">10.3.1. Special Characters in Property Name</a></h4>
<div class="paragraph">
<p>Key Vault secret name only support characters in <code>[0-9a-zA-Z-]</code>. Refs: <a href="https://docs.microsoft.com/azure/key-vault/general/about-keys-secrets-certificates#vault-name-and-object-name">Vault-name and Object-name</a>. If your property name contains other characters, you can use these workarounds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>-</code> instead of <code>.</code> in secret name. <code>.</code> isn&#8217;t supported in secret name. If your application have property name which contains <code>.</code>, like <code>spring.datasource.url</code>, just replace <code>.</code> to <code>-</code> when save secret in Azure Key Vault. For example: Save <code>spring-datasource-url</code> in Azure Key Vault. In your application, you can still use <code>spring.datasource.url</code> to retrieve property value.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This method can not satisfy requirement like <code>spring.datasource-url</code>. When you save <code>spring-datasource-url</code> in Key Vault, only <code>spring.datasource.url</code> and <code>spring-datasource-url</code> is supported to retrieve property value, <code>spring.datasource-url</code> isn&#8217;t supported. To handle this case, please refer to the following option: Use property placeholders.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Use property placeholders. For example: setting this property in your application.properties: <code>property.with.special.character_=${propertyWithoutSpecialCharacter}</code>. The application will get  <code>propertyWithoutSpecialCharacter</code> key name and assign its value to <code>property.with.special.character_</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="case-sensitive"><a class="anchor" href="#case-sensitive"></a><a class="link" href="#case-sensitive">10.3.2. Case Sensitive</a></h4>
<div class="paragraph">
<p>By default, the secret names are case-insensitive. To enable case-sensitive mode, just set the following property: <code>spring.cloud.azure.keyvault.secret.property-sources[].case-sensitive=true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-retrieve-all-secrets-in-key-vault"><a class="anchor" href="#not-retrieve-all-secrets-in-key-vault"></a><a class="link" href="#not-retrieve-all-secrets-in-key-vault">10.3.3. Not Retrieve All Secrets In Key Vault</a></h4>
<div class="paragraph">
<p>If you stored 1000 secrets in the Key Vault, and you just want to use 3 of them. You can list the 3 secret names by <code>spring.cloud.azure.keyvault.secret.property-sources[].secret-keys</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setting-refresh-interval"><a class="anchor" href="#setting-refresh-interval"></a><a class="link" href="#setting-refresh-interval">10.3.4. Setting Refresh Interval</a></h4>
<div class="paragraph">
<p>By default, the secrets in <code>KeyVaultPropertySource</code> will refresh every 30 minutes. You can configure the time by <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval</code>. For example: <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval=60m</code> means refresh every 60 minutes. Set to <code>0</code> to disable auto refresh.</p>
</div>
</div>
<div class="sect3">
<h4 id="propertysource-priority"><a class="anchor" href="#propertysource-priority"></a><a class="link" href="#propertysource-priority">10.3.5. PropertySource Priority</a></h4>
<div class="paragraph">
<p>If key exists in multiple PropertySources, which will take effect is decided by the priority.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is no <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>KeyVaultPropertySource</code> will take the highest priority.</p>
</li>
<li>
<p>If there is <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>SystemEnvironmentPropertySource</code> have higher priority than KeyVaultPropertySource. Which means you can use environment variable to override the Key Vault secret value in your application.</p>
</li>
<li>
<p>If there are multiple KeyVaultPropertySource in PropertySource list, then the definition order is the priority order. Take above sample as example, <code>key-vault-property-souece-1</code> has higher priority than <code>key-vault-property-souece-2</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="all-configurable-properties"><a class="anchor" href="#all-configurable-properties"></a><a class="link" href="#all-configurable-properties">10.3.6. All Configurable Properties</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Configurable properties of Key Vault Secret PropertySource</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-source-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Key Vault property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of this property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].case-sensitive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the secret keys are case-sensitive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].secret-keys</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret keys supported for this property source. All keys be retrieved if this property is missing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].refresh-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time interval to refresh all Key Vault secrets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].service-version</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secret service version used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].client</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].proxy</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proxy related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].retry</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retry related properties.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>See <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the <a href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object">security principal</a> has been granted the sufficient permission to access the Azure Key Vault Secrets.</p>
</li>
<li>
<p>If common properties like <code>client</code>, <code>credential</code>, <code>profile</code>, <code>proxy</code>, <code>retry</code> aren&#8217;t configured in <code>spring.cloud.azure.keyvault.secret.property-sources[].xxx</code>, <code>spring.cloud.azure.xxx</code> will be used. See <a href="index.html#configuration">Configuration</a> to get more information about these common properties.</p>
</li>
<li>
<p>See <a href="appendix.html#_configuration_properties">Configuration Properties</a> to get more information about nested properties.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-3"><a class="anchor" href="#samples-3"></a><a class="link" href="#samples-3">10.4. Samples</a></h3>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/keyvault/spring-cloud-azure-starter-keyvault-secrets/property-source">property-source</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-support"><a class="anchor" href="#spring-data-support"></a><a class="link" href="#spring-data-support">11. Spring Data Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-data-cosmosdb-support"><a class="anchor" href="#spring-data-cosmosdb-support"></a><a class="link" href="#spring-data-cosmosdb-support">11.1. Spring Data CosmosDB Support</a></h3>
<div class="paragraph">
<p><a href="https://azure.microsoft.com/services/cosmos-db/">Azure Cosmos DB</a> is a globally-distributed database service that allows developers to work with data using a variety of standard APIs, such as SQL, MongoDB, Graph, and Azure Table storage.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependency-setup-4"><a class="anchor" href="#dependency-setup-4"></a><a class="link" href="#dependency-setup-4">11.2. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
   &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
   &lt;artifactId&gt;spring-cloud-azure-starter-data-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-4"><a class="anchor" href="#configuration-4"></a><a class="link" href="#configuration-4">11.3. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Configurable properties of spring-cloud-azure-starter-data-cosmos</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether Azure Cosmos Service is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.database</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cosmos DB database id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uri to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.username</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.populate-query-metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Populate Diagnostics Strings and Query metrics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.consistency-level</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/cosmos-db/consistency-levels">Consistency levels</a> in Azure Cosmos DB.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="key-concepts"><a class="anchor" href="#key-concepts"></a><a class="link" href="#key-concepts">11.4. Key Concepts</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring Data CrudRepository and ReactiveCrudRepository basic CRUD functionality</p>
<div class="ulist">
<ul>
<li>
<p>save</p>
</li>
<li>
<p>findAll</p>
</li>
<li>
<p>findOne by Id</p>
</li>
<li>
<p>deleteAll</p>
</li>
<li>
<p>delete by Id</p>
</li>
<li>
<p>delete entity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Data <a href="https://github.com/spring-projects/spring-data-commons/blob/db62390de90c93a78743c97cc2cc9ccd964994a5/src/main/java/org/springframework/data/annotation/Id.java">@Id</a> annotation.
There&#8217;re 2 ways to map a field in domain class to <code>id</code> of Azure Cosmos DB document.</p>
<div class="ulist">
<ul>
<li>
<p>annotate a field in domain class with @Id, this field will be mapped to document <code>id</code> in Cosmos DB.</p>
</li>
<li>
<p>set name of this field to <code>id</code>, this field will be mapped to document <code>id</code> in Cosmos DB.
[Note] if both way applied,</p>
</li>
</ul>
</div>
</li>
<li>
<p>Custom collection Name.
By default, collection name will be class name of user domain class. To customize it, add annotation <code>@Document(collection="myCustomCollectionName")</code> to your domain class, that&#8217;s all.</p>
</li>
<li>
<p>Supports <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview">Azure Cosmos DB partition</a>. To specify a field of your domain class to be partition key field, just annotate it with <code>@PartitionKey</code>. When you do CRUD operation, please specify your partition value. For more sample on partition CRUD, please refer to <a href="https://github.com/Azure/azure-sdk-for-java/blob/main/sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/AddressRepositoryIT.java">test here</a></p>
</li>
<li>
<p>Supports <a href="https://docs.spring.io/spring-data/commons/docs/current/reference/html/#repositories.query-methods.details">Spring Data custom query</a> find operation.</p>
</li>
<li>
<p>Supports <a href="https://spring.io/projects/spring-data-rest">spring-boot-starter-data-rest</a>.</p>
</li>
<li>
<p>Supports List and nested type in domain class.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-4"><a class="anchor" href="#basic-usage-4"></a><a class="link" href="#basic-usage-4">11.5. Basic Usage</a></h3>
<div class="sect3">
<h4 id="use-private-key-to-access-cosmosdb"><a class="anchor" href="#use-private-key-to-access-cosmosdb"></a><a class="link" href="#use-private-key-to-access-cosmosdb">11.5.1. Use Private Key to Access CosmosDB</a></h4>
<div class="paragraph">
<p>The simplest way to connect CosmosDB with <code>spring-cloud-azure-starter-data-cosmos</code> is primary key, add below properties, and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      cosmos:
        key: ${AZURE_COSMOS_KEY}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        database: ${AZURE_COSMOS_DATABASE}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="define-an-entity"><a class="anchor" href="#define-an-entity"></a><a class="link" href="#define-an-entity">11.5.2. Define an Entity</a></h4>
<div class="paragraph">
<p>Define a simple entity as Document in Cosmos DB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Container(containerName = "mycollection")
public class User {
    @Id
    private String id;
    private String firstName;
    @PartitionKey
    private String lastName;
    private String address;

    public User() {
    }

    public User(String id, String firstName, String lastName, String address) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.address = address;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    @Override
    public String toString() {
        return String.format("%s %s, %s", firstName, lastName, address);
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p><code>id</code> field will be used as document <code>id</code> in Azure Cosmos DB. Or you can annotate any field with <code>@Id</code> to map it to document <code>id</code>.</p>
</div>
<div class="paragraph">
<p>Annotation <code>@Container(containerName = "mycollection")</code> is used to specify the collection name of your document in Azure Cosmos DB.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-repositories"><a class="anchor" href="#create-repositories"></a><a class="link" href="#create-repositories">11.5.3. Create Repositories</a></h4>
<div class="paragraph">
<p>Extends ReactiveCosmosRepository interface, which provides Spring Data repository support.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Repository
public interface UserRepository extends ReactiveCosmosRepository&lt;User, String&gt; {

    Flux&lt;User&gt; findByFirstName(String firstName);
}</pre>
</div>
</div>
<div class="paragraph">
<p>So far ReactiveCosmosRepository provides basic save, delete and find operations. More operations will be supported later.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-an-application-class"><a class="anchor" href="#create-an-application-class"></a><a class="link" href="#create-an-application-class">11.5.4. Create an Application Class</a></h4>
<div class="paragraph">
<p>Here create an application class with all the components</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@SpringBootApplication
public class CosmosSampleApplication implements CommandLineRunner {

   private static final Logger LOGGER = LoggerFactory.getLogger(CosmosSampleApplication.class);

    @Autowired
    private UserRepository repository;

    @Autowired
    private CosmosProperties properties;

    public static void main(String[] args) {
        SpringApplication.run(CosmosSampleApplication.class, args);
    }

    public void run(String... var1) {
        final User testUser = new User("testId", "testFirstName",
                "testLastName", "test address line one");

        // Save the User class to Azure Cosmos DB database.
        final Mono&lt;User&gt; saveUserMono = repository.save(testUser);

        final Flux&lt;User&gt; firstNameUserFlux = repository.findByFirstName("testFirstName");

        //  Nothing happens until we subscribe to these Monos.
        //  findById will not return the user as user is not present.
        final Mono&lt;User&gt; findByIdMono = repository.findById(testUser.getId());
        final User findByIdUser = findByIdMono.block();
        Assert.isNull(findByIdUser, "User must be null");

        final User savedUser = saveUserMono.block();
        Assert.state(savedUser != null, "Saved user must not be null");
        Assert.state(savedUser.getFirstName().equals(testUser.getFirstName()),
                "Saved user first name doesn't match");

        firstNameUserFlux.collectList().block();

        final Optional&lt;User&gt; optionalUserResult = repository.findById(testUser.getId()).blockOptional();
        Assert.isTrue(optionalUserResult.isPresent(), "Cannot find user.");

        final User result = optionalUserResult.get();
        Assert.state(result.getFirstName().equals(testUser.getFirstName()),
                "query result firstName doesn't match!");
        Assert.state(result.getLastName().equals(testUser.getLastName()),
                "query result lastName doesn't match!");
        LOGGER.info("findOne in User collection get result: {}", result.toString());

    }

    @PostConstruct
    public void setup() {
        // For this example, remove all of the existing records.
        this.repository.deleteAll().block();
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Autowired UserRepository interface, then can do save, delete and find operations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-4"><a class="anchor" href="#samples-4"></a><a class="link" href="#samples-4">11.6. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/cosmos">azure-spring-boot-samples</a> for more details.</p>
</div>
<div class="paragraph">
<p>Apart from using the <code>spring-cloud-azure-starter-data-cosmos</code> library, you can directly use <code>azure-spring-data-cosmos</code> library for more complex scenarios. Please refer to <a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_4.5.0-beta.1/sdk/cosmos/azure-spring-data-cosmos">Spring Data for Azure Cosmos DB</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-security-support"><a class="anchor" href="#spring-security-support"></a><a class="link" href="#spring-security-support">12. Spring Security Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory"><a class="anchor" href="#spring-security-with-azure-active-directory"></a><a class="link" href="#spring-security-with-azure-active-directory">12.1. Spring Security With Azure Active Directory</a></h3>
<div class="paragraph">
<p>When you are building a web application, identity and access management will always be foundational pieces.</p>
</div>
<div class="paragraph">
<p>Azure offers a great platform to democratize your application development journey, as it not only offers a cloud-base identity service, but also deep integration with the rest of the Azure ecosystem.</p>
</div>
<div class="paragraph">
<p>Spring Security has made it easy to secure your Spring based applications with powerful abstractions and extensible interfaces. However, as powerful as the Spring framework can be, it is not tailored to a specific identity provider.</p>
</div>
<div class="paragraph">
<p>The <code>spring-cloud-azure-starter-active-directory</code> provides the most optimal way to connect your web application to an Azure Active Directory (Azure AD for short) tenant and protect your resource server with Azure AD. It uses the Oauth 2.0 protocol to protect web applications and resource servers.</p>
</div>
<div class="sect3">
<h4 id="accessing-a-web-application"><a class="anchor" href="#accessing-a-web-application"></a><a class="link" href="#accessing-a-web-application">12.1.1. Accessing a Web Application</a></h4>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with a Microsoft account.</p>
</div>
<div class="sect4">
<h5 id="system-diagram"><a class="anchor" href="#system-diagram"></a><a class="link" href="#system-diagram">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617664-f1704adb-db64-49e0-b1b6-078c62b6945b.png" alt="Standalone Web Application"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure"><a class="anchor" href="#create-required-resources-in-azure"></a><a class="link" href="#create-required-resources-in-azure">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies"><a class="anchor" href="#add-required-dependencies"></a><a class="link" href="#add-required-dependencies">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties"><a class="anchor" href="#add-required-properties"></a><a class="link" href="#add-required-properties">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages"><a class="anchor" href="#advanced-usages"></a><a class="link" href="#advanced-usages">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="add-extra-security-configurations"><a class="anchor" href="#add-extra-security-configurations"></a><a class="link" href="#add-extra-security-configurations">Add Extra Security Configurations</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    @EnableWebSecurity
    @EnableGlobalMethodSecurity(prePostEnabled = true)
    public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {

        /**
         * Add configuration logic as needed.
         */
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            http.authorizeRequests()
                    .anyRequest().authenticated();
            // Do some custom configuration
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-app-roles"><a class="anchor" href="#authorize-access-by-app-roles"></a><a class="link" href="#authorize-access-by-app-roles">Authorize Access by App Roles</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: Admin</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: Admin</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to use app role based access control, you can&#8217;t put group names in <code>role</code> claim . Refs: <a href="https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims#configuring-groups-optional-claims">Configuring groups optional claims</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("Admin")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_Admin')")
    public String admin() {
        return "Admin message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-group-name-or-group-id"><a class="anchor" href="#authorize-access-by-group-name-or-group-id"></a><a class="link" href="#authorize-access-by-group-name-or-group-id">Authorize Access by Group Name Or Group ID</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add related configuration properties.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        user-group:
          allowed-group-names: group1_name_1, group2_name_2
          # 1. If allowed-group-ids == all, then all group id will take effect.
          # 2. If "all" is used, we should not configure other group ids.
          # 3. "all" is only supported for allowed-group-ids, not supported for allowed-group-names.
          allowed-group-ids: group_id_1, group_id_2</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Controller
public class RoleController {
    @GetMapping("group1")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group1')")
    public String group1() {
        return "group1 message";
    }

    @GetMapping("group2")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group2')")
    public String group2() {
        return "group2 message";
    }

    @GetMapping("group1Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group1-id&gt;')")
    public String group1Id() {
        return "group1Id message";
    }

    @GetMapping("group2Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group2-id&gt;')")
    public String group2Id() {
        return "group2Id message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-national-azure-instead-of-global-azure"><a class="anchor" href="#use-national-azure-instead-of-global-azure"></a><a class="link" href="#use-national-azure-instead-of-global-azure">Use National Azure Instead of Global Azure</a></h6>
<div class="paragraph">
<p>Now except global Azure cloud, Azure Active Directory is deployed in the following national clouds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Government</p>
</li>
<li>
<p>Azure China 21Vianet</p>
</li>
<li>
<p>Azure Germany</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a sample of you want to use Azure China 21Vianet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        base-uri: https://login.partner.microsoftonline.cn
        graph-base-uri: https://microsoftgraph.chinacloudapi.cn</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can refer to these MS doc to get more information from <a href="https://docs.microsoft.com/en-us/graph/deployments">MS docs about National cloud deployments</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="configure-redirect-uri-template"><a class="anchor" href="#configure-redirect-uri-template"></a><a class="link" href="#configure-redirect-uri-template">Configure Redirect URI Template</a></h6>
<div class="paragraph">
<p>Developers can customize the redirect-uri.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149295662-072ca3d5-f9e1-4f25-bb0e-be7bb751e9af.png" alt="redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add <code>redirect-uri-template</code> properties in application.yml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        redirect-uri-template: ${REDIRECT-URI-TEMPLATE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Update redirect-uri in Azure portal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149296913-a4259df9-e0c3-4e38-8d4e-77ee845de4ad.png" alt="web-application-config-redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Update WebSecurityConfigurerAdapter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After we set redirect-uri-template, we need to update <code>WebSecurityConfigurerAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.oauth2Login()
                .loginProcessingUrl("${REDIRECT-URI-TEMPLATE}")
                .and()
            .authorizeRequests()
                .anyRequest().authenticated();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-5"><a class="anchor" href="#samples-5"></a><a class="link" href="#samples-5">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-accessing-resource-servers"><a class="anchor" href="#web-application-accessing-resource-servers"></a><a class="link" href="#web-application-accessing-resource-servers">12.1.2. Web Application Accessing Resource Servers</a></h4>
<div class="sect4">
<h5 id="system-diagram-2"><a class="anchor" href="#system-diagram-2"></a><a class="link" href="#system-diagram-2">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617853-0526205f-fdef-47f9-ac01-77963f8c34be.png" alt="web-application-visiting-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-2"><a class="anchor" href="#create-required-resources-in-azure-2"></a><a class="link" href="#create-required-resources-in-azure-2">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-2"><a class="anchor" href="#add-required-dependencies-2"></a><a class="link" href="#add-required-dependencies-2">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-2"><a class="anchor" href="#add-required-properties-2"></a><a class="link" href="#add-required-properties-2">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>graph</code> is the name of <code>OAuth2AuthorizedClient</code>, <code>scopes</code> means the scopes need to consent when login.</p>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application"></a><a class="link" href="#use-oauth2authorizedclient-in-your-application">Use OAuth2AuthorizedClient in Your Application</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Demo {
    @GetMapping("/graph")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graphClient) {
        // toJsonString() is just a demo.
        // oAuth2AuthorizedClient contains access_token. We can use this access_token to access resource server.
        return toJsonString(graphClient);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-2"><a class="anchor" href="#advanced-usages-2"></a><a class="link" href="#advanced-usages-2">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="client-credential-flow"><a class="anchor" href="#client-credential-flow"></a><a class="link" href="#client-credential-flow">Client Credential Flow</a></h6>
<div class="paragraph">
<p>The default flow is <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">authorization code flow</a>, if you want to use <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">client credentials flow</a>, you can configure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            authorization-grant-type: client_credentials # Change type to client_credentials
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="access-multiple-resource-servers"><a class="anchor" href="#access-multiple-resource-servers"></a><a class="link" href="#access-multiple-resource-servers">Access Multiple Resource Servers</a></h6>
<div class="paragraph">
<p>In one web application, you can access multiple resource server by configuring like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use OAuth2AuthorizedClient in application like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Demo {
    @GetMapping("/resource-server-1")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-1") OAuth2AuthorizedClient client) {
        return callResourceServer1(client);
    }

    @GetMapping("/resource-server-2")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-2") OAuth2AuthorizedClient client) {
        return callResourceServer2(client);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="incremental-consent"><a class="anchor" href="#incremental-consent"></a><a class="link" href="#incremental-consent">Incremental Consent</a></h6>
<div class="paragraph">
<p>In previous sample, all scopes will be consented when customer first login, no matter it&#8217;s belong to resource-server-1 or resource-server-2. If you don&#8217;t want to let customer consent all scopes, you can do like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            on-demand: true  # means incremental consent
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-6"><a class="anchor" href="#samples-6"></a><a class="link" href="#samples-6">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="accessing-a-resource-server"><a class="anchor" href="#accessing-a-resource-server"></a><a class="link" href="#accessing-a-resource-server">12.1.3. Accessing a Resource Server</a></h4>
<div class="paragraph">
<p>This scenario doesn&#8217;t support login, just protect the server by validating the access token. If the access token is valid, the server serves the request.</p>
</div>
<div class="sect4">
<h5 id="system-diagram-3"><a class="anchor" href="#system-diagram-3"></a><a class="link" href="#system-diagram-3">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617910-1ee3eb6a-ddc7-4b85-af4e-71344c91b248.png" alt="Standalone resource server usage"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-3"><a class="anchor" href="#create-required-resources-in-azure-3"></a><a class="link" href="#create-required-resources-in-azure-3">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_CLIENT_ID</code>.</p>
</li>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope-1</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-3"><a class="anchor" href="#add-required-dependencies-3"></a><a class="link" href="#add-required-dependencies-3">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-3"><a class="anchor" href="#add-required-properties-3"></a><a class="link" href="#add-required-properties-3">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        credential:
          client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start your application and access your application&#8217;s web api.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You will get 401 without an access token.</p>
</li>
<li>
<p>Access your application with an access token, the following claims in access token will be validated:</p>
<div class="ulist">
<ul>
<li>
<p><code>iss</code>: The access token must be issued by Azure AD.</p>
</li>
<li>
<p><code>nbf</code>: Current time can not before <code>nbf</code>.</p>
</li>
<li>
<p><code>exp</code>: Current time can not after <code>exp</code>.</p>
</li>
<li>
<p><code>aud</code>: If <code>spring.cloud.azure.active-directory.credential.client-id</code> or <code>spring.cloud.azure.active-directory.credential.app-id-uri</code> configured, the audience must equal to the configured <code>client-id</code> or <code>app-id-uri</code>. If the 2 properties are not configured, this claim will not be validated.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens">MS docs about Microsoft identity platform access tokens</a> to get more information about access token.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-3"><a class="anchor" href="#advanced-usages-3"></a><a class="link" href="#advanced-usages-3">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="add-extra-security-configurations-2"><a class="anchor" href="#add-extra-security-configurations-2"></a><a class="link" href="#add-extra-security-configurations-2">Add Extra Security Configurations</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2ResourceServerSecurityConfig extends AadResourceServerWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-scopes"><a class="anchor" href="#validate-permission-by-scopes"></a><a class="link" href="#validate-permission-by-scopes">Validate Permission by Scopes</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: : Create Required Resources in Azure</p>
<div class="ulist">
<ul>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("scope1")
    @ResponseBody
    @PreAuthorize("hasAuthority('SCOPE_Scope1')")
    public String scope1() {
        return "Congratulations, you can access `scope1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/scope1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scp</code>: The value must contains <code>Scope1</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-app-roles"><a class="anchor" href="#validate-permission-by-app-roles"></a><a class="link" href="#validate-permission-by-app-roles">Validate Permission by App Roles</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: AppRole1</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: AppRole1</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("app-role1")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_AppRole1')")
    public String appRole1() {
        return "Congratulations, you can access `app-role1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/app-role1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>roles</code>: The value must contains <code>AppRole1</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="use-jwt-client-authentication"><a class="anchor" href="#use-jwt-client-authentication"></a><a class="link" href="#use-jwt-client-authentication">Use JWT Client Authentication</a></h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/active-directory-certificate-credentials#register-your-certificate-with-microsoft-identity-platform">MS docs about Register your certificate with Microsoft identity platform</a>.</p>
</li>
<li>
<p>Upload a <strong>.pem</strong> certificate to application registered in Azure Portal.</p>
</li>
<li>
<p>Configure certificate path and password of a <strong>.PFX* or </strong>.P12* certificate.</p>
</li>
<li>
<p>Add property <code>spring.cloud.azure.active-directory.authorization-clients.azure.client-authentication-method=private_key_jwt</code> configuration to client that wants to be authenticated through JWT Client Authentication.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is an example configuration file for a Web Application scenario, certificate information is configured in global properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-certificate-path: ${AZURE_CERTIFICATE_PATH}
        client-certificate-password: ${AZURE_CERTIFICATE_PASSWORD}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      active-directory:
        enabled: true
        user-group:
          allowed-group-names: group1,group2
          allowed-group-ids: &lt;group1-id&gt;,&lt;group2-id&gt;
        post-logout-redirect-uri: http://localhost:8080
        authorization-clients:
          azure:
            client-authentication-method: private_key_jwt
          arm:
            client-authentication-method: private_key_jwt
            on-demand: true
            scopes: https://management.core.windows.net/user_impersonation
          graph:
            client-authentication-method: private_key_jwt
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All
          webapiA:
            client-authentication-method: private_key_jwt
            scopes:
              - ${WEB_API_A_APP_ID_URL}/Obo.WebApiA.ExampleScope
          webapiB:
            client-authentication-method: private_key_jwt
            scopes:
              - ${WEB_API_B_APP_ID_URL}/.default
            authorization-grant-type: client_credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>The certificate information can also be configured in <code>active-directory</code> service properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        enabled: true
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-certificate-path: ${AZURE_CERTIFICATE_PATH}
          client-certificate-password: ${AZURE_CERTIFICATE_PASSWORD}
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        user-group:
          allowed-group-names: group1,group2
          allowed-group-ids: &lt;group1-id&gt;,&lt;group2-id&gt;
        post-logout-redirect-uri: http://localhost:8080
        authorization-clients:
          azure:
            client-authentication-method: private_key_jwt
          arm:
            client-authentication-method: private_key_jwt
            on-demand: true
            scopes: https://management.core.windows.net/user_impersonation
          graph:
            client-authentication-method: private_key_jwt
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All
          webapiA:
            client-authentication-method: private_key_jwt
            scopes:
              - ${WEB_API_A_APP_ID_URL}/Obo.WebApiA.ExampleScope
          webapiB:
            client-authentication-method: private_key_jwt
            scopes:
              - ${WEB_API_B_APP_ID_URL}/.default
            authorization-grant-type: client_credentials</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-7"><a class="anchor" href="#samples-7"></a><a class="link" href="#samples-7">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server">aad-resource-server</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resource-server-visiting-other-resource-servers"><a class="anchor" href="#resource-server-visiting-other-resource-servers"></a><a class="link" href="#resource-server-visiting-other-resource-servers">12.1.4. Resource Server Visiting Other Resource Servers</a></h4>
<div class="sect4">
<h5 id="system-diagram-4"><a class="anchor" href="#system-diagram-4"></a><a class="link" href="#system-diagram-4">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142618294-aa546ced-d241-4fbd-97ac-fb06881503b1.png" alt="resource-server-visiting-other-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-4"><a class="anchor" href="#create-required-resources-in-azure-4"></a><a class="link" href="#create-required-resources-in-azure-4">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-4"><a class="anchor" href="#add-required-dependencies-4"></a><a class="link" href="#add-required-dependencies-4">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-4"><a class="anchor" href="#add-required-properties-4"></a><a class="link" href="#add-required-properties-4">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes:
              - https://graph.microsoft.com/User.Read</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application-2"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application-2"></a><a class="link" href="#use-oauth2authorizedclient-in-your-application-2">Use OAuth2AuthorizedClient in Your Application</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    @GetMapping("call-graph")
    public String callGraph(@RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graph) {
        return callMicrosoftGraphMeEndpoint(graph);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-8"><a class="anchor" href="#samples-8"></a><a class="link" href="#samples-8">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server-obo">aad-resource-server-obo</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-and-resource-server-in-one-application"><a class="anchor" href="#web-application-and-resource-server-in-one-application"></a><a class="link" href="#web-application-and-resource-server-in-one-application">12.1.5. Web Application and Resource Server in One Application</a></h4>
<div class="sect4">
<h5 id="create-required-resources-in-azure-5"><a class="anchor" href="#create-required-resources-in-azure-5"></a><a class="link" href="#create-required-resources-in-azure-5">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-5"><a class="anchor" href="#add-required-dependencies-5"></a><a class="link" href="#add-required-dependencies-5">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-5"><a class="anchor" href="#add-required-properties-5"></a><a class="link" href="#add-required-properties-5">Add Required Properties</a></h5>
<div class="paragraph">
<p>Set property <code>spring.cloud.azure.active-directory.application-type</code> to <code>web_application_and_resource_server</code>, and specify the authorization type for each authorization client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        app-id-uri: ${WEB_API_ID_URI}
        application-type: web_application_and_resource_server  # This is required.
        authorization-clients:
          graph:
            authorizationGrantType: authorization_code # This is required.
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="define-securityconfigurationadapter"><a class="anchor" href="#define-securityconfigurationadapter"></a><a class="link" href="#define-securityconfigurationadapter">Define SecurityConfigurationAdapter</a></h5>
<div class="paragraph">
<p>Configure multiple HttpSecurity instances, <code>AadWebApplicationAndResourceServerConfig</code> contain two security configurations for resource server and web application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadWebApplicationAndResourceServerConfig {

    @Order(1)
    @Configuration
    public static class ApiWebSecurityConfigurationAdapter extends AadResourceServerWebSecurityConfigurerAdapter {
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // All the paths that match `/api/**`(configurable) work as `Resource Server`, other paths work as `Web application`.
            http.antMatcher("/api/**")
                .authorizeRequests().anyRequest().authenticated();
        }
    }

    @Configuration
    public static class HtmlWebSecurityConfigurerAdapter extends AadWebSecurityConfigurerAdapter {

        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // @formatter:off
            http.authorizeRequests()
                    .antMatchers("/login").permitAll()
                    .anyRequest().authenticated();
            // @formatter:on
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-5"><a class="anchor" href="#configuration-5"></a><a class="link" href="#configuration-5">12.1.6. Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Configurable properties of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of an id_token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.application-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the AAD application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add additional parameters to the Authorization URL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The OAuth2 authorization clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lifespan of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-refresh-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The refresh time of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.post-logout-redirect-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The redirect uri after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.cloud-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to. Supported types are: AZURE, AZURE_CHINA, AZURE_GERMANY, AZURE_US_GOVERNMENT, OTHER.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.environment</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties to Azure Active Directory endpoints.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.tenant-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Tenant ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.redirect-uri-template</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirection Endpoint: Used by the authorization server to return responses containing authorization credentials to the client via the resource owner user-agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.claim-to-authority-prefix-map</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim will be used to build GrantedAuthority, and prefix of the GrantedAuthority&#8217;s string value. Default value is: "scp" &#8594; "SCOPE_", "roles" &#8594; "APPROLE_".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.principal-claim-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim in access token be returned in AuthenticatedPrincipal#getName. Default value is "sub".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.session-stateless</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true activates the stateless auth filter AadAppRoleStatelessAuthenticationFilter. The default is false which activates AadAuthenticationFilter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-ids</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group ids can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-names</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group names can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.use-transitive-members</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If "true", use "v1.0/me/transitiveMemberOf" to get members. Otherwise, use "v1.0/me/memberOf".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-name-attribute</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decide which claim to be principal&#8217;s name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some examples about how to use these properties:</p>
</div>
<div class="sect4">
<h5 id="application-type"><a class="anchor" href="#application-type"></a><a class="link" href="#application-type">Application Type</a></h5>
<div class="paragraph">
<p>THe application type can be inferred from the dependencies: spring-security-oauth2-client or spring-security-oauth2-resource-server. If the inferred value is not the value you want, you can specify the application type. Here is the table about valid values and inferred value:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Application type of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-client</th>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-resource-server</th>
<th class="tableblock halign-left valign-top">Valid values of application type</th>
<th class="tableblock halign-left valign-top">Inferred value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code>, <code>resource_server</code>, <code>resource_server_with_obo</code>, <code>web_application_and_resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server_with_obo</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory-b2c"><a class="anchor" href="#spring-security-with-azure-active-directory-b2c"></a><a class="link" href="#spring-security-with-azure-active-directory-b2c">12.2. Spring Security With Azure Active Directory B2C</a></h3>
<div class="paragraph">
<p>Azure Active Directory (Azure AD) B2C is an identity management service that enables you to customize and control how customers sign up, sign in, and manage their profiles when using your applications. Azure AD B2C enables these actions while protecting the identities of your customers at the same time.</p>
</div>
<div class="sect3">
<h4 id="dependency-setup-5"><a class="anchor" href="#dependency-setup-5"></a><a class="link" href="#dependency-setup-5">12.2.1. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-6"><a class="anchor" href="#configuration-6"></a><a class="link" href="#configuration-6">12.2.2. Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Configurable properties of spring-cloud-azure-starter-active-directory-b2c</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of a token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional parameters for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify client configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.base-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C endpoint base uri.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C credential information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.login-flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sign-up-or-sign-in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the primary sign-in flow key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.logout-success-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:8080/login" class="bare">localhost:8080/login</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect url after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C profile information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.reply-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply url after get authorization code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-flows</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User flows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-name-attribute-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User name attribute name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For full configurations, check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-5"><a class="anchor" href="#basic-usage-5"></a><a class="link" href="#basic-usage-5">12.2.3. Basic Usage</a></h4>
<div class="paragraph">
<p>A <code>web application</code> is any web based application that allows user to login with Azure AD, whereas a <code>resource server</code> will either accept or deny access after validating access_token obtained from Azure AD. We will cover 4 scenarios in this guide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Accessing a web application.</p>
</li>
<li>
<p>Web application accessing resource servers.</p>
</li>
<li>
<p>Accessing a resource server.</p>
</li>
<li>
<p>Resource server accessing other resource servers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620440-f970b572-2646-4f50-9f77-db62d6e965f1.png" alt="B2C Web application &amp; Web Api Overall"></span></p>
</div>
<div class="sect4">
<h5 id="usage-1-accessing-a-web-application"><a class="anchor" href="#usage-1-accessing-a-web-application"></a><a class="link" href="#usage-1-accessing-a-web-application">Usage 1: Accessing a Web Application</a></h5>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with your Azure AD B2C user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webapp</code>, add <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code> for the <strong>Reply URL</strong>, record the
<strong>Application ID</strong> as your <code>WEB_APP_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_APP_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>User flows</strong> on your left, and then Click <strong>New user flow</strong>.</p>
</li>
<li>
<p>Step 5: Choose <strong>Sign up or in</strong>, <strong>Profile editing</strong> and <strong>Password reset</strong> to create user flows
respectively. Specify your user flow <strong>Name</strong> and <strong>User attributes and claims</strong>, click <strong>Create</strong>.</p>
</li>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>Microsoft APIs</strong>, select <strong><em>Microsoft Graph</em></strong>,
select <strong>Delegated permissions</strong>, check <strong>offline_access</strong> and <strong>openid</strong> permissions, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>Graph</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620491-8c8a82ea-c920-43a8-aa0a-dd028f1b8553.png" alt="Add Graph permissions"></span></p>
</li>
<li>
<p>Step 8: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
        &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add properties in <em>application.yml</em> using the values you created earlier, for example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      active-directory:
        b2c:
          authenticate-additional-parameters:
            domain_hint: xxxxxxxxx         # optional
            login_hint: xxxxxxxxx          # optional
            prompt: [login,none,consent]   # optional
          base-uri: ${BASE_URI}
          credential:
            client-id: ${WEBAPP_AZURE_CLIENT_ID}
            client-secret: ${WEBAPP_AZURE_CLIENT_SECRET}
          login-flow: ${LOGIN_USER_FLOW_KEY}               # default to sign-up-or-sign-in, will look up the user-flows map with provided key.
          logout-success-url: ${LOGOUT_SUCCESS_URL}
          user-flows:
            ${YOUR_USER_FLOW_KEY}: ${USER_FLOW_NAME}
          user-name-attribute-name: ${USER_NAME_ATTRIBUTE_NAME}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Controller
public class WebController {

    private void initializeModel(Model model, OAuth2AuthenticationToken token) {
        if (token != null) {
            final OAuth2User user = token.getPrincipal();
            model.addAllAttributes(user.getAttributes());
            model.addAttribute("grant_type", user.getAuthorities());
            model.addAttribute("name", user.getName());
        }
    }

    @GetMapping(value = { "/", "/home" })
    public String index(Model model, OAuth2AuthenticationToken token) {
        initializeModel(model, token);
        return "home";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableWebSecurity
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

    private final AadB2cOidcLoginConfigurer configurer;

    public WebSecurityConfiguration(AadB2cOidcLoginConfigurer configurer) {
        this.configurer == configurer;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
            .apply(configurer);
        // @formatter:off
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <em>home.html</em> from <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/blob/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory-b2c/aad-b2c-web-application/src/main/resources/templates/home.html">aad-b2c-web-application sample</a>, and replace the <code>PROFILE_EDIT_USER_FLOW</code> and <code>PASSWORD_RESET_USER_FLOW</code> with your user flow name respectively that completed earlier.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> run on port <em>8080</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>After your application is built and started by Maven, open <code><a href="http://localhost:8080/" class="bare">localhost:8080/</a></code> in a web browser; you should be redirected to login page.</p>
</li>
<li>
<p>Click link with the login user flow, you should be redirected Azure AD B2C to start the authentication process.</p>
</li>
<li>
<p>After you have logged in successfully, you should see the sample <code>home page</code> from the browser.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="usage-2-web-application-accessing-resource-servers"><a class="anchor" href="#usage-2-web-application-accessing-resource-servers"></a><a class="link" href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a></h5>
<div class="paragraph">
<p>This scenario is based on <strong>Accessing a web application</strong> scenario to allow application to access other resources, that is [The OAuth 2.0 client credentials grant] flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webApiA</code>, record the <strong>Application ID</strong> as your <code>WEB_API_A_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_API_A_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>Expose an API</strong> on your left, and then Click the <strong>Set</strong> link,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 5: Select <strong>Manifest</strong> on your left, and then paste the following json segment into <code>appRoles</code> array,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, record the value of the app role as your <code>WEB_API_A_ROLE_VALUE</code>, then <strong>save</strong>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "allowedMemberTypes": [
    "Application"
  ],
  "description": "WebApiA.SampleScope",
  "displayName": "WebApiA.SampleScope",
  "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
  "isEnabled": true,
  "value": "WebApiA.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620567-59a91df7-7a97-4027-b525-1f422f25fb22.png" alt="Configure WebApiA appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>My APIs</strong>, select <strong><em>WebApiA</em></strong> application name, select <strong>Application Permissions</strong>, select <strong>WebApiA.SampleScope</strong> permission, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>WebApiA</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620601-660400fa-7cff-4989-9d7f-2b32a9aa1244.png" alt="Add WebApiA permission"></span></p>
</li>
<li>
<p>Step 8: Add the following dependency on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add the following configuration on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          authorization-clients:
            ${RESOURCE_SERVER_A_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_A_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your <code>Webapp</code> Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    /**
     * Access to protected data from Webapp to WebApiA through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi A.
     */
    @GetMapping("/webapp/webApiA")
    public String callWebApiA() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_A_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiA"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiA(), request '/webApiA/sample' returned: {}", body);
        return "Request '/webApiA/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a web application</strong> scenario, another bean <code>webClient</code> is added as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: See <strong>Accessing a resource server</strong> section to write your <code>WebApiA</code> Java code.</p>
</li>
<li>
<p>Step 12: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> and <code>WebApiA</code> run on port <em>8080</em> and <em>8081</em> respectively.
 Start <code>Webapp</code> and <code>WebApiA</code> application, return to the home page after logging successfully, you can access <code><a href="http://localhost:8080/webapp/webApiA" class="bare">localhost:8080/webapp/webApiA</a></code> to get <strong>WebApiA</strong> resource response.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-3-accessing-a-resource-server"><a class="anchor" href="#usage-3-accessing-a-resource-server"></a><a class="link" href="#usage-3-accessing-a-resource-server">Usage 3: Accessing a Resource Server</a></h5>
<div class="paragraph">
<p>This scenario not support login. Just protect the server by validating the access token, and if valid, serves the request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Refer to <a href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a> to build your <code>WebApiA</code> permission.</p>
</li>
<li>
<p>Step 2: Add <code>WebApiA</code> permission and grant admin consent for your web application.</p>
</li>
<li>
<p>Step 3: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          app-id-uri: ${APP_ID_URI}         # If you are using v1.0 token, please configure app-id-uri for `aud` verification
          credential:
            client-id: ${AZURE_CLIENT_ID}           # If you are using v2.0 token, please configure client-id for `aud` verification</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    /**
     * webApiA resource api for web app
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    @GetMapping("/webApiA/sample")
    public String webApiASample() {
        LOGGER.info("Call webApiASample()");
        return "Request '/webApiA/sample'(WebApi A) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class ResourceServerConfiguration extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated())
            .oauth2ResourceServer()
            .jwt()
            .jwtAuthenticationConverter(new AadJwtBearerTokenAuthenticationConverter());
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> run on port <em>8081</em>.
 Get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/sample" class="bare">localhost:8081/webApiA/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-4-resource-server-accessing-other-resource-servers"><a class="anchor" href="#usage-4-resource-server-accessing-other-resource-servers"></a><a class="link" href="#usage-4-resource-server-accessing-other-resource-servers">Usage 4: Resource Server Accessing Other Resource Servers</a></h5>
<div class="paragraph">
<p>This scenario is an upgrade of <strong>Accessing a resource server</strong>, supports access to other application resources, based on OAuth2 client credentials flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Referring to the previous steps, we create a <code>WebApiB</code> application and expose an application permission <code>WebApiB.SampleScope</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "allowedMemberTypes": [
        "Application"
    ],
    "description": "WebApiB.SampleScope",
    "displayName": "WebApiB.SampleScope",
    "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "WebApiB.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620648-cfbf5220-9736-4050-a3ef-1370c522e672.png" alt="Configure WebApiB appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Grant admin consent for <strong><em>WebApiB</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620691-b1a7fcda-fc92-41af-9515-812139f26ee0.png" alt="Add WebApiB permission"></span></p>
</li>
<li>
<p>Step 3: On the basis of <strong>Accessing a resource server</strong>, add a dependency in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
 &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
 &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration on the basis of <strong>Accessing a resource server</strong> scenario configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          credential:
            client-secret: ${WEB_API_A_AZURE_CLIENT_SECRET}
          authorization-clients:
            ${RESOURCE_SERVER_B_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_B_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebApiA controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    /**
     * Access to protected data from WebApiA to WebApiB through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi B.
     */
    @GetMapping("/webApiA/webApiB/sample")
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    public String callWebApiB() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_B_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiB"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiB(), request '/webApiB/sample' returned: {}", body);
        return "Request 'webApiA/webApiB/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WebApiB controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    /**
     * webApiB resource api for other web application
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiB.SampleScope')")
    @GetMapping("/webApiB/sample")
    public String webApiBSample() {
        LOGGER.info("Call webApiBSample()");
        return "Request '/webApiB/sample'(WebApi B) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a resource server</strong> scenario, another bean <code>webClient</code> is added as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> and <code>WebApiB</code> run on port <em>8081</em> and <em>8082</em> respectively.
 Start <code>WebApiA</code> and <code>WebApiB</code> application, get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/webApiB/sample" class="bare">localhost:8081/webApiA/webApiB/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-9"><a class="anchor" href="#samples-9"></a><a class="link" href="#samples-9">12.2.4. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/aad/spring-cloud-azure-starter-active-directory-b2c">spring-cloud-azure-starter-active-directory-b2c samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-integration-support"><a class="anchor" href="#spring-integration-support"></a><a class="link" href="#spring-integration-support">13. Spring Integration Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Integration Extension for Azure provides Spring Integration adapters for the various services provided by the <a href="https://github.com/Azure/azure-sdk-for-java/">Azure SDK for Java</a>. We provide Spring Integration support for these Azure services: Event Hubs, Service Bus, Storage Queue. The following is a list of supported adapters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-starter-integration-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-servicebus</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-storage-queue</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-event-hubs"><a class="anchor" href="#spring-integration-with-azure-event-hubs"></a><a class="link" href="#spring-integration-with-azure-event-hubs">13.1. Spring Integration with Azure Event Hubs</a></h3>
<div class="sect3">
<h4 id="key-concepts-2"><a class="anchor" href="#key-concepts-2"></a><a class="link" href="#key-concepts-2">13.1.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Azure Event Hubs is a big data streaming platform and event ingestion service. It can receive and process millions of events per second. Data sent to an event hub can be transformed and stored by using any real-time analytics provider or batching/storage adapters.</p>
</div>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters. Those adapters provide a higher-level of abstraction over Springâ€™s support for remoting, messaging, and scheduling. The <strong>Spring Integration for Event Hubs</strong> extension project provides inbound and outbound channel adapters and gateways for Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
RxJava support APIs are dropped from version 4.0.0.
See Javadoc for details.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="consumer-group"><a class="anchor" href="#consumer-group"></a><a class="link" href="#consumer-group">Consumer Group</a></h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support"><a class="anchor" href="#partitioning-support"></a><a class="link" href="#partitioning-support">Partitioning Support</a></h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the following section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support"><a class="anchor" href="#batch-consumer-support"></a><a class="link" href="#batch-consumer-support">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> supports the batch-consuming mode. To enable it, users can specify the listener mode as <code>ListenerMode.BATCH</code> when constructing an <code>EventHubsInboundChannelAdapter</code> instance.
When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the downstream channel. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#si-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch consuming policy can be specified by properties of <code>max-size</code> and <code>max-wait-time</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional.
To specify the batch consuming strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the following section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-6"><a class="anchor" href="#dependency-setup-6"></a><a class="link" href="#dependency-setup-6">13.1.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-7"><a class="anchor" href="#configuration-7"></a><a class="link" href="#configuration-7">13.1.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties"><a class="anchor" href="#connection-configuration-properties"></a><a class="link" href="#connection-configuration-properties">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Connection configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.shared-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the underlying EventProcessorClient and EventHubProducerAsyncClient use the same connection. By
default, a new connection is constructed and used created for each Event Hub client created.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties"><a class="anchor" href="#checkpoint-configuration-properties"></a><a class="link" href="#checkpoint-configuration-properties">Checkpoint Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Checkpointing configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="event-hub-processor-configuration-properties"><a class="anchor" href="#event-hub-processor-configuration-properties"></a><a class="link" href="#event-hub-processor-configuration-properties">Event Hub Processor Configuration Properties</a></h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> uses the <code>EventProcessorClient</code> to consume messages from an event hub, to configure the overall properties of an <code>EventProcessorClient</code>,
developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the following section</a> about how to work with <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-6"><a class="anchor" href="#basic-usage-6"></a><a class="link" href="#basic-usage-6">13.1.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-event-hubs"><a class="anchor" href="#send-messages-to-azure-event-hubs"></a><a class="link" href="#send-messages-to-azure-event-hubs">Send messages to Azure Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure the following properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT-CONTAINER}
            account-name: ${CHECKPOINT-STORAGE-ACCOUNT}
            account-key: ${CHECKPOINT-ACCESS-KEY}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure the following properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>EventHubsTemplate</code> to send messages to Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    private static final String OUTPUT_CHANNEL = "output";
    private static final String EVENTHUB_NAME = "eh1";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(EventHubsTemplate eventHubsTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(EVENTHUB_NAME, eventHubsTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }
            @Override
            public void onFailure(Throwable ex) {
                LOGGER.error("There was an error sending the message.", ex);
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @Autowired
    EventHubOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface EventHubOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-eh"><a class="anchor" href="#receive-from-eh"></a><a class="link" href="#receive-from-eh">Receive Messages from Azure Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class Demo {
    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>EventHubsInboundChannelAdapter</code> with the bean of <code>EventHubsMessageListenerContainer</code> to receive messages from Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with EventHubsInboundChannelAdapter via the message channel created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-eventhubsmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-eventhubsmessageconverter-to-customize-objectmapper"></a><a class="link" href="#configure-eventhubsmessageconverter-to-customize-objectmapper">Configure EventHubsMessageConverter to Customize ObjectMapper</a></h5>
<div class="paragraph">
<p><code>EventHubsMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-batch"><a class="anchor" href="#si-eh-batch"></a><a class="link" href="#si-eh-batch">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>To consume messages from Event Hubs in batches is similar with the above sample, besides users should set the batch-consuming related configuration options for <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
<div class="paragraph">
<p>When create <code>EventHubsInboundChannelAdapter</code>, the listener mode should be set as <code>BATCH</code>. When create bean of <code>EventHubsMessageListenerContainer</code>, set the checkpoint mode as either <code>MANUAL</code> or <code>BATCH</code>, and the batch options can be configured as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer, ListenerMode.BATCH);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.getBatch().setMaxSize(100);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-headers"><a class="anchor" href="#si-eh-headers"></a><a class="link" href="#si-eh-headers">Event Hubs Message Headers</a></h5>
<div class="paragraph">
<p>The following table illustrates how Event Hubs message properties are mapped to Spring message headers. For Azure Event Hubs, message is called as <code>event</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Record Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The instant, in UTC, of when the event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset of the event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition hashing key if it was set when originally publishing the event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#RAW_PARTITION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition id of the Event Hub.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sequence number assigned to the event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last enqueued event properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#LAST_ENQUEUED_EVENT_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastEnqueuedEventProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The properties of the last enqueued event in this partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#CHECKPOINTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpointer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The header for checkpoint the specific message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Users can parse the message headers for the related information of each event. To set a message header for the event, all customized headers will be put as an application property of an event, where the header is set as the property key. When events are received from Event Hubs, all application properties will be converted to the message header.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Message headers of partition key, enqueued time, offset and sequence number is not supported to be set manually.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the batch-consumer mode is enabled, the specific headers of batched messages are listed the following, which contains a list of values from each single Event Hubs event.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Batch Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Batch Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the instant, in UTC, of when each event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the offset of each event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the partition hashing key if it was set when originally publishing each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the sequence number assigned to each event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">System properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_SYSTEM_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the system properties of each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_APPLICATION_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the application properties of each event, where all customized message headers or event properties are placed.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When publish messages, all the above batch headers will be removed from the messages if exist.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-10"><a class="anchor" href="#samples-10"></a><a class="link" href="#samples-10">13.1.5. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/eventhubs/spring-cloud-azure-starter-integration-eventhubs/eventhubs-integration">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-service-bus"><a class="anchor" href="#spring-integration-with-azure-service-bus"></a><a class="link" href="#spring-integration-with-azure-service-bus">13.2. Spring Integration with Azure Service Bus</a></h3>
<div class="sect3">
<h4 id="key-concepts-3"><a class="anchor" href="#key-concepts-3"></a><a class="link" href="#key-concepts-3">13.2.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters.</p>
</div>
<div class="paragraph">
<p>The Spring Integration for Azure Service Bus extension project provides inbound and outbound channel adapters for Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
CompletableFuture support APIs have been deprecated from version 2.10.0, and is replaced by Reactor Core from version 4.0.0.
See Javadoc for details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-7"><a class="anchor" href="#dependency-setup-7"></a><a class="link" href="#dependency-setup-7">13.2.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-8"><a class="anchor" href="#configuration-8"></a><a class="link" href="#configuration-8">13.2.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-2"><a class="anchor" href="#connection-configuration-properties-2"></a><a class="link" href="#connection-configuration-properties-2">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. Connection configurable properties of spring-cloud-azure-starter-integration-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="service-bus-processor-configuration-properties"><a class="anchor" href="#service-bus-processor-configuration-properties"></a><a class="link" href="#service-bus-processor-configuration-properties">Service Bus Processor Configuration Properties</a></h5>
<div class="paragraph">
<p>The <code>ServiceBusInboundChannelAdapter</code> uses the <code>ServiceBusProcessorClient</code> to consume messages, to configure the overall properties of an <code>ServiceBusProcessorClient</code>,
developers can use <code>ServiceBusContainerProperties</code> for the configuration. See <a href="#receive-from-sb">the following section</a> about how to work with <code>ServiceBusInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-7"><a class="anchor" href="#basic-usage-7"></a><a class="link" href="#basic-usage-7">13.2.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-service-bus"><a class="anchor" href="#send-messages-to-azure-service-bus"></a><a class="link" href="#send-messages-to-azure-service-bus">Send Messages to Azure Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>ServiceBusTemplate</code> to send messages to Service Bus,
set the entity type for the ServiceBusTemplate. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    private static final String OUTPUT_CHANNEL = "queue.output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler queueMessageSender(ServiceBusTemplate serviceBusTemplate) {
        serviceBusTemplate.setDefaultEntityType(ServiceBusEntityType.QUEUE);
        DefaultMessageHandler handler = new DefaultMessageHandler(QUEUE_NAME, serviceBusTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });

        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @Autowired
    QueueOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface QueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-sb"><a class="anchor" href="#receive-from-sb"></a><a class="link" href="#receive-from-sb">Receive Messages from Azure Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>ServiceBusInboundChannelAdapter</code> with the bean of <code>ServiceBusMessageListenerContainer</code> to receive messages to Service Bus. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class Demo {
    private static final String QUEUE_NAME = "queue1";

    @Bean
    public ServiceBusMessageListenerContainer messageListenerContainer(ServiceBusProcessorFactory processorFactory) {
        ServiceBusContainerProperties containerProperties = new ServiceBusContainerProperties();
        containerProperties.setEntityName(QUEUE_NAME);
        containerProperties.setAutoComplete(false);
        return new ServiceBusMessageListenerContainer(processorFactory, containerProperties);
    }

    @Bean
    public ServiceBusInboundChannelAdapter queueMessageChannelAdapter(
        @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
        ServiceBusMessageListenerContainer listenerContainer) {
        ServiceBusInboundChannelAdapter adapter = new ServiceBusInboundChannelAdapter(listenerContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with ServiceBusInboundChannelAdapter via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-servicebusmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-servicebusmessageconverter-to-customize-objectmapper"></a><a class="link" href="#configure-servicebusmessageconverter-to-customize-objectmapper">Configure ServiceBusMessageConverter to Customize ObjectMapper</a></h5>
<div class="paragraph">
<p><code>ServiceBusMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-sb-headers"><a class="anchor" href="#si-sb-headers"></a><a class="link" href="#si-sb-headers">Service Bus Message Headers</a></h5>
<div class="paragraph">
<p>For some Service Bus headers that can be mapped to multiple Spring header constants, the priority of different Spring headers is listed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. Mapping between Service Bus Headers and Spring Headers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Bus Message Headers and Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Configurable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The RFC2045 Content-Type descriptor of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Correlation id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#CORRELATION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The correlation id of the message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#MESSAGE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has higher priority than <code>MessageHeaders#ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has lower priority than <code>ServiceBusMessageHeaders#MESSAGE_ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition key for sending the message to a partitioned entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#REPLY_CHANNEL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The address of an entity to send replies to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#REPLY_TO_SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ReplyToGroupId property value of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has higher priority than <code>AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has lower priority than <code>ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The session identifier for a session-aware entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to live</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TIME_TO_LIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration of time before this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "to" address of the message, reserved for future use in routing scenarios and presently ignored by the broker itself.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SUBJECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subject for the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter error description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_ERROR_DESCRIPTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The description for a message that has been dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter reason</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_REASON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reason a message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_SOURCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity in which the message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DELIVERY_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of the times this message was delivered to clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The enqueued sequence number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message was enqueued in Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expires at</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#EXPIRES_AT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message will expire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lock token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCK_TOKEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lock token for the current message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Locked until</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCKED_UNTIL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the lock of this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">State</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#STATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageState</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The state of the message, which can be Active, Deferred, or Scheduled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="partition-key-support"><a class="anchor" href="#partition-key-support"></a><a class="link" href="#partition-key-support">Partition Key Support</a></h5>
<div class="paragraph">
<p>This starter supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p><em>Recommended:</em> Use <code>ServiceBusMessageHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Not recommended but currently supported:</em> <code>AzureHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(AzureHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When both <code>ServiceBusMessageHeaders.PARTITION_KEY</code> and <code>AzureHeaders.PARTITION_KEY</code> are set in the message headers,
<code>ServiceBusMessageHeaders.PARTITION_KEY</code> is preferred.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="session-support"><a class="anchor" href="#session-support"></a><a class="link" href="#session-support">Session Support</a></h5>
<div class="paragraph">
<p>This example demonstrates how to manually set the session id of a message in the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the <code>ServiceBusMessageHeaders.SESSION_ID</code> is set in the message headers, and a different <code>ServiceBusMessageHeaders.PARTITION_KEY</code> (or <code>AzureHeaders.PARTITION_KEY</code>) header is also set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-11"><a class="anchor" href="#samples-11"></a><a class="link" href="#samples-11">13.2.5. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/servicebus/spring-cloud-azure-starter-integration-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-storage-queue"><a class="anchor" href="#spring-integration-with-azure-storage-queue"></a><a class="link" href="#spring-integration-with-azure-storage-queue">13.3. Spring Integration with Azure Storage Queue</a></h3>
<div class="sect3">
<h4 id="key-concepts-4"><a class="anchor" href="#key-concepts-4"></a><a class="link" href="#key-concepts-4">13.3.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Azure Queue Storage is a service for storing large numbers of messages. You access messages from anywhere in the world via authenticated calls using HTTP or HTTPS. A queue message can be up to 64 KB in size. A queue may contain millions of messages, up to the total capacity limit of a storage account. Queues are commonly used to create a backlog of work to process asynchronously.</p>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-8"><a class="anchor" href="#dependency-setup-8"></a><a class="link" href="#dependency-setup-8">13.3.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-storage-queue&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-9"><a class="anchor" href="#configuration-9"></a><a class="link" href="#configuration-9">13.3.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-3"><a class="anchor" href="#connection-configuration-properties-3"></a><a class="link" href="#connection-configuration-properties-3">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Storage Queue.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. Connection configurable properties of spring-cloud-azure-starter-integration-storage-queue</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Storage Queue is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue service endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.sasToken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sas token credential</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.serviceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion that is used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.messageEncoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queue message encoding.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-8"><a class="anchor" href="#basic-usage-8"></a><a class="link" href="#basic-usage-8">13.3.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-storage-queue"><a class="anchor" href="#send-messages-to-azure-storage-queue"></a><a class="link" href="#send-messages-to-azure-storage-queue">Send messages to Azure Storage Queue</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      storage:
        queue:
          connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>StorageQueueTemplate</code> to send messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";
    private static final String OUTPUT_CHANNEL = "output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(StorageQueueTemplate storageQueueTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(STORAGE_QUEUE_NAME, storageQueueTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a Message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @Autowired
    StorageQueueOutboundGateway storageQueueOutboundGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface StorageQueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    public void demo() {
        this.storageQueueOutboundGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-messages-from-azure-storage-queue"><a class="anchor" href="#receive-messages-from-azure-storage-queue"></a><a class="link" href="#receive-messages-from-azure-storage-queue">Receive Messages from Azure Storage Queue</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>StorageQueueMessageSource</code> with the bean of <code>StorageQueueTemplate</code> to receive messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";

    @Bean
    @InboundChannelAdapter(channel = INPUT_CHANNEL, poller = @Poller(fixedDelay = "1000"))
    public StorageQueueMessageSource storageQueueMessageSource(StorageQueueTemplate storageQueueTemplate) {
        return new StorageQueueMessageSource(STORAGE_QUEUE_NAME, storageQueueTemplate);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with StorageQueueMessageSource created in the last step via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
            .doOnError(Throwable::printStackTrace)
            .doOnSuccess(t -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
            .block();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-12"><a class="anchor" href="#samples-12"></a><a class="link" href="#samples-12">13.3.5. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/storage/spring-cloud-azure-starter-integration-storage-queue">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-stream-support"><a class="anchor" href="#spring-cloud-stream-support"></a><a class="link" href="#spring-cloud-stream-support">14. Spring Cloud Stream Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Stream is a framework for building highly scalable event-driven microservices connected with shared messaging systems.</p>
</div>
<div class="paragraph">
<p>The framework provides a flexible programming model built on already established and familiar Spring idioms and best practices, including support for persistent pub/sub semantics, consumer groups, and stateful partitions.</p>
</div>
<div class="paragraph">
<p>Current binder implementations include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-stream-binder-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-stream-binder-servicebus</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-event-hubs"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-event-hubs"></a><a class="link" href="#spring-cloud-stream-binder-for-azure-event-hubs">14.1. Spring Cloud Stream Binder for Azure Event Hubs</a></h3>
<div class="sect3">
<h4 id="key-concepts-5"><a class="anchor" href="#key-concepts-5"></a><a class="link" href="#key-concepts-5">14.1.1. Key Concepts</a></h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Event Hubs provides the binding implementation for the Spring Cloud Stream framework.
This implementation uses Spring Integration Event Hubs Channel Adapters at its foundation. From design&#8217;s perspective,
Event Hubs is similar as Kafka. Also, Event Hubs could be accessed via Kafka API. If your project has tight dependency
on Kafka API, you can try <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/eventhubs/spring-cloud-azure-starter/spring-cloud-azure-sample-eventhubs-kafka">Events Hub with Kafka API Sample</a></p>
</div>
<div class="sect4">
<h5 id="consumer-group-2"><a class="anchor" href="#consumer-group-2"></a><a class="link" href="#consumer-group-2">Consumer Group</a></h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-2"><a class="anchor" href="#partitioning-support-2"></a><a class="link" href="#partitioning-support-2">Partitioning Support</a></h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, properties of <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.load-balancing.*</code> are provided. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-2"><a class="anchor" href="#batch-consumer-support-2"></a><a class="link" href="#batch-consumer-support-2">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>Spring Cloud Azure Stream Event Hubs binder supports <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_batch_consumers">Spring Cloud Stream Batch Consumer feature</a>.</p>
</div>
<div class="paragraph">
<p>To work with the batch-consumer mode, the property of <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.consumer.batch-mode</code> should be set as <code>true</code>. When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the <code>Consumer</code> function. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#scs-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received by the binder. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch size can be specified by properties of <code>max-size</code> and <code>max-wait-time</code> with prefix as <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.batch.</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-9"><a class="anchor" href="#dependency-setup-9"></a><a class="link" href="#dependency-setup-9">14.1.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Event Hubs Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-10"><a class="anchor" href="#configuration-10"></a><a class="link" href="#configuration-10">14.1.3. Configuration</a></h4>
<div class="paragraph">
<p>The binder provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="eventhubs-connection-configuration"><a class="anchor" href="#eventhubs-connection-configuration"></a><a class="link" href="#eventhubs-connection-configuration">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, See <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. Connection configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Event Hubs binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, see the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties-2"><a class="anchor" href="#checkpoint-configuration-properties-2"></a><a class="link" href="#checkpoint-configuration-properties-2">Checkpoint Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically with the name from <strong>spring.cloud.stream.bindings.&lt;binding-name&gt;.destination</strong>.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. Checkpointing configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="azure-event-hubs-binding-configuration-properties"><a class="anchor" href="#azure-event-hubs-binding-configuration-properties"></a><a class="link" href="#azure-event-hubs-binding-configuration-properties">Azure Event Hubs Binding Configuration Properties</a></h5>
<div class="paragraph">
<p>The following options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="eventhubs-consumer-properties"><a class="anchor" href="#eventhubs-consumer-properties"></a><a class="link" href="#eventhubs-consumer-properties">Consumer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Consumer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CheckpointMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpoint mode used when consumer decide how to checkpoint message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the amount of message for each partition to do one checkpoint. Will take effect only when <code>PARTITION_COUNT</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the time interval to do one checkpoint. Will take effect only when <code>TIME</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of events in a batch. Required for the batch-consumer mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-wait-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum time duration for batch consuming. Will take effect only when the batch-consumer mode is enabled and is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.update-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval time duration for updating.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LoadBalancingStrategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The load balancing strategy.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.partition-ownership-expiration-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time duration after which the ownership of partition expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.track-last-enqueued-event-properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the event processor should request information on the last enqueued event on its associated partition, and track that information as events are received.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The count used by the consumer to control the number of events the Event Hub consumer will actively receive and queue locally.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.initial-partition-event-position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map with the key as the partition id, and values of <code>StartPositionProperties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The map containing the event position to use for each partition if a checkpoint for the partition does not exist in checkpoint store. This map is keyed off of the partition id.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>initial-partition-event-position</code> configuration accepts a <code>map</code> to specify the initial position for each event hub. Thus, its key is the partition id, and the value is of <code>StartPositionProperties</code> which includes properties of offset, sequence number, enqueued date time and whether inclusive. For example, you can set it as
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    stream:
      eventhubs:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              initial-partition-event-position:
                0:
                  offset: earliest
                1:
                  sequence-number: 100
                2:
                  enqueued-date-time: 2022-01-12T13:32:47.650005Z
                4:
                  inclusive: false</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration"><a class="anchor" href="#advanced-consumer-configuration"></a><a class="link" href="#advanced-consumer-configuration">Advanced Consumer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a>, <a href="#checkpoint-configuration-properties">checkpoint</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties"><a class="anchor" href="#producer-properties"></a><a class="link" href="#producer-properties">Producer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 30. Producer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The switch flag for sync of producer. If true, the producer will wait for a response after a send operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to wait for a response after a send operation. Will take effect only when a sync producer is enabled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration"><a class="anchor" href="#advanced-producer-configuration"></a><a class="link" href="#advanced-producer-configuration">Advanced Producer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-9"><a class="anchor" href="#basic-usage-9"></a><a class="link" href="#basic-usage-9">14.1.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-event-hubs"><a class="anchor" href="#sending-and-receiving-messages-fromto-event-hubs"></a><a class="link" href="#sending-and-receiving-messages-fromto-event-hubs">Sending and Receiving Messages from/to Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT_CONTAINER}
            account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
            account-key: ${CHECKPOINT_ACCESS_KEY}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identites, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}

      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload(),
                message.getHeaders().get(EventHubsHeaders.PARTITION_KEY),
                message.getHeaders().get(EventHubsHeaders.SEQUENCE_NUMBER),
                message.getHeaders().get(EventHubsHeaders.OFFSET),
                message.getHeaders().get(EventHubsHeaders.ENQUEUED_TIME)
        );

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-3"><a class="anchor" href="#partitioning-support-3"></a><a class="link" href="#partitioning-support-3">Partitioning Support</a></h5>
<div class="paragraph">
<p>A <code>PartitionSupplier</code> with user-provided partition information will be created to configure the partition information about the message to be sent, the following is the process of obtaining different priorities of the partition ID and key:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/63028776/145347877-fa8afa90-ec28-4c0a-8277-63b9fdaa5d0f.png" alt="145347877 fa8afa90 ec28 4c0a 8277 63b9fdaa5d0f"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-3"><a class="anchor" href="#batch-consumer-support-3"></a><a class="link" href="#batch-consumer-support-3">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>Step 1. Fill the batch configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    stream:
      function:
        definition: consume
      bindings:
        consume-in-0:
          destination: ${AZURE_EVENTHUB_NAME}
          group: ${AZURE_EVENTHUB_CONSUMER_GROUP}
          consumer:
            batch-mode: true
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              batch:
                max-batch-size: 10 # Required for batch-consumer mode
                max-wait-time: 1m # Optional, the default value is null
              checkpoint:
                mode: BATCH # or MANUAL as needed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>BATCH</code>, you can use the following code to send messages and consume in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
            for (int i = 0; i &lt; message.getPayload().size(); i++) {
                LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                        message.getPayload().get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
            }

        };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>MANUAL</code>, you can use the following code to send messages and consume/checkpoint in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
        for (int i = 0; i &lt; message.getPayload().size(); i++) {
            LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload().get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
        }

        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        checkpointer.success()
                    .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                    .doOnError(error -&gt; LOGGER.error("Exception found", error))
                    .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the batch-consuming mode, the default content type of Spring Cloud Stream binder is <code>application/json</code>, so make sure the message payload is aligned with the content type. For example, when using the default content type of <code>application/json</code> to receive messages with <code>String</code> payload, the payload should be JSON String, surrounded with double quotes for the original String text. While for <code>text/plain</code> content type, it can be a <code>String</code> object directly. For more details, see the official doc of <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#content-type-management">Spring Cloud Stream Content Type Negotiation</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels"><a class="anchor" href="#error-channels"></a><a class="link" href="#error-channels">Error Channels</a></h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, you can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-eh-headers"><a class="anchor" href="#scs-eh-headers"></a><a class="link" href="#scs-eh-headers">Event Hubs Message Headers</a></h5>
<div class="paragraph">
<p>See the <a href="#si-eh-headers">Event Hubs message headers</a> for the basic message headers supported.</p>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support"><a class="anchor" href="#multiple-binder-support"></a><a class="link" href="#multiple-binder-support">Multiple Binder Support</a></h5>
<div class="paragraph">
<p>Connection to multiple Event Hubs namespaces is also supported by using multiple binders.This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of EventHubs, we need to configure the following properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${EVENTHUB_NAME_01}
          group: ${CONSUMER_GROUP_01}
        supply1-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_01_AS_ABOVE}
        consume2-in-0:
          binder: eventhub-2
          destination: ${EVENTHUB_NAME_02}
          group: ${CONSUMER_GROUP_02}
        supply2-out-0:
          binder: eventhub-2
          destination: ${THE_SAME_EVENTHUB_NAME_02_AS_ABOVE}
      binders:
        eventhub-1:
          type: eventhubs
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_01_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_01}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
        eventhub-2:
          type: eventhubs
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_02_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_02}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
      eventhubs:
        bindings:
          consume1-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
          consume2-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message1 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message2 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision"><a class="anchor" href="#resource-provision"></a><a class="link" href="#resource-provision">Resource Provision</a></h5>
<div class="paragraph">
<p>Event Hubs binder supports provisioning of event hub and consumer group, users could use the following properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURECE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-13"><a class="anchor" href="#samples-13"></a><a class="link" href="#samples-13">14.1.5. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/eventhubs/spring-cloud-azure-stream-binder-eventhubs">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-service-bus"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-service-bus"></a><a class="link" href="#spring-cloud-stream-binder-for-azure-service-bus">14.2. Spring Cloud Stream Binder for Azure Service Bus</a></h3>
<div class="sect3">
<h4 id="key-concepts-6"><a class="anchor" href="#key-concepts-6"></a><a class="link" href="#key-concepts-6">14.2.1. Key Concepts</a></h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Service Bus provides the binding implementation for the Spring Cloud Stream Framework.
This implementation uses Spring Integration Service Bus Channel Adapters at its foundation.</p>
</div>
<div class="sect4">
<h5 id="scheduled-message"><a class="anchor" href="#scheduled-message"></a><a class="link" href="#scheduled-message">Scheduled Message</a></h5>
<div class="paragraph">
<p>This binder supports submitting messages to a topic for delayed processing. Users can send scheduled messages with header <code>x-delay</code>
expressing in milliseconds a delay time for the message. The message will be delivered to the respective topics after <code>x-delay</code> milliseconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-group-3"><a class="anchor" href="#consumer-group-3"></a><a class="link" href="#consumer-group-3">Consumer Group</a></h5>
<div class="paragraph">
<p>Service Bus Topic provides similar support of consumer group as Apache Kafka, but with slight different logic.
This binder relies on <code>Subscription</code> of a topic to act as a consumer group.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-10"><a class="anchor" href="#dependency-setup-10"></a><a class="link" href="#dependency-setup-10">14.2.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Service Bus Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-11"><a class="anchor" href="#configuration-11"></a><a class="link" href="#configuration-11">14.2.3. Configuration</a></h4>
<div class="paragraph">
<p>The binder provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="servicebus-connection-configuration"><a class="anchor" href="#servicebus-connection-configuration"></a><a class="link" href="#servicebus-connection-configuration">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. Connection configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Service Bus binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.servicebus.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, see the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="azure-service-bus-binding-configuration-properties"><a class="anchor" href="#azure-service-bus-binding-configuration-properties"></a><a class="link" href="#azure-service-bus-binding-configuration-properties">Azure Service Bus Binding Configuration Properties</a></h5>
<div class="paragraph">
<p>The following options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="consumer-properties"><a class="anchor" href="#consumer-properties"></a><a class="link" href="#consumer-properties">Consumer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. Consumer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.requeue-rejected</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the failed messages are routed to the DLQ.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-calls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max concurrent messages that the Service Bus processor client should process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-sessions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of concurrent sessions to process at any given time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.session-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether session is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prefetch count of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.sub-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SubQueue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the sub queue to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-auto-lock-renew-duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to continue auto-renewing the lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.receive-mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusReceiveMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">peek_lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The receive mode of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.auto-complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to settle messages automatically. If set as false, a message header of <code>Checkpointer</code> will be added
to enable developers to settle messages manually.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration-2"><a class="anchor" href="#advanced-consumer-configuration-2"></a><a class="link" href="#advanced-consumer-configuration-2">Advanced Consumer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties-2"><a class="anchor" href="#producer-properties-2"></a><a class="link" href="#producer-properties-2">Producer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. Producer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Switch flag
for sync of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout
value for sending of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.entity-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusEntityType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus entity type of the producer, required for the binding producer.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using the binding producer, property of <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.entity-type</code> is required to be configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration-2"><a class="anchor" href="#advanced-producer-configuration-2"></a><a class="link" href="#advanced-producer-configuration-2">Advanced Producer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-10"><a class="anchor" href="#basic-usage-10"></a><a class="link" href="#basic-usage-10">14.2.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-service-bus"><a class="anchor" href="#sending-and-receiving-messages-fromto-service-bus"></a><a class="link" href="#sending-and-receiving-messages-fromto-service-bus">Sending and Receiving Messages from/to Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${SERVICEBUS_NAMESPACE_CONNECTION_STRING}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add the following configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add the following configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure the following properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add the following configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}'", message.getPayload());

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partition-key-support-2"><a class="anchor" href="#partition-key-support-2"></a><a class="link" href="#partition-key-support-2">Partition Key Support</a></h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Stream provides a partition key SpEL expression property <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code>. For example, setting this property as <code>&quot;&#39;partitionKey-&#39; + headers[&lt;message-header-key&gt;]&quot;</code> and add a header called &lt;message-header-key&gt;. Spring Cloud Stream will use the value for this header when evaluating the above expression to assign a partition key. Here is an example producer code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = â€œrandom payloadâ€;
        return MessageBuilder.withPayload(value)
            .setHeader("&lt;message-header-key&gt;", value.length() % 4)
            .build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="session-support-2"><a class="anchor" href="#session-support-2"></a><a class="link" href="#session-support-2">Session Support</a></h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/message-sessions">message sessions</a> of Service Bus. Session id of a message could be set via the message header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = â€œrandom payloadâ€;
        return MessageBuilder.withPayload(value)
            .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
            .build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
According to <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a>, session id has higher priority than partition key. So when both of <code>ServiceBusMessageHeaders#SESSION_ID</code> and <code>ServiceBusMessageHeaders#PARTITION_KEY</code> (or <code>AzureHeaders#PARTITION_KEY</code>) headers are set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels-2"><a class="anchor" href="#error-channels-2"></a><a class="link" href="#error-channels-2">Error Channels</a></h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, and a default consumer error channel handler is used to send failed messages to the dead-letter queue when <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.requeue-rejected</code> is enabled, otherwise the failed messages will be abandoned.</p>
</div>
<div class="paragraph">
<p>To customize the consumer error channel handler, you can register you own error handler to the related consumer error channel in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-sb-headers"><a class="anchor" href="#scs-sb-headers"></a><a class="link" href="#scs-sb-headers">Service Bus Message Headers</a></h5>
<div class="paragraph">
<p>See the <a href="#si-sb-headers">Service Bus message headers</a> for the basic message headers supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When setting the partiton key, the priority of message header is higher than Spring Cloud Stream property. So <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code> will take effect only when none of the headers of <code>ServiceBusMessageHeaders#SESSION_ID</code>, <code>ServiceBusMessageHeaders#PARTITION_KEY</code>, <code>AzureHeaders#PARTITION_KEY</code> is configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support-2"><a class="anchor" href="#multiple-binder-support-2"></a><a class="link" href="#multiple-binder-support-2">Multiple Binder Support</a></h5>
<div class="paragraph">
<p>Connection to multiple Service Bus namespaces is also supported by using multiple binders. This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of ServiceBus, we need to configure the following properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${SERVICEBUS_TOPIC_NAME}
          group: ${SUBSCRIPTION_NAME}
        supply1-out-0:
          destination: ${SERVICEBUS_TOPIC_NAME_SAME_AS_ABOVE}
        consume2-in-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME}
        supply2-out-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME_SAME_AS_ABOVE}
      binders:
        servicebus-1:
          type: servicebus
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_01_CONNECTION_STRING}
        servicebus-2:
          type: servicebus
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_02_CONNECTION_STRING}
      servicebus:
        bindings:
          consume1-in-0:
            consumer:
              auto-complete: false
          supply1-out-0:
            producer:
              entity-type: topic
          consume2-in-0:
            consumer:
              auto-complete: false
          supply2-out-0:
            producer:
              entity-type: queue
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision-2"><a class="anchor" href="#resource-provision-2"></a><a class="link" href="#resource-provision-2">Resource Provision</a></h5>
<div class="paragraph">
<p>Service bus binder supports provisioning of queue, topic and subscription, users could use the following properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      servicebus:
        resource:
          resource-group: ${AZURE_SERVICEBUS_RESOURECE_GROUP}
    stream:
      servicebus:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              entity-type: ${SERVICEBUS_CONSUMER_ENTITY_TYPE}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-14"><a class="anchor" href="#samples-14"></a><a class="link" href="#samples-14">14.2.5. Samples</a></h4>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1/servicebus/spring-cloud-azure-stream-binder-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-jms-support"><a class="anchor" href="#spring-jms-support"></a><a class="link" href="#spring-jms-support">15. Spring JMS Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use Azure Service Bus by the JMS API integrated into the Spring JMS framework.
Azure Service Bus connection string have to be provided which is to be parsed into the login username, password and remote URI for the AMQP broker.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-11"><a class="anchor" href="#dependency-setup-11"></a><a class="link" href="#dependency-setup-11">15.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>Adding the following dependencies if you want to migrate your Spring JMS application to use Azure Service Bus.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-servicebus-jms&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-12"><a class="anchor" href="#configuration-12"></a><a class="link" href="#configuration-12">15.2. Configuration</a></h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. Configurable properties when using Spring JMS support</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus connection string. Should be provided when want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.topic-client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS client ID. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration for idle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pricing-tier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Service Bus Price Tier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-pub-sub-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the reply destination type is topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the phase in which this container should be started and stopped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-qos-settings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure the QosSettings to use when sending a reply.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-durable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription durable. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-shared</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription shared. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login password of the AMQP broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="jms-servicebus-pool-configuration"></a> Whether to block when a connection is requested and the pool is full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blocking period before throwing an exception if the pool is still full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether a JmsPoolConnectionFactory should be created, instead of a regularConnectionFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection idle timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-connections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-sessions-per-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled sessions per connection in the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.time-between-expiration-check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to sleep between runs of the idle connection eviction thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.use-anonymous-producers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use only one anonymous "MessageProducer" instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fallback value for prefetch option in this Service Bus namespace.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.durable-topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for durable topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-browser-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue browser.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.remote-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL of the AMQP broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login user of the AMQP broker.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring JMS general configuration is omitted for short.
See <a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/jms.html">Spring JMS Document</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-11"><a class="anchor" href="#basic-usage-11"></a><a class="link" href="#basic-usage-11">15.3. Basic Usage</a></h3>
<div class="sect3">
<h4 id="use-service-bus-connection-string"><a class="anchor" href="#use-service-bus-connection-string"></a><a class="link" href="#use-service-bus-connection-string">15.3.1. Use Service Bus Connection String</a></h4>
<div class="paragraph">
<p>The simplest way to connect to Service Bus for Spring JMS application is with the connection string.</p>
</div>
<div class="paragraph">
<p>Add the following properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  jms:
    servicebus:
      connection-string: ${AZURE_SERVICEBUS_CONNECTION_STRING}
      pricing-tier: ${PRICING_TIER}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default enabled <code>ConnectionFactory</code> is the <code>CachingConnectionFactory</code> which adds Session caching as well MessageProducer caching. If you want to activate the connection pooling featured one of JmsPoolConnectionFactory, the property of <code>spring.jms.servicebus.pool.enabled</code> should be specified <code>true</code>. You can find other pooling configuration options (properties with prefix <code>spring.jms.servicebus.pool.</code>) from the above
<a href="#jms-servicebus-pool-configuration">Configuration</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-15"><a class="anchor" href="#samples-15"></a><a class="link" href="#samples-15">15.4. Samples</a></h3>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-native-support"><a class="anchor" href="#spring-native-support"></a><a class="link" href="#spring-native-support">16. Spring Native Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-native"><a class="anchor" href="#spring-native"></a><a class="link" href="#spring-native">16.1. Spring Native</a></h3>
<div class="paragraph">
<p>Spring Native provides support for compiling Spring Boot applications to native executables using the <a href="https://www.graalvm.org/">GraalVM</a> <a href="https://www.graalvm.org//reference-manual/native-image">native-image</a> compiler. The native images will bring many advantages, such as instant startup, instant peak performance, and reduced memory consumption. Some Spring Cloud Azure features can also benefit from the Spring Native support, the goal is that Spring Cloud Azure applications can be built as native images without any code modification. For more information, see the <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#overview">Spring Native documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="support"><a class="anchor" href="#support"></a><a class="link" href="#support">16.2. Support</a></h3>
<div class="paragraph">
<p>Spring Cloud Azure has been validated against GraalVM and Spring Native, and provides the beta version support. You can try it on your projects if they are using those supported dependencies, and <a href="https://github.com/Azure/azure-sdk-for-java/issues">raise bugs</a> or <a href="https://github.com/Azure/azure-sdk-for-java/tree/main/sdk/spring-experimental/spring-cloud-azure-native-configuration">contribute pull requests</a> if something goes wrong on Spring Cloud Azure. For more information, see the <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#support">Spring Native Support</a> for more details.</p>
</div>
<div class="sect3">
<h4 id="spring-native-2"><a class="anchor" href="#spring-native-2"></a><a class="link" href="#spring-native-2">16.2.1. Spring Native</a></h4>
<div class="paragraph">
<p>Spring Cloud Azure <strong>4.5.0-beta.1</strong> has been tested against Spring Native <code>0.11.4</code> and GraalVM <code>22.0.0</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="spring-cloud-azure-native"><a class="anchor" href="#spring-cloud-azure-native"></a><a class="link" href="#spring-cloud-azure-native">16.2.2. Spring Cloud Azure Native</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Native <code>0.11.4</code> has been tested against Spring Cloud Azure Native Configuration <code>4.0.0-beta.1</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Cloud Azure provides a dependency <code>spring-cloud-azure-native-configuration</code> that is an extension of Spring Native configuration for Spring Cloud Azure libraries. The Spring Native AOT plugin will combine the <code>spring-native-configuration</code> and <code>spring-cloud-azure-native-configuration</code> to build applications into native executables. You don&#8217;t need any extra modifications to the code that uses Spring Cloud Azure libraries apart from adding the dependency, which only applies to the code in the Spring Cloud Azure libraries.</p>
</div>
<div class="paragraph">
<p>The following features are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Azure App Configuration clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Event Hubs clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Key Vault Certificates clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Key Vault Secrets clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Storage Blob clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Storage File Share clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Storage Queue clients auto-configuration</code></p>
</li>
<li>
<p><code>Spring Integration for Azure Event Hubs</code></p>
</li>
<li>
<p><code>Spring Integration for Azure Storage Queue</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="limitations"><a class="anchor" href="#limitations"></a><a class="link" href="#limitations">16.2.3. Limitations</a></h4>
<div class="paragraph">
<p>The Spring Cloud Azure support for Spring Native is still in the early stages and continues to be updated. The following features are not yet supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Azure Cosmos clients auto-configuration</code></p>
</li>
<li>
<p><code>Azure Service Bus clients auto-configuration</code></p>
</li>
<li>
<p><code>Spring Data for Azure Cache for Redis</code></p>
</li>
<li>
<p><code>Spring Data for Azure Cosmos</code></p>
</li>
<li>
<p><code>Spring Cloud Stream for Azure Event Hubs</code></p>
</li>
<li>
<p><code>Spring Cloud Stream for Azure Service Bus</code></p>
</li>
<li>
<p><code>Spring Kafka for Azure Event Hubs</code></p>
</li>
<li>
<p><code>Spring Integration for Azure Service Bus</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all the native image options are supported by Spring Native. For more information, see the <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#native-image-options">Native image options</a> section of the Spring Native documentation.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Spring Cloud Azure <strong>4.5.0-beta.1</strong> is not validated for building native executables based on Gradle Kotlin.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="project-setup"><a class="anchor" href="#project-setup"></a><a class="link" href="#project-setup">16.3. Project Setup</a></h3>
<div class="paragraph">
<p>The Spring Cloud Azure applications can enable Spring Native support by following the instructions in the  <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#getting-started">Getting started</a>, section of the Spring Native documentation. The only additional processing required is to add the following dependency to the POM file.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The dependency <code>com.azure.spring:spring-cloud-azure-native-configuration</code> is not managed in <code>com.azure.spring:spring-cloud-azure-dependencies</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">  &lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-native-configuration&lt;/artifactId&gt;
    &lt;version&gt;4.0.0-beta.1&lt;/version&gt;
  &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Gradle Groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">dependencies {
    implementation "com.azure.spring:spring-cloud-azure-native-configuration:4.0.0-beta.1"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-the-native-application"><a class="anchor" href="#build-the-native-application"></a><a class="link" href="#build-the-native-application">16.4. Build the native application</a></h3>
<div class="paragraph">
<p>The following sections describe the two main ways to build a Spring Boot native application with Spring Cloud Azure libraries.</p>
</div>
<div class="sect3">
<h4 id="build-with-buildpacks"><a class="anchor" href="#build-with-buildpacks"></a><a class="link" href="#build-with-buildpacks">16.4.1. Build with Buildpacks</a></h4>
<div class="paragraph">
<p>The native application can be built as follows:</p>
</div>
<div class="listingblock primary">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">mvn spring-boot:build-image</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Gradle Groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">gradle bootBuildImage</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#getting-started-buildpacks">Getting started with Buildpacks</a> section in the Spring Native documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="build-with-native-build-tools"><a class="anchor" href="#build-with-native-build-tools"></a><a class="link" href="#build-with-native-build-tools">16.4.2. Build with Native Build Tools</a></h4>
<div class="paragraph">
<p>You can build the native application by using the following command:</p>
</div>
<div class="listingblock primary">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">mvn -Pnative -DskipTests package</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Gradle Groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">gradle nativeCompile</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://docs.spring.io/spring-native/docs/0.11.4/reference/htmlsingle/#getting-started-native-build-tools">Getting started with Native Build Tools</a> section of the Spring Native documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-the-native-application"><a class="anchor" href="#run-the-native-application"></a><a class="link" href="#run-the-native-application">16.5. Run the native application</a></h3>
<div class="paragraph">
<p>The following sections describe the two main ways to run a native executable.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Assuming the project artifact ID is <code>spring-cloud-azure-sample</code> and the project version is <code>0.0.1-SNAPSHOT</code>, you can specify the custom image name in one of the following ways:  If you&#8217;re using <a href="https://docs.spring.io/spring-boot/docs/2.6.11/reference/html/container-images.html#container-images.buildpacks">Cloud Native Buildpacks</a>, use the <code>image</code>&#8594;`name`&#8594;`custom-image-name` configuration element in the Spring Boot plugin. If you&#8217;re using <a href="https://github.com/graalvm/native-build-tools">GraalVM Native Build Tools</a>, use the <code>imageName</code>&#8594;`custom-image-name` configuration element in the Spring Boot plugin.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="run-with-buildpacks"><a class="anchor" href="#run-with-buildpacks"></a><a class="link" href="#run-with-buildpacks">16.5.1. Run with Buildpacks</a></h4>
<div class="paragraph">
<p>To run the application, you can use <code>docker</code> the usual way as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">docker run --rm -p 8080:8080 spring-cloud-azure-sample:0.0.1-SNAPSHOT</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-with-native-build-tools"><a class="anchor" href="#run-with-native-build-tools"></a><a class="link" href="#run-with-native-build-tools">16.5.2. Run with Native Build Tools</a></h4>
<div class="paragraph">
<p>To run your application, use the following command:</p>
</div>
<div class="listingblock primary">
<div class="title">Build with Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">target\spring-cloud-azure-sample</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Build with Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">build\native\nativeCompile\spring-cloud-azure-sample</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-16"><a class="anchor" href="#samples-16"></a><a class="link" href="#samples-16">16.6. Samples</a></h3>
<div class="paragraph">
<p>For more information, see <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/spring-native/storage-blob-native">storage-blob-native</a> on GitHub.</p>
</div>
<div class="paragraph">
<p>Here are other verified samples that support Spring Native. For more information, see <a href="https://github.com/Azure-Samples/azure-spring-boot-samples#run-samples-based-on-spring-native">Spring Cloud Azure Samples</a> on GitHub.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 35. Supported Spring Cloud Azure Samples</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Library Artifact ID</th>
<th class="tableblock halign-left valign-top">Supported Example Projects</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-appconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/appconfiguration/spring-cloud-azure-starter-appconfiguration/appconfiguration-client">appconfiguration-client</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/eventhubs/spring-cloud-azure-starter-eventhubs/eventhubs-client">eventhubs-client</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/eventhubs/spring-cloud-azure-starter-integration-eventhubs/eventhubs-integration">eventhubs-integration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/storage/spring-cloud-azure-starter-integration-storage-queue/storage-queue-integration">storage-queue-integration</a>, <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/storage/spring-cloud-azure-starter-integration-storage-queue/storage-queue-operation">storage-queue-operation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault-secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/keyvault/spring-cloud-azure-starter-keyvault-secrets/property-source">property-source</a>, <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/keyvault/spring-cloud-azure-starter-keyvault-secrets/secret-client">secret-client</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/storage/spring-cloud-azure-starter-storage-blob/storage-blob-sample">storage-blob-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/storage/spring-cloud-azure-starter-storage-file-share/storage-file-sample">storage-file-sample</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/main/storage/spring-cloud-azure-starter-storage-queue/storage-queue-client">storage-queue-client</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mysql-support"><a class="anchor" href="#mysql-support"></a><a class="link" href="#mysql-support">17. MySQL support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://azure.microsoft.com/services/mysql/">Azure Database for MySQL</a> is a relational database service powered by the MySQL community edition. You can use either Single Server or Flexible Server to host a MySQL database in Azure. It&#8217;s a fully managed database-as-a-service offering that can handle mission-critical workloads with predictable performance and dynamic scalability.</p>
</div>
<div class="paragraph">
<p>From version 4.4.0, Spring Cloud Azure supports various types of credentials for authentication to <code>Azure Database for MySQL single server</code>.</p>
</div>
<div class="sect2">
<h3 id="supported-mysql-version"><a class="anchor" href="#supported-mysql-version"></a><a class="link" href="#supported-mysql-version">17.1. Supported MySQL version</a></h3>
<div class="paragraph">
<p>The current version of the starter should use Azure Database for MySQL Single Server version <code>5.7</code> or <code>8.0</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="core-features"><a class="anchor" href="#core-features"></a><a class="link" href="#core-features">17.2. Core Features</a></h3>
<div class="sect3">
<h4 id="passwordless-connection"><a class="anchor" href="#passwordless-connection"></a><a class="link" href="#passwordless-connection">17.2.1. Passwordless connection</a></h4>
<div class="paragraph">
<p>Passwordless connection is to connect to Azure services without storing any credentials in the application, no matter stored in the applications' configuration files or in the environment variables, and it uses Azure AD authentication. Azure AD authentication is a mechanism of connecting to Azure Database for MySQL using identities defined in Azure AD. With Azure AD authentication, you can manage database user identities and other Microsoft services in a central location, which simplifies permission management.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="how-it-works"><a class="anchor" href="#how-it-works"></a><a class="link" href="#how-it-works">17.3. How it works</a></h3>
<div class="paragraph">
<p>Spring Cloud Azure will first build one of the following types of credentials depending on the application authentication configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClientSecretCredential</code></p>
</li>
<li>
<p><code>ClientCertificateCredential</code></p>
</li>
<li>
<p><code>UsernamePasswordCredential</code></p>
</li>
<li>
<p><code>ManagedIdentityCredential</code></p>
</li>
<li>
<p><code>DefaultAzureCredential</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If none of these types of credentials are found, the <code>DefaultAzureCredential</code> credentials will be obtained from application properties, environment variables, managed identities, or the IDE. For detailed information, see the <a href="index.html#authentication">Spring Cloud Azure authentication</a> section.</p>
</div>
<div class="paragraph">
<p>The following high-level diagram summarizes how authentication works using OAuth credential authentication with Azure Database for MySQL. The arrows indicate communication pathways.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192254109-22341bfc-20a9-4fe5-bc62-92ed7b253343.png" alt="Diagram showing Azure Active Directory authentication for MySQL"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-13"><a class="anchor" href="#configuration-13"></a><a class="link" href="#configuration-13">17.4. Configuration</a></h3>
<div class="paragraph">
<p>Spring Cloud Azure for MySQL supports the following two levels of configuration options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The global authentication configuration options of <code>credential</code> and <code>profile</code> with prefixes of <code>spring.cloud.azure</code>.</p>
</li>
<li>
<p>Spring Cloud Azure for MySQL common configuration options.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following table shows the Spring Cloud Azure for MySQL common configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. Spring Cloud Azure for MySQL common configuration options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.passwordless-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable supporting Azure identity token credentials. The default value is <strong>false</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client ID to use when performing service principal authentication with Azure. This is a legacy property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure. This is a legacy property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity to authenticate with Azure. If <strong>true</strong> and the <code>client-id</code> is set, will use the client ID as user assigned managed identity client ID. The default value is <strong>false</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.credential.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.profile.cloud-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.profile.environment.active-directory-endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Active Directory endpoint to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.datasource.azure.profile.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant ID for Azure resources.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="dependency-setup-12"><a class="anchor" href="#dependency-setup-12"></a><a class="link" href="#dependency-setup-12">17.5. Dependency setup</a></h3>
<div class="paragraph">
<p>Add the following dependency to your project. This will automatically include the <code>spring-boot-starter</code> dependency in your project transitively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-jdbc-mysql&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember to add the BOM <code>spring-cloud-azure-dependencies</code> along with the above dependency. For more information, see the [Getting started](#getting-started) section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-12"><a class="anchor" href="#basic-usage-12"></a><a class="link" href="#basic-usage-12">17.6. Basic usage</a></h3>
<div class="paragraph">
<p>The following sections show the classic Spring Boot application usage scenarios.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Passwordless connection uses Azure AD authentication. To use Azure AD authentication, you should set the Azure AD admin user first. Only an Azure AD Admin user can create you enable users for Azure AD-based authentication. See the <a href="https://learn.microsoft.com/azure/developer/java/spring-framework/configure-spring-data-jdbc-with-azure-mysql?branch=release-cred-free-java&amp;tabs=passwordless#create-a-mysql-server-and-set-up-admin-user">Create a MySQL server and set up admin user</a> section.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="connect-to-azure-mysql-locally-without-password"><a class="anchor" href="#connect-to-azure-mysql-locally-without-password"></a><a class="link" href="#connect-to-azure-mysql-locally-without-password">17.6.1. Connect to Azure MySQL locally without password</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To create users and grant permission, see the <a href="https://learn.microsoft.com/azure/developer/java/spring-framework/configure-spring-data-jdbc-with-azure-mysql?branch=release-cred-free-java&amp;tabs=passwordless#create-a-mysql-non-admin-user-and-grant-permission">Create a MySQL non-admin user and grant permission</a> section to create users and grant permission.</p>
</li>
<li>
<p>Configure the following properties in your <strong>application.yml</strong>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  datasource:
    url: jdbc:mysql://${AZURE_MYSQL_SERVER_NAME}.mysql.database.azure.com:3306/${AZURE_MYSQL_DATABASE_NAME}
    username: ${AZURE_MYSQL_AD_NON_ADMIN_USERNAME}@${AZURE_MYSQL_SERVER_NAME}
    azure:
      passwordless-enabled: true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="connect-to-azure-mysql-using-a-service-principal"><a class="anchor" href="#connect-to-azure-mysql-using-a-service-principal"></a><a class="link" href="#connect-to-azure-mysql-using-a-service-principal">17.6.2. Connect to Azure MySQL using a service principal</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an Azure AD user for service principal and grant permission.</p>
<div class="paragraph">
<p>First, use the following commands to set up some environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MYSQL_AZURE_AD_SP_USERID=`az ad sp list --display-name &lt;service_principal-name&gt; --query '[0].appId' -otsv`
export AZURE_MYSQL_AZURE_AD_SP_USERNAME=&lt;YOUR_MYSQL_AZURE_AD_USERNAME&gt;
export AZURE_MYSQL_SERVER_NAME=&lt;YOUR_MYSQL_SERVER_NAME&gt;
export AZURE_MYSQL_DATABASE_NAME=&lt;YOUR_MYSQL_DATABASE_NAME&gt;
export CURRENT_USERNAME=$(az ad signed-in-user show --query userPrincipalName -o tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a SQL script called <strong>create_ad_user_sp.sql</strong> for creating a non-admin user. Add the following contents and save it locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">cat &lt;&lt; EOF &gt; create_ad_user_sp.sql
SET aad_auth_validate_oids_in_tenant = OFF;
CREATE AADUSER '$AZURE_MYSQL_AZURE_AD_SP_USERNAME' IDENTIFIED BY '$AZURE_MYSQL_AZURE_AD_SP_USERID';
GRANT ALL PRIVILEGES ON $AZURE_MYSQL_DATABASE_NAME.* TO '$AZURE_MYSQL_AZURE_AD_SP_USERNAME'@'%';
FLUSH privileges;
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the following command to run the SQL script to create the Azure AD non-admin user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">mysql -h $AZURE_MYSQL_SERVER_NAME.mysql.database.azure.com --user $CURRENT_USERNAME@$AZURE_MYSQL_SERVER_NAME --enable-cleartext-plugin --password=`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken` &lt; create_ad_user_sp.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use the following command to remove the temporary SQL script file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">rm create_ad_user_sp.sql</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the following properties in your <strong>application.yml</strong> file:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
  datasource:
    url: jdbc:mysql://${AZURE_MYSQL_SERVER_NAME}.mysql.database.azure.com:3306/${AZURE_MYSQL_DATABASE_NAME}
    username: ${AZURE_MYSQL_AD_SP_USERNAME}@${AZURE_MYSQL_SERVER_NAME}
    azure:
      passwordless-enabled: true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="connect-to-azure-mysql-with-managed-identity-in-azure-spring-apps"><a class="anchor" href="#connect-to-azure-mysql-with-managed-identity-in-azure-spring-apps"></a><a class="link" href="#connect-to-azure-mysql-with-managed-identity-in-azure-spring-apps">17.6.3. Connect to Azure MySQL with Managed Identity in Azure Spring Apps</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To enable managed identity, see the <a href="https://review.learn.microsoft.com/azure/developer/java/spring-framework/migrate-mysql-to-passwordless-connection?branch=release-cred-free-java&amp;tabs=sign-in-azure-cli%2Cjava%2Capp-service%2Capp-service-identity#create-the-managed-identity-using-the-azure-portal">Create the managed identity using the Azure Portal</a> section to enable managed identity.</p>
</li>
<li>
<p>To grant permissions, see the <a href="https://review.learn.microsoft.com/azure/developer/java/spring-framework/migrate-mysql-to-passwordless-connection?branch=release-cred-free-java&amp;tabs=sign-in-azure-cli%2Cjava%2Capp-service%2Capp-service-identity#assign-roles-to-the-managed-identity">Assign roles to the managed identity</a> section to grant permissions.</p>
</li>
<li>
<p>Configure the following properties in <code>application.yml</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  datasource:
    url: jdbc:mysql://${AZURE_MYSQL_SERVER_NAME}.mysql.database.azure.com:3306/${AZURE_MYSQL_DATABASE_NAME}
    username: ${AZURE_MYSQL_AD_MI_USERNAME}@${AZURE_MYSQL_SERVER_NAME}
    azure:
      passwordless-enabled: true</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrate-an-application-to-use-passwordless-connections-with-azure-database-for-mysql"><a class="anchor" href="#migrate-an-application-to-use-passwordless-connections-with-azure-database-for-mysql"></a><a class="link" href="#migrate-an-application-to-use-passwordless-connections-with-azure-database-for-mysql">17.7. Migrate an application to use passwordless connections with Azure Database for MySQL</a></h3>
<div class="paragraph">
<p>This tutorial explains how to migrate from traditional authentication methods to more secure, passwordless connections with Azure Database for MySQL.</p>
</div>
<div class="paragraph">
<p>Application requests to Azure Database for MySQL must be authenticated. Azure Database for MySQL provides several different ways for apps to connect securely. One of the ways is to use passwords. However, you should prioritize passwordless connections in your applications when possible.</p>
</div>
<div class="sect3">
<h4 id="compare-authentication-options"><a class="anchor" href="#compare-authentication-options"></a><a class="link" href="#compare-authentication-options">17.7.1. Compare authentication options</a></h4>
<div class="paragraph">
<p>When authenticating with Azure Database for MySQL, the application provides a username and password pair to connect to the database. Depending on where the identities are stored, there are two types of authentication: Azure Active Directory (Azure AD) authentication and MySQL authentication.</p>
</div>
<div class="sect4">
<h5 id="azure-ad-authentication"><a class="anchor" href="#azure-ad-authentication"></a><a class="link" href="#azure-ad-authentication">Azure AD authentication</a></h5>
<div class="paragraph">
<p>Microsoft Azure AD authentication is a mechanism for connecting to Azure Database for MySQL using identities defined in Azure AD. With Azure AD authentication, you can manage database user identities and other Microsoft services in a central location, which simplifies permission management.</p>
</div>
<div class="paragraph">
<p>Using Azure AD for authentication provides the following benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication of users across Azure Services in a uniform way.</p>
</li>
<li>
<p>Management of password policies and password rotation in a single place.</p>
</li>
<li>
<p>Multiple forms of authentication supported by Azure AD, which can eliminate the need to store passwords.</p>
</li>
<li>
<p>Customers can manage database permissions using external (Azure AD) groups.</p>
</li>
<li>
<p>Azure AD authentication uses MySQL database users to authenticate identities at the database level.</p>
</li>
<li>
<p>Support of token-based authentication for applications connecting to Azure Database for MySQL.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mysql-authentication"><a class="anchor" href="#mysql-authentication"></a><a class="link" href="#mysql-authentication">MySQL authentication</a></h5>
<div class="paragraph">
<p>You can create accounts in MySQL. If you choose to use passwords as credentials for the accounts, these credentials will be stored in the <code>user</code> table. Because these passwords are stored in MySQL, you&#8217;ll need to manage the rotation of the passwords by yourself.</p>
</div>
<div class="paragraph">
<p>Although it&#8217;s possible to connect to Azure Database for MySQL with passwords, you should use them with caution. You must be diligent to never expose the passwords in an unsecure location. Anyone who gains access to the passwords is able to authenticate. For example, if a password is accidentally checked into source control, sent through an unsecure email, pasted into the wrong chat, or viewed by someone who shouldn&#8217;t have permission, there&#8217;s risk of a malicious user accessing the application. Instead, consider updating your application to use passwordless connections.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introducing-passwordless-connections"><a class="anchor" href="#introducing-passwordless-connections"></a><a class="link" href="#introducing-passwordless-connections">17.7.2. Introducing passwordless connections</a></h4>
<div class="paragraph">
<p>With a passwordless connection, you can connect to Azure services without storing any credentials in the application, its configuration files, or in environment variables.</p>
</div>
<div class="paragraph">
<p>To ensure that connections are passwordless, you must take into consideration both local development and the production environment. If a password is required in either place, then the application is not passwordless.</p>
</div>
<div class="paragraph">
<p>In your local development environment, you can authenticate with Azure CLI, Azure Powershell, Visual Studio, or Azure plugins for Visual Studio Code or IntelliJ. In this case, you can use that credential in your application instead of configuring properties.</p>
</div>
<div class="paragraph">
<p>When you deploy applications to an Azure hosting environment, such as a virtual machine, you can enable managed identity in that environment. Then, you won&#8217;t need to provide credentials to connect to Azure services.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A managed identity provides a security identity to represent an app or service. The identity is managed by the Azure platform and does not require you to provision or rotate any secrets. For more information, see <a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="migrate-an-existing-application-to-use-passwordless-connections"><a class="anchor" href="#migrate-an-existing-application-to-use-passwordless-connections"></a><a class="link" href="#migrate-an-existing-application-to-use-passwordless-connections">17.7.3. Migrate an existing application to use passwordless connections</a></h4>
<div class="paragraph">
<p>The following steps explain how to migrate an existing application to use passwordless connections instead of a password-based solution.</p>
</div>
<div class="sect4">
<h5 id="prepare-the-working-environment"><a class="anchor" href="#prepare-the-working-environment"></a><a class="link" href="#prepare-the-working-environment">Prepare the working environment</a></h5>
<div class="paragraph">
<p>First, use the following command to set up some environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZ_RESOURCE_GROUP=&lt;YOUR_RESOURCE_GROUP&gt;
export AZ_DATABASE_SERVER_NAME=&lt;YOUR_DATABASE_SERVER_NAME&gt;
export AZ_DATABASE_NAME=demo
export AZ_MYSQL_AD_NON_ADMIN_USERNAME=&lt;YOUR_AZURE_AD_NON_ADMIN_USER_DISPLAY_NAME&gt;
export AZ_MYSQL_AD_MI_USERNAME=&lt;YOUR_AZURE_AD_MI_DISPLAY_NAME&gt;
export AZ_LOCAL_IP_ADDRESS=&lt;YOUR_LOCAL_IP_ADDRESS&gt;
export CURRENT_USERNAME=$(az ad signed-in-user show --query userPrincipalName --output tsv)
export CURRENT_USER_OBJECTID=$(az ad signed-in-user show --query id --output tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the placeholders with the following values, which are used throughout this article:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;YOUR_RESOURCE_GROUP&gt;</code>: The name of the resource group your resources in.</p>
</li>
<li>
<p><code>&lt;YOUR_DATABASE_SERVER_NAME&gt;</code>: The name of your MySQL server. It should be unique across Azure.</p>
</li>
<li>
<p><code>&lt;YOUR_AZURE_AD_NON_ADMIN_USER_DISPLAY_NAME&gt;</code>: The display name of your Azure AD non-admin user. Make sure the name is a valid user in your Azure AD tenant.</p>
</li>
<li>
<p><code>&lt;YOUR_AZURE_AD_MI_DISPLAY_NAME&gt;</code>: The display name of Azure AD user for your managed identity. Make sure the name is a valid user in your Azure AD tenant.</p>
</li>
<li>
<p><code>&lt;YOUR_LOCAL_IP_ADDRESS&gt;</code>: The IP address of your local computer, from which you&#8217;ll run your Spring Boot application. One convenient way to find it is to open <a href="http://whatismyip.akamai.com">whatismyip.akamai.com</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="configure-azure-database-for-mysql"><a class="anchor" href="#configure-azure-database-for-mysql"></a><a class="link" href="#configure-azure-database-for-mysql">Configure Azure Database for MySQL</a></h5>
<div class="sect5">
<h6 id="enable-azure-ad-based-authentication"><a class="anchor" href="#enable-azure-ad-based-authentication"></a><a class="link" href="#enable-azure-ad-based-authentication">Enable Azure AD-based authentication</a></h6>
<div class="paragraph">
<p>To use Azure Active Directory access with Azure Database for MySQL, you should set the Azure AD admin user first. Only an Azure AD Admin user can create/enable users for Azure AD-based authentication.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using Azure CLI, run the following command to make sure it has sufficient permission:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az login --scope https://graph.microsoft.com/.default</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, run following command to set the Azure AD admin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az mysql server ad-admin create \
    --resource-group $AZ_RESOURCE_GROUP \
    --server-name $AZ_DATABASE_SERVER_NAME \
    --display-name $CURRENT_USERNAME \
    --object-id $CURRENT_USER_OBJECTID</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will set the Azure AD admin to the current signed-in user.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can only create one Azure AD admin per MySQL server. Selection of another one will overwrite the existing Azure AD admin configured for the server.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-azure-database-for-mysql-for-local-development"><a class="anchor" href="#configure-azure-database-for-mysql-for-local-development"></a><a class="link" href="#configure-azure-database-for-mysql-for-local-development">Configure Azure Database for MySQL for local development</a></h5>
<div class="sect5">
<h6 id="configure-a-firewall-rule-for-local-ip"><a class="anchor" href="#configure-a-firewall-rule-for-local-ip"></a><a class="link" href="#configure-a-firewall-rule-for-local-ip">Configure a firewall rule for local IP</a></h6>
<div class="paragraph">
<p>Azure Database for MySQL instances are secured by default. These instances have a firewall that doesn&#8217;t allow any incoming connection. To be able to use your database, you need to add a firewall rule that will allow the local IP address to access the database server.</p>
</div>
<div class="paragraph">
<p>Because you configured your local IP address at the beginning of this article, you can open the server&#8217;s firewall by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az mysql server firewall-rule create \
    --resource-group $AZ_RESOURCE_GROUP \
    --name $AZ_DATABASE_SERVER_NAME-database-allow-local-ip \
    --server $AZ_DATABASE_SERVER_NAME \
    --start-ip-address $AZ_LOCAL_IP_ADDRESS \
    --end-ip-address $AZ_LOCAL_IP_ADDRESS \
    --output tsv</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re connecting to your MySQL server from Windows Subsystem for Linux (WSL) on a Windows computer, you&#8217;ll need to add the WSL host ID to your firewall.</p>
</div>
<div class="paragraph">
<p>Obtain the IP address of your host machine by running the following command in WSL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">cat /etc/resolv.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the IP address following the term <code>nameserver</code>, then use the following command to set an environment variable for the WSL IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_WSL_IP_ADDRESS=&lt;the-copied-IP-address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following command to open the server&#8217;s firewall to your WSL-based app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az mysql server firewall-rule create \
    --resource-group $AZ_RESOURCE_GROUP \
    --name $AZ_DATABASE_SERVER_NAME-database-allow-local-ip-wsl \
    --server $AZ_DATABASE_SERVER_NAME \
    --start-ip-address $AZ_WSL_IP_ADDRESS \
    --end-ip-address $AZ_WSL_IP_ADDRESS \
    --output tsv</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="create-a-mysql-non-admin-user-and-grant-permission"><a class="anchor" href="#create-a-mysql-non-admin-user-and-grant-permission"></a><a class="link" href="#create-a-mysql-non-admin-user-and-grant-permission">Create a MySQL non-admin user and grant permission</a></h6>
<div class="paragraph">
<p>Next, create a non-admin Azure AD user and grant all permissions on the <code>$AZ_DATABASE_NAME</code> database to it. You can change the database name <code>$AZ_DATABASE_NAME</code> to fit your needs.</p>
</div>
<div class="paragraph">
<p>Create a SQL script called <strong>create_ad_user.sql</strong> for creating a non-admin user. Add the following contents and save it locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MYSQL_AD_NON_ADMIN_USERID=`az ad signed-in-user show --query id --output tsv`

cat &lt;&lt; EOF &gt; create_ad_user.sql
SET aad_auth_validate_oids_in_tenant = OFF;
CREATE AADUSER '$AZ_MYSQL_AD_NON_ADMIN_USERNAME' IDENTIFIED BY '$AZ_MYSQL_AD_NON_ADMIN_USERID';
GRANT ALL PRIVILEGES ON $AZ_DATABASE_NAME.* TO '$AZ_MYSQL_AD_NON_ADMIN_USERNAME'@'%';
FLUSH privileges;
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following command to run the SQL script to create the Azure AD non-admin user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">mysql -h $AZ_DATABASE_SERVER_NAME.mysql.database.azure.com --user $CURRENT_USERNAME@$AZ_DATABASE_SERVER_NAME --enable-cleartext-plugin --password=`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken` &lt; create_ad_user.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use the following command to remove the temporary SQL script file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">rm create_ad_user.sql</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can read more detailed information about creating MySQL users in <a href="https://learn.microsoft.com/azure/mysql/single-server/how-to-create-users">Create users in Azure Database for MySQL</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sign-in-and-migrate-the-app-code-to-use-passwordless-connections"><a class="anchor" href="#sign-in-and-migrate-the-app-code-to-use-passwordless-connections"></a><a class="link" href="#sign-in-and-migrate-the-app-code-to-use-passwordless-connections">Sign in and migrate the app code to use passwordless connections</a></h5>
<div class="paragraph">
<p>For local development, make sure you&#8217;re authenticated with the same Azure AD account you assigned the role to on your MySQL. You can authenticate via the Azure CLI, Visual Studio, Azure PowerShell, or other tools such as IntelliJ.</p>
</div>
<div class="sect5">
<h6 id="azure-cli"><a class="anchor" href="#azure-cli"></a><a class="link" href="#azure-cli">Azure CLI</a></h6>
<div class="paragraph">
<p>Sign in to Azure through the Azure CLI by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az login</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="visual-studio"><a class="anchor" href="#visual-studio"></a><a class="link" href="#visual-studio">Visual Studio</a></h6>
<div class="paragraph">
<p>Select the <strong>Sign in</strong> button in the top right corner of Visual Studio.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256552-ebbe8e0f-1bdb-404e-91e9-b70dd0ae9add.png" alt="visual-studio"></span></p>
</div>
<div class="paragraph">
<p>Sign in using the Azure AD account you assigned a role to previously.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256652-0ae061e6-710f-4526-b8a5-77bb61d1a43a.png" alt="visual-studio-sgin"></span></p>
</div>
</div>
<div class="sect5">
<h6 id="visual-studio-code"><a class="anchor" href="#visual-studio-code"></a><a class="link" href="#visual-studio-code">Visual Studio Code</a></h6>
<div class="paragraph">
<p>Make sure you have the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account">Azure Account</a> extension installed.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256734-14715d5c-ff8e-4651-bd65-006591f4b148.png" alt="Screenshot showing the Azure extension"></span></p>
</div>
<div class="paragraph">
<p>Use the <strong>CTRL + Shift + P</strong> shortcut to open the command palette. Search for the <strong>Azure: Sign In</strong> command and follow the prompts to authenticate. Make sure to use the Azure AD account you assigned a role to previously from your Blob Storage account.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256807-2b41033e-bbc5-4459-9b10-22f1e5141747.png" alt="Screenshot showing the Azure sign-in command"></span></p>
</div>
</div>
<div class="sect5">
<h6 id="powershell"><a class="anchor" href="#powershell"></a><a class="link" href="#powershell">PowerShell</a></h6>
<div class="paragraph">
<p>Sign in to Azure using PowerShell by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">Connect-AzAccount</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, use the following steps to update your code to use passwordless connections. Although conceptually similar, each language uses different implementation details.</p>
</div>
</div>
<div class="sect5">
<h6 id="java"><a class="anchor" href="#java"></a><a class="link" href="#java">Java</a></h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inside your project, add the following reference to the <code>azure-identity-providers-jdbc-mysql</code> package. This library contains all of the necessary entities to implement passwordless connections.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">   &lt;dependency&gt;
       &lt;groupId&gt;com.azure&lt;/groupId&gt;
       &lt;artifactId&gt;azure-identity-providers-jdbc-mysql&lt;/artifactId&gt;
       &lt;version&gt;1.0.0-beta.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Enable the Azure MySQL authentication plugin in the JDBC URL. Identify the locations in your code that currently create a <code>java.sql.Connection</code> to connect to Azure Database for MySQL. Update <code>url</code> and <code>user</code> in your <strong>application.properties</strong> file to match the following values:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">   url=jdbc:mysql://$AZ_DATABASE_SERVER_NAME.mysql.database.azure.com:3306/$AZ_DATABASE_NAME?serverTimezone=UTC&amp;sslMode=REQUIRED&amp;defaultAuthenticationPlugin=com.azure.identity.providers.mysql.AzureIdentityMysqlAuthenticationPlugin&amp;authenticationPlugins=com.azure.identity.providers.mysql.AzureIdentityMysqlAuthenticationPlugin
   user=$AZ_MYSQL_AD_NON_ADMIN_USERNAME@$AZ_DATABASE_SERVER_NAME</code></pre>
</div>
</div>
</li>
<li>
<p>Replace the two <code>$AZ_DATABASE_SERVER_NAME</code> variables and one <code>$AZ_MYSQL_AD_NON_ADMIN_USERNAME</code> variable with the values that you configured at the beginning of this article.</p>
</li>
<li>
<p>Remove the <code>password</code> from the JDBC URL.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="spring"><a class="anchor" href="#spring"></a><a class="link" href="#spring">Spring</a></h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inside your project, add the following reference to the <code>spring-cloud-azure-starter-jdbc-mysql</code> package. This library contains all of the necessary entities to implement passwordless connections.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">   &lt;dependency&gt;
       &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
       &lt;artifactId&gt;spring-cloud-azure-starter-jdbc-mysql&lt;/artifactId&gt;
       &lt;version&gt;4.4.0-beta.1&lt;/version&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Update the <strong>application.yaml</strong> or <strong>application.properties</strong> file as shown in the following example. Change the <code>spring.datasource.username</code> to the Azure AD user, remove the <code>spring.datasource.password</code> property, and add <code>spring.datasource.azure.passwordless-enabled=true</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
 datasource:
   url: jdbc:mysql://${AZ_DATABASE_SERVER_NAME}.mysql.database.azure.com:3306/${AZ_DATABASE_NAME}?serverTimezone=UTC
   username: ${AZ_MYSQL_AD_NON_ADMIN_USERNAME}@${AZ_DATABASE_SERVER_NAME}
   azure:
     passwordless-enabled: true</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="run-the-app-locally"><a class="anchor" href="#run-the-app-locally"></a><a class="link" href="#run-the-app-locally">Run the app locally</a></h6>
<div class="paragraph">
<p>After making these code changes, run your application locally. The new configuration should pick up your local credentials if you&#8217;re signed in to a compatible IDE or command line tool, such as the Azure CLI, Visual Studio, or IntelliJ. The roles you assigned to your local dev user in Azure will allow your app to connect to the Azure service locally.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-the-azure-hosting-environment"><a class="anchor" href="#configure-the-azure-hosting-environment"></a><a class="link" href="#configure-the-azure-hosting-environment">Configure the Azure hosting environment</a></h5>
<div class="paragraph">
<p>Once your application is configured to use passwordless connections and it runs locally, the same code can authenticate to Azure services after it&#8217;s deployed to Azure. For example, an application deployed to an Azure App Service instance that has a managed identity enabled can connect to Azure Storage.</p>
</div>
<div class="sect5">
<h6 id="create-the-managed-identity-using-the-azure-portal"><a class="anchor" href="#create-the-managed-identity-using-the-azure-portal"></a><a class="link" href="#create-the-managed-identity-using-the-azure-portal">Create the managed identity using the Azure portal</a></h6>
<div class="paragraph">
<p>The following steps show you how to create a system-assigned managed identity for various web hosting services. The managed identity can securely connect to other Azure Services using the app configurations you set up previously.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure App Service</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure App Service instance, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>On the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256885-b374e965-682f-47b8-a4d7-d227a01446c7.png" alt="Screenshot of Azure portal Identity page of App Service resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure App Service instance with the <a href="https://learn.microsoft.com/cli/azure/webapp/identity">az webapp identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MI_OBJECT_ID=`az webapp identity assign --resource-group $AZ_RESOURCE_GROUP --name &lt;service-instance-name&gt;  --query principalId --output tsv`</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Container Apps</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure Container Apps instance, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>On the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192256985-d3bc1029-7b37-4426-b618-7eba9388e59d.png" alt="Screenshot of Azure portal Identity page of Container App resource showing System assigned tab with Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure Container Apps instance with the <a href="https://learn.microsoft.com/cli/azure/containerapp/identity">az containerapp identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MI_OBJECT_ID=`az containerapp identity assign --resource-group $AZ_RESOURCE_GROUP --name &lt;service-instance-name&gt; --query principalId --output tsv`</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Spring Apps</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure Spring Apps instance, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>On the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192257073-90a09aa6-396e-43f8-98fc-1a7d4eb37ac3.png" alt="Screenshot of Azure portal Identity page of App resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure Spring Apps instance with the <a href="https://learn.microsoft.com/cli/azure/spring/app/identity">az spring app identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MI_OBJECT_ID=`az spring app identity assign --resource-group $AZ_RESOURCE_GROUP --name &lt;service-instance-name&gt; --service &lt;service-name&gt; --query identity.principalId --output tsv`</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure virtual machines</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your virtual machine, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>On the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192257152-801de5cb-7d5a-46fb-9580-cf024537cd9d.png" alt="Screenshot of Azure portal Identity page of Virtual machine resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to a Virtual Machine with the <a href="https://learn.microsoft.com/cli/azure/vm/identity">az vm identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MI_OBJECT_ID=`az vm identity assign --resource-group $AZ_RESOURCE_GROUP --name &lt;service-instance-name&gt; --query principalId --output tsv`</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Kubernetes Service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can assign a managed identity to an Azure Kubernetes Service instance with the <a href="https://learn.microsoft.com/cli/azure/aks">az aks update</a> command, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MI_OBJECT_ID=`az aks update --resource-group $AZ_RESOURCE_GROUP --name &lt;AKS-cluster-name&gt; --enable-managed-identity --query identityProfile.kubeletidentity.objectId --output tsv`</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="assign-roles-to-the-managed-identity"><a class="anchor" href="#assign-roles-to-the-managed-identity"></a><a class="link" href="#assign-roles-to-the-managed-identity">Assign roles to the managed identity</a></h6>
<div class="paragraph">
<p>Next, grant permissions to the managed identity you created to access your MySQL instance.</p>
</div>
<div class="paragraph">
<p>These steps will create an Azure AD user for the managed identity and grant all permissions for the database <code>$AZ_DATABASE_NAME</code> to it. You can change the database name <code>$AZ_DATABASE_NAME</code> to fit your needs.</p>
</div>
<div class="paragraph">
<p>First, create a SQL script called <strong>create_ad_user.sql</strong> for creating a non-admin user. Add the following contents and save it locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">AZ_MYSQL_AD_MI_USERID=`az ad sp show --id $AZ_MI_OBJECT_ID --query appId --output tsv`

cat &lt;&lt; EOF &gt; create_ad_user.sql
SET aad_auth_validate_oids_in_tenant = OFF;
CREATE AADUSER '$AZ_MYSQL_AD_MI_USERNAME' IDENTIFIED BY '$AZ_MYSQL_AD_MI_USERID';
GRANT ALL PRIVILEGES ON $AZ_DATABASE_NAME.* TO '$AZ_MYSQL_AD_MI_USERNAME'@'%';
FLUSH privileges;
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the following command to run the SQL script to create the Azure AD non-admin user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">mysql -h $AZ_DATABASE_SERVER_NAME.mysql.database.azure.com --user $CURRENT_USERNAME@$AZ_DATABASE_SERVER_NAME --enable-cleartext-plugin --password=`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken` &lt; create_ad_user.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use the following command to remove the temporary SQL script file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">rm create_ad_user.sql</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="test-the-app"><a class="anchor" href="#test-the-app"></a><a class="link" href="#test-the-app">Test the app</a></h6>
<div class="paragraph">
<p>Before deploying the app to the hosting environment, you need to make one more change to the code because the application is going to connect to MySQL using the user created for the managed identity.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Update your code to use the user created for the managed identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">properties.put("user", "$AZ_MYSQL_AD_MI_USERNAME@$AZ_DATABASE_SERVER_NAME");</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Update the <strong>application.yaml</strong> or <strong>application.properties</strong> file. Change the <code>spring.datasource.username</code> to the user created for the managed identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  datasource:
    url: jdbc:mysql://${AZ_DATABASE_SERVER_NAME}.mysql.database.azure.com:3306/${AZ_DATABASE_NAME}?serverTimezone=UTC
    username: ${AZ_MYSQL_AD_MI_USERNAME}@${AZ_DATABASE_SERVER_NAME}
    azure:
      passwordless-enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>After making these code changes, you can build and redeploy the application. Then, browse to your hosted application in the browser. Your app should be able to connect to the MySQL database successfully. Keep in mind that it may take several minutes for the role assignments to propagate through your Azure environment. Your application is now configured to run both locally and in a production environment without the developers having to manage secrets in the application itself.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka-support"><a class="anchor" href="#kafka-support"></a><a class="link" href="#kafka-support">18. Kafka Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>From version 4.3.0, Spring Cloud Azure for Kafka supports various types of credentials to authenticate and connect to Azure Event Hubs.</p>
</div>
<div class="sect2">
<h3 id="supported-kafka-version"><a class="anchor" href="#supported-kafka-version"></a><a class="link" href="#supported-kafka-version">18.1. Supported Kafka version</a></h3>
<div class="paragraph">
<p>The current version of the starter should be compatible with Apache Kafka Clients 2.0.0 using Java 8 or above.</p>
</div>
</div>
<div class="sect2">
<h3 id="supported-authentication-types"><a class="anchor" href="#supported-authentication-types"></a><a class="link" href="#supported-authentication-types">18.2. Supported authentication types</a></h3>
<div class="paragraph">
<p>The following authentication types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plain connection string authentication</p>
<div class="ulist">
<ul>
<li>
<p>Direct connection string authentication</p>
</li>
<li>
<p>ARM-based connection string authentication</p>
</li>
</ul>
</div>
</li>
<li>
<p>OAuth credential authentication</p>
<div class="ulist">
<ul>
<li>
<p>Managed identity authentication</p>
</li>
<li>
<p>Username/password authentication</p>
</li>
<li>
<p>Service principal authentication</p>
</li>
<li>
<p>DefautlAzureCredential authentication</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="how-it-works-2"><a class="anchor" href="#how-it-works-2"></a><a class="link" href="#how-it-works-2">18.3. How it works</a></h3>
<div class="sect3">
<h4 id="oauth-credential-authentication"><a class="anchor" href="#oauth-credential-authentication"></a><a class="link" href="#oauth-credential-authentication">18.3.1. OAuth credential authentication</a></h4>
<div class="paragraph">
<p>This section describes the overall workflow of Spring Cloud Azure OAuth authentication.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Azure will first build one of the following types of credentials depending on the application authentication configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClientSecretCredential</code></p>
</li>
<li>
<p><code>ClientCertificateCredential</code></p>
</li>
<li>
<p><code>UsernamePasswordCredential</code></p>
</li>
<li>
<p><code>ManagedIdentityCredential</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If none of these types of credentials are found, the credential chain via <code>DefaultAzureTokenCredential</code> will be used to obtain credentials from application properties, environment variables, managed identity, or IDEs. For detailed information, see the <a href="index.html#authentication">Authentication</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="plain-connection-string-authentication"><a class="anchor" href="#plain-connection-string-authentication"></a><a class="link" href="#plain-connection-string-authentication">18.3.2. Plain connection string authentication</a></h4>
<div class="paragraph">
<p>For the connection string authentication mode, you can use connection string authentication directly or use the Azure Resource Manager to retrieve the connection string. For more information about the usage, see the <a href="#basic-usage-connection-string">Basic usage for connection string authentication</a> section.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since version of 4.3.0, connection string authentication is deprecated in favor of OAuth authentications.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-14"><a class="anchor" href="#configuration-14"></a><a class="link" href="#configuration-14">18.4. Configuration</a></h3>
<div class="sect3">
<h4 id="configurable-properties-when-using-kafka-support-with-oauth-authentication"><a class="anchor" href="#configurable-properties-when-using-kafka-support-with-oauth-authentication"></a><a class="link" href="#configurable-properties-when-using-kafka-support-with-oauth-authentication">18.4.1. Configurable properties when using Kafka support with OAuth authentication</a></h4>
<div class="paragraph">
<p>Spring Cloud Azure for Kafka supports the following two levels of configuration options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Spring Cloud Azure for Event Hubs Kafka properties.</p>
</li>
<li>
<p>The global authentication configuration options of <code>credential</code> and <code>profile</code> with prefixes of <code>spring.cloud.azure</code>.</p>
</li>
<li>
<p>Kafka-specific level configurations. The Kafka-level configurations are also available for Spring Boot and Spring Cloud Stream binders for <code>common</code>, <code>consumer</code>, <code>producer</code>, or <code>admin</code> scopes, which have different prefixes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The global properties are exposed via <code>com.azure.spring.cloud.autoconfigure.context.AzureGlobalProperties</code>. The Kafka-specific properties are exposed via <code>org.springframework.boot.autoconfigure.kafka.KafkaProperties</code> (Spring Boot) and <code>org.springframework.cloud.stream.binder.kafka.properties.KafkaBinderConfigurationProperties</code> (Spring Cloud Stream binder).</p>
</div>
<div class="paragraph">
<p>The following list shows all supported configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Spring Cloud Azure global authentication configuration options</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.cloud.azure</code></p>
</li>
<li>
<p>Supported options: <code>spring.cloud.azure.credential.<strong></code>, <code>spring.cloud.azure.profile.</strong></code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the full list of global configuration options, see the <a href="appendix.html#global_proeprties">Global properties</a> section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Boot Kafka common configuration</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.kafka.properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.kafka.properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Kafka consumer configuration options</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.kafka.consumer.properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.kafka.consumer.properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Kafka producer configuration options</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.kafka.producer.properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.kafka.producer.properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Kafka admin configuration options</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.kafka.admin.properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.kafka.admin.properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Cloud Stream Kafka Binder common configuration</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.cloud.stream.kafka.binder.configuration.azure</code></p>
</li>
<li>
<p>Example: <code>spring.cloud.stream.kafka.binder.configuration.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Cloud Stream Kafka Binder consumer configuration</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.cloud.stream.kafka.binder.consumer-properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.cloud.stream.kafka.binder.consumer-properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Cloud Stream Kafka Binder producer configuration</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: <code>spring.cloud.stream.kafka.binder.producer-properties.azure</code></p>
</li>
<li>
<p>Example: <code>spring.cloud.stream.kafka.binder.producer-properties.azure</code>.credential.*</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Cloud Stream Kafka Binder admin configuration</p>
<div class="ulist">
<ul>
<li>
<p>Prefix: Not supported, should use Spring Boot Kafka common or admin configuration.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Spring Boot Kafka common configuration options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client ID to use when performing service principal authentication with Azure. This is a legacy property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure. This is a legacy property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity to authenticate with Azure. If <strong>true</strong> and the <code>client-id</code> is set, will use the client ID as user assigned managed identity client ID. The default value is <strong>false</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.credential.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.profile.environment.active-directory-endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Active Directory endpoint to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.kafka.properties.azure.profile.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant ID for Azure resources.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The configuration options in different levels apply the following rules. The more specific configuration options have higher priority than the common ones. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Kafka common configuration options supersede the global options.</p>
</li>
<li>
<p>Spring Kafka consumer configuration options supersede the common options.</p>
</li>
<li>
<p>Spring Kafka producer configuration options supersede the common options.</p>
</li>
<li>
<p>Spring Kafka admin configuration options supersede the common options.</p>
</li>
<li>
<p>The Spring Cloud Stream Kafka Binder options are just like the above.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configurable-properties-when-using-kafka-support-with-plain-connection-string-authentication"><a class="anchor" href="#configurable-properties-when-using-kafka-support-with-plain-connection-string-authentication"></a><a class="link" href="#configurable-properties-when-using-kafka-support-with-plain-connection-string-authentication">18.4.2. Configurable properties when using Kafka support with plain connection string authentication</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Spring Boot Event Hubs for Kafka common configuration options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.kafka.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Azure Event Hubs Kafka support. The default value is <strong>true</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs connection string. Provide this value when you want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs namespace. Provide this value when you want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Event Hubs namespace. Provide this value when you want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription ID. Provide this value when you want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="dependency-setup-13"><a class="anchor" href="#dependency-setup-13"></a><a class="link" href="#dependency-setup-13">18.5. Dependency Setup</a></h3>
<div class="paragraph">
<p>Add the following dependency to your project. This will automatically include the <code>spring-boot-starter</code> dependency in your project transitively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember to add the BOM <code>spring-cloud-azure-dependencies</code> along with the above dependency. For details, see the <a href="index.html#starter-dependencies">Getting started</a> section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-13"><a class="anchor" href="#basic-usage-13"></a><a class="link" href="#basic-usage-13">18.6. Basic usage</a></h3>
<div class="paragraph">
<p>The following sections show the classic Spring Boot application usage scenarios.</p>
</div>
<div class="sect3">
<h4 id="use-oauth-authentication"><a class="anchor" href="#use-oauth-authentication"></a><a class="link" href="#use-oauth-authentication">18.6.1. Use OAuth authentication</a></h4>
<div class="paragraph">
<p>When you use the OAuth authentication provided by Spring Cloud Azure for Kafka, you can configure the specific credentials using the above configurations. Alternatively, you can choose to configure nothing about credentials, in which case Spring Cloud Azure will load the credentials from the environment. This section describes the usages that load the credentials from the Azure CLI environment or the Azure Spring Apps hosting environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see the <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure Active Directory</a> section to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following section describes the scenarios using different Spring ecosystem libraries with OAuth authentication.</p>
</div>
<div class="sect4">
<h5 id="spring-kafka-application-support"><a class="anchor" href="#spring-kafka-application-support"></a><a class="link" href="#spring-kafka-application-support">Spring Kafka application support</a></h5>
<div class="paragraph">
<p>This section describes the usage scenario for Spring Boot application using Spring Kafka or Spring Integration Kafka library.</p>
</div>
<div class="sect5">
<h6 id="dependency-setup-14"><a class="anchor" href="#dependency-setup-14"></a><a class="link" href="#dependency-setup-14">Dependency setup</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Using Spring Kafka library only--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
    &lt;version&gt;{version}&lt;/version&gt;&lt;!--Need to be set, for example:2.8.6--&gt;
&lt;/dependency&gt;
&lt;!-- Using Spring Integration library only --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
    &lt;artifactId&gt;spring-integration-kafka&lt;/artifactId&gt;
    &lt;version&gt;{version}&lt;/version&gt;&lt;!--Need to be set, for example:5.5.12--&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="spring-kafka-configuraiton-setup"><a class="anchor" href="#spring-kafka-configuraiton-setup"></a><a class="link" href="#spring-kafka-configuraiton-setup">Configuration update</a></h6>
<div class="paragraph">
<p>To use the OAuth authentication, just specify the Event Hubs endpoint, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.kafka.bootstrap-servers=&lt;NAMESPACENAME&gt;.servicebus.windows.net:9093</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="spring-cloud-stream-binder-kafka-application-support"><a class="anchor" href="#spring-cloud-stream-binder-kafka-application-support"></a><a class="link" href="#spring-cloud-stream-binder-kafka-application-support">Spring Cloud Stream binder Kafka application support</a></h5>
<div class="paragraph">
<p>This section describes the usage scenario for Spring Boot applications using the Spring Cloud Stream binder Kafka library.</p>
</div>
<div class="sect5">
<h6 id="dependency-setup-15"><a class="anchor" href="#dependency-setup-15"></a><a class="link" href="#dependency-setup-15">Dependency setup</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-stream-kafka&lt;/artifactId&gt;
    &lt;version&gt;{version}&lt;/version&gt;&lt;!--Need to be set, for example:3.2.3--&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configuration-15"><a class="anchor" href="#configuration-15"></a><a class="link" href="#configuration-15">Configuration</a></h6>
<div class="paragraph">
<p>To use the OAuth authentication, just specify the Event Hubs endpoint and <code>com.azure.spring.cloud.autoconfigure.kafka.AzureKafkaSpringCloudStreamConfiguration</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.stream.kafka.binder.brokers=&lt;NAMESPACENAME&gt;.servicebus.windows.net:9093
spring.cloud.stream.binders.kafka.environment.spring.main.sources=com.azure.spring.cloud.autoconfigure.kafka.AzureKafkaSpringCloudStreamConfiguration</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re using version <code>4.3.0</code>, don&#8217;t forget to set the <code>spring.cloud.stream.binders.&lt;kafka-binder-name&gt;.environment.spring.main.sources=com.azure.spring.cloud.autoconfigure.kafka.AzureKafkaSpringCloudStreamConfiguration</code> property to enable the whole OAuth authentication workflow, where <code>kafka-binder-name</code> is <code>kafka</code> by default in a single Kafka binder application. The configuration <code>AzureKafkaSpringCloudStreamConfiguration</code> specifies the OAuth security parameters for <code>KafkaBinderConfigurationProperties</code>, which is used in <code>KafkaOAuth2AuthenticateCallbackHandler</code> to enable Azure Identity. For version after <code>4.4.0</code>, this property will be added automatically for each Kafka binder environment, so there&#8217;s no need for you to add it manually.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="samples-17"><a class="anchor" href="#samples-17"></a><a class="link" href="#samples-17">Samples</a></h6>
<div class="paragraph">
<p>See the <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> repository on GitHub.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-connection-string"><a class="anchor" href="#basic-usage-connection-string"></a><a class="link" href="#basic-usage-connection-string">18.6.2. Use connection string authentication</a></h4>
<div class="paragraph">
<p>You can use connection string authentication directly or use the Azure Resource Manager to retrieve the connection string.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since version of 4.3.0, connection string authentication is deprecated in favor of OAuth authentications.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="dependency-setup-16"><a class="anchor" href="#dependency-setup-16"></a><a class="link" href="#dependency-setup-16">Dependency setup</a></h5>
<div class="paragraph">
<p>Add the following dependencies if you want to migrate your Apache Kafka application to use Azure Event Hubs for Kafka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to retrieve the connection string using Azure Resource Manager, add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuration-16"><a class="anchor" href="#configuration-16"></a><a class="link" href="#configuration-16">Configuration</a></h5>
<div class="sect5">
<h6 id="use-event-hubs-connection-string-directly"><a class="anchor" href="#use-event-hubs-connection-string-directly"></a><a class="link" href="#use-event-hubs-connection-string-directly">Use Event Hubs connection string directly</a></h6>
<div class="paragraph">
<p>The simplest way to connect to Event Hubs for Kafka is with the connection string. Just add the following property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.azure.eventhubs.connection-string=${AZURE_EVENTHUBS_CONNECTION_STRING}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-azure-resource-manager-to-retrieve-connection-string"><a class="anchor" href="#use-azure-resource-manager-to-retrieve-connection-string"></a><a class="link" href="#use-azure-resource-manager-to-retrieve-connection-string">Use Azure Resource Manager to retrieve connection string</a></h6>
<div class="paragraph">
<p>If you don&#8217;t want to configure the connection string in your application, you can use Azure Resource Manager to retrieve the connection string. To authenticate with Azure Resource Manager, you can also use credentials stored in Azure CLI or another local development tool such as Visual Studio Code or Intellij IDEA. Alternately, you can use Managed Identity if your application is deployed to Azure Cloud. Just be sure the principal has sufficient permission to read resource metadata.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, see the <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure Active Directory</a> section to be sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use Azure Resource Manager to retrieve the connection string, just add the following property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        namespace: ${AZURE_EVENTHUBS_NAMESPACE}
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-18"><a class="anchor" href="#samples-18"></a><a class="link" href="#samples-18">18.7. Samples</a></h3>
<div class="paragraph">
<p>See the <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> repository on GitHub.</p>
</div>
</div>
<div class="sect2">
<h3 id="migrate-an-application-to-use-passwordless-connections-with-azure-event-hubs-for-kafka"><a class="anchor" href="#migrate-an-application-to-use-passwordless-connections-with-azure-event-hubs-for-kafka"></a><a class="link" href="#migrate-an-application-to-use-passwordless-connections-with-azure-event-hubs-for-kafka">18.8. Migrate an application to use passwordless connections with Azure Event Hubs for Kafka</a></h3>
<div class="paragraph">
<p>This tutorial explains how to migrate from traditional authentication methods to more secure, passwordless connections.</p>
</div>
<div class="paragraph">
<p>Application requests to Azure Event Hubs for Kafka must be authenticated. Azure Event Hubs for Kafka provides different ways for apps to connect securely. One of them is to use the connection string. However, you should prioritize passwordless connections in your applications when possible.</p>
</div>
<div class="paragraph">
<p>The support for passwordless connections is enabled after Spring Cloud Azure 4.3.0. This article is a migration guide for removing credentials from Spring Cloud Stream Kafka applications.</p>
</div>
<div class="sect3">
<h4 id="compare-authentication-options-2"><a class="anchor" href="#compare-authentication-options-2"></a><a class="link" href="#compare-authentication-options-2">18.8.1. Compare authentication options</a></h4>
<div class="paragraph">
<p>When authenticating with Azure Event Hubs for Kafka, the application provides an authorized entity to connect the Event Hubs namespace. Apache Kafka protocols provide multiple Simple Authentication and Security Layer (SASL) mechanisms for authentication. According to the SASL mechanisms, there are two authentication options that you can use to authorize access to your secure resources: Azure Active Directory (Azure AD) authentication and Shared Access Signature (SAS) authentication.</p>
</div>
<div class="sect4">
<h5 id="azure-ad-authentication-2"><a class="anchor" href="#azure-ad-authentication-2"></a><a class="link" href="#azure-ad-authentication-2">Azure AD Authentication</a></h5>
<div class="paragraph">
<p>Microsoft Azure AD authentication is a mechanism for connecting to Azure Event Hubs for Kafka using identities defined in Azure AD. With Azure AD authentication, you can manage service principal identities and other Microsoft services in a central location, which simplifies permission management.</p>
</div>
<div class="paragraph">
<p>The benefits of using Azure AD include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication of users across Azure services in a uniform way.</p>
</li>
<li>
<p>Management of password policies and password rotation in a single place.</p>
</li>
<li>
<p>Multiple forms of authentication supported by Azure AD, which can eliminate the need to store passwords.</p>
</li>
<li>
<p>Customers can manage Event Hubs permissions using external (Azure AD) groups.</p>
</li>
<li>
<p>Support for token-based authentication for applications connecting to Azure Event Hubs for Kafka.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sas-authentication"><a class="anchor" href="#sas-authentication"></a><a class="link" href="#sas-authentication">SAS Authentication</a></h5>
<div class="paragraph">
<p>Event Hubs also provides the Shared Access Signatures (SAS) for delegated access to Event Hubs for Kafka resources.</p>
</div>
<div class="paragraph">
<p>Although it&#8217;s possible to connect to Azure Event Hubs for Kafka with SAS, they should be used with caution. Developers must be diligent to never expose the connection strings in an unsecure location. Anyone who gains access to the connection strings is able to authenticate. For example, if a connection string is accidentally checked into source control, sent through an unsecure email, pasted into the wrong chat, or viewed by someone who shouldn&#8217;t have permission, there&#8217;s risk of a malicious user accessing the application. Instead, authorizing access using the OAuth 2.0 token-based mechanism provides superior security and ease of use over SAS. Consider updating your application to use passwordless connections.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introducing-passwordless-connections-2"><a class="anchor" href="#introducing-passwordless-connections-2"></a><a class="link" href="#introducing-passwordless-connections-2">18.8.2. Introducing passwordless connections</a></h4>
<div class="paragraph">
<p>With a passwordless connection, you can connect to Azure services without storing any credentials in the application, its configuration files, or in environment variables. Many Azure services support passwordless connections, such as Azure Managed Identity and Role Based Access Control (RBAC). These techniques provide robust security features that you can implement using <code>DefaultAzureCredential</code> from the Azure Identity client libraries. In this tutorial, you&#8217;ll learn how to update an existing application to use <code>DefaultAzureCredential</code> instead of alternatives such as connection strings.</p>
</div>
<div class="paragraph">
<p><code>DefaultAzureCredential</code> supports multiple authentication methods and automatically determines which should be used at runtime. This approach enables your app to use different authentication methods in different environments (local dev vs. production) without implementing environment-specific code.</p>
</div>
<div class="paragraph">
<p>The order and locations in which <code>DefaultAzureCredential</code> searches for credentials can be found in the <a href="https://learn.microsoft.com/dotnet/api/overview/azure/Identity-readme">Azure Identity library overview</a>. For example, when working locally, <code>DefaultAzureCredential</code> will generally authenticate using the account the developer used to sign in to Visual Studio. When the app is deployed to Azure, <code>DefaultAzureCredential</code> will automatically switch to use a [managed identity](/azure/active-directory/managed-identities-azure-resources/overview). No code changes are required for this transition.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A managed identity provides a security identity to represent an app or service. The identity is managed by the Azure platform and does not require you to provision or rotate any secrets. You can read more about managed identities in the <a href="https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview">overview</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure that connections are passwordless, you must take into consideration both local development and the production environment. If a connection string is required in either place, then the application isn&#8217;t passwordless.</p>
</div>
<div class="paragraph">
<p>In your local development environment, you can authenticate with Azure CLI, Azure PowerShell, Visual Studio, or Azure plugins for Visual Studio Code or IntelliJ. In this case, you can use that credential in your application instead of configuring properties.</p>
</div>
<div class="paragraph">
<p>When you deploy applications to an Azure hosting environment, such as a virtual machine, you can enable managed identity in that environment. Then, you won&#8217;t need to provide credentials to connect to Azure services.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrate-an-existing-application-to-use-passwordless-connections-2"><a class="anchor" href="#migrate-an-existing-application-to-use-passwordless-connections-2"></a><a class="link" href="#migrate-an-existing-application-to-use-passwordless-connections-2">18.8.3. Migrate an existing application to use passwordless connections</a></h4>
<div class="paragraph">
<p>The following steps explain how to migrate an existing application to use passwordless connections instead of a SAS solution.</p>
</div>
<div class="sect4">
<h5 id="prepare-the-working-environment-for-local-development-authentication"><a class="anchor" href="#prepare-the-working-environment-for-local-development-authentication"></a><a class="link" href="#prepare-the-working-environment-for-local-development-authentication">Prepare the working environment for local development authentication</a></h5>
<div class="paragraph">
<p>First, use the following command to set up some environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZ_RESOURCE_GROUP=&lt;YOUR_RESOURCE_GROUP&gt;
export AZ_EVENTHUBS_NAMESPACE_NAME=&lt;YOUR_EVENTHUBS_NAMESPACE_NAME&gt;
export AZ_EVENTHUB_NAME=&lt;YOUR_EVENTHUB_NAME&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the placeholders with the following values, which are used throughout this article:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;YOUR_RESOURCE_GROUP&gt;</code>: The name of the resource group you&#8217;ll use.</p>
</li>
<li>
<p><code>&lt;YOUR_EVENTHUBS_NAMESPACE_NAME&gt;</code>: The name of the Azure Event Hubs namespace you&#8217;ll use.</p>
</li>
<li>
<p><code>&lt;YOUR_EVENTHUB_NAME&gt;</code>: The name of the event hub you&#8217;ll use.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="grant-permission-for-azure-event-hubs"><a class="anchor" href="#grant-permission-for-azure-event-hubs"></a><a class="link" href="#grant-permission-for-azure-event-hubs">Grant permission for Azure Event Hubs</a></h5>
<div class="paragraph">
<p>If you want to run this sample locally with Azure AD authentication, be sure your user account has authenticated via Azure Toolkit for IntelliJ, Visual Studio Code Azure Account plugin, or Azure CLI. Also, be sure the account has been granted sufficient permissions.</p>
</div>
<div class="paragraph">
<p><strong>Azure portal</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Azure portal, locate your Event Hubs namespace using the main search bar or left navigation.</p>
</li>
<li>
<p>On the Event Hubs overview page, select <strong>Access control (IAM)</strong> from the left-hand menu.</p>
</li>
<li>
<p>On the <strong>Access control (IAM)</strong> page, select the <strong>Role assignments</strong> tab.</p>
</li>
<li>
<p>Select <strong>+ Add</strong> from the top menu and then <strong>Add role assignment</strong> from the resulting drop-down menu.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192250682-10d372f6-de86-4f05-8a97-ee08b74f1c74.png" alt="Screenshot of Azure portal Access Control (IAM) page of Event Hubs Namespace resource with Add role assignment highlighted"></span></p>
</div>
</li>
<li>
<p>Use the search box to filter the results to the desired role. For this example, search for <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong> and select the matching result and then choose <strong>Next</strong>.</p>
</li>
<li>
<p>Under <strong>Assign access to</strong>, select <strong>User, group, or service principal</strong>, and then choose <strong>+ Select members</strong>.</p>
</li>
<li>
<p>In the dialog, search for your Azure AD username (usually your <strong>user@domain</strong> email address) and then choose <strong>Select</strong> at the bottom of the dialog.</p>
</li>
<li>
<p>Select <strong>Review + assign</strong> to go to the final page, and then <strong>Review + assign</strong> again to complete the process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Azure CLI</strong></p>
</div>
<div class="paragraph">
<p>To authenticate using the Azure CLI, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the following command to sign to your Azure account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">   az login</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following command to set your current subscription context. Replace <code>ssssssss-ssss-ssss-ssss-ssssssssssss</code> with the GUID for the subscription you want to use with Azure:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">   az account set --subscription ssssssss-ssss-ssss-ssss-ssssssssssss</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following command to get the resource ID for your Azure Event Hubs namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">   export AZURE_EVENTHUBS_RESOURCE_ID=$(az resource show \
       --resource-group $AZ_RESOURCE_GROUP \
       --name $AZ_EVENTHUBS_NAMESPACE_NAME \
       --resource-type Microsoft.EventHub/Namespaces \
       --query "id" \
       --output tsv)</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following command to get your user object ID of your Azure CLI user account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">   export AZURE_AD_ACCOUNT_ID=$(az ad signed-in-user show \
       --query "id" --output tsv)</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following commands to assign <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong> roles to your account.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">   az role assignment create \
       --assignee $AZURE_AD_ACCOUNT_ID \
       --role "Azure Event Hubs Data Receiver" \
       --scope $AZURE_EVENTHUBS_RESOURCE_ID
   az role assignment create \
       --assignee $AZURE_AD_ACCOUNT_ID \
       --role "Azure Event Hubs Data Sender" \
       --scope $AZURE_EVENTHUBS_RESOURCE_ID</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about granting access roles, see <a href="https://learn.microsoft.com/azure/event-hubs/authorize-access-azure-active-directory">Authorize access to Event Hubs resources using Azure Active Directory</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sign-in-and-migrate-the-app-code-to-use-passwordless-connections-2"><a class="anchor" href="#sign-in-and-migrate-the-app-code-to-use-passwordless-connections-2"></a><a class="link" href="#sign-in-and-migrate-the-app-code-to-use-passwordless-connections-2">Sign-in and migrate the app code to use passwordless connections</a></h5>
<div class="paragraph">
<p>For local development, make sure you&#8217;re authenticated with the same Azure AD account you assigned the role to on your Event Hubs. You can authenticate via the Azure CLI, Visual Studio, Azure PowerShell, or other tools such as IntelliJ.</p>
</div>
<div class="paragraph">
<p><strong>Azure CLI</strong></p>
</div>
<div class="paragraph">
<p>Sign in to Azure through the Azure CLI by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az login</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Visual Studio</strong></p>
</div>
<div class="paragraph">
<p>Select the <strong>Sign in</strong> button in the top right corner of Visual Studio.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192250987-7b5feaa1-47eb-4044-80bf-66a5829051d1.png" alt="visual-studio"></span></p>
</div>
<div class="paragraph">
<p>Sign in using the Azure AD account you assigned a role to previously.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251181-bb14b8a3-087e-4d43-82f7-53efe5c62e5b.png" alt="visual-studio-sgin"></span></p>
</div>
<div class="paragraph">
<p><strong>Visual Studio Code</strong></p>
</div>
<div class="paragraph">
<p>Make sure you have the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account">Azure Account</a> extension installed.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251290-fb62fc4b-1031-45ce-90c9-bfb514da9b3a.png" alt="Screenshot showing the Azure extension"></span></p>
</div>
<div class="paragraph">
<p>Use the <strong>CTRL + Shift + P</strong> shortcut to open the command palette. Search for the <strong>Azure: Sign In</strong> command and follow the prompts to authenticate. Make sure to use the Azure AD account you assigned a role to previously from your Blob Storage account.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251369-f1def1b4-331d-47ee-b142-9b852641025d.png" alt="Screenshot showing the Azure sign-in command"></span></p>
</div>
<div class="paragraph">
<p><strong>PowerShell</strong></p>
</div>
<div class="paragraph">
<p>Sign in to Azure using PowerShell by using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">Connect-AzAccount</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, use the following steps to update your Spring Kafka application to use passwordless connections. Although conceptually similar, each framework uses different implementation details.</p>
</div>
<div class="paragraph">
<p><strong>Java</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the following configuration when you create your Kafka producer or consumer to support the <a href="https://kafka.apache.org/documentation/#security_sasl_oauthbearer">SASL/OAUTHBEARER</a> mechanism. Replace the <code>&lt;eventhubs-namesapce&gt;</code> placeholder with the name of your Event Hubs namespace.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   Properties config = new Properties();
   config.put("bootstrap.servers", "&lt;eventhubs-namesapce&gt;.servicebus.windows.net:9093");
   config.put("security.protocol", "SASL_SSL");
   config.put("sasl.mechanism", "OAUTHBEARER");
   config.put("sasl.jaas.config", "org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required");
   config.put("sasl.login.callback.handler.class", "CustomAuthenticateCallbackHandler");
   new KafkaProducer&lt;K, V&gt;(config);</code></pre>
</div>
</div>
</li>
<li>
<p>Implement a callback handler similar to <a href="https://github.com/Azure/azure-event-hubs-for-kafka/blob/master/tutorials/oauth/java/managedidentity/producer/src/main/java/CustomAuthenticateCallbackHandler.java">CustomAuthenticateCallbackHandler</a> in the <a href="https://github.com/Azure/azure-event-hubs-for-kafka">azure-event-hubs-for-kafka</a> sample on GitHub.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Spring Kafka</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inside your project, add the following reference to the <code>com.azure.spring:spring-cloud-azure-starter</code> package. This library contains all of the necessary entities to implement passwordless connections.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">   &lt;dependency&gt;
       &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
       &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Then, add the following property to configure the Kafka bootstrap server with your Azure Event Hubs namespace:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">   spring.kafka.bootstrap-servers=$AZ_EVENTHUBS_NAMESPACE_NAME.servicebus.windows.net:9093</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Spring Cloud Stream Kafka Binder</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inside your project, add the following reference to the <code>com.azure.spring:spring-cloud-azure-starter</code> package. This library contains all of the necessary entities to implement passwordless connections.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">   &lt;dependency&gt;
       &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
       &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
   &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Then, add the following property to configure the Kafka bootstrap server with your Azure Event Hubs namespace:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">   spring.cloud.stream.kafka.binder.brokers=$AZ_EVENTHUBS_NAMESPACE_NAME.servicebus.windows.net:9093</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re using version <code>4.3.0</code>, don&#8217;t forget to set the <code>spring.cloud.stream.binders.&lt;kafka-binder-name&gt;.environment.spring.main.sources</code> property to <code>com.azure.spring.cloud.autoconfigure.kafka.AzureKafkaSpringCloudStreamConfiguration</code>. By default <code>&lt;kafka-binder-name&gt;</code> is <code>kafka</code> in a single kafka binder application. This property setting enables the whole OAuth authentication workflow. This setting is also used to specify the additional configuration <code>KafkaBinderConfigurationPropertiesBeanPostProcessor</code>, which specifies the OAuth security parameters for the particular binder to enable Azure Identity. For version after <code>4.4.0</code>, this property will be added automatically for each Kafka binder environment, so there&#8217;s no need for you to add it manually.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="run-the-app-locally-2"><a class="anchor" href="#run-the-app-locally-2"></a><a class="link" href="#run-the-app-locally-2">Run the app locally</a></h6>
<div class="paragraph">
<p>After making these code changes, run your application locally. The new configuration should pick up your local credentials, assuming you&#8217;re logged into a compatible IDE or command line tool, such as the Azure CLI, Visual Studio, or IntelliJ. The roles you assigned to your local dev user in Azure will allow your app to connect to the Azure service locally.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-the-azure-hosting-environment-2"><a class="anchor" href="#configure-the-azure-hosting-environment-2"></a><a class="link" href="#configure-the-azure-hosting-environment-2">Configure the Azure hosting environment</a></h5>
<div class="paragraph">
<p>After your application is configured to use passwordless connections and runs locally, the same code can authenticate to Azure services after it&#8217;s deployed to Azure. For example, an application deployed to an Azure Spring Apps instance that has a managed identity enabled can connect to Azure Event Hubs for Kafka.</p>
</div>
<div class="paragraph">
<p>In this section, you&#8217;ll execute two steps to enable your application to run in an Azure hosting environment in a passwordless way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the managed identity for your Azure hosting environment.</p>
</li>
<li>
<p>Assign roles to the managed identity.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Azure also provides the <a href="https://learn.microsoft.com/azure/service-connector/overview">Service Connector</a> service, which can help you connect your hosting service with Event Hubs.With Service Connector to configure your hosting environment, you can omit the step of assigning roles to your managed identity because Service Connector will do it for you.The following section describes how to configure your Azure hosting environment in two ways: one via Service Connector and the other by configuring each hosting environment directly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="create-the-managed-identity-for-your-azure-hosting-environment"><a class="anchor" href="#create-the-managed-identity-for-your-azure-hosting-environment"></a><a class="link" href="#create-the-managed-identity-for-your-azure-hosting-environment">Create the managed identity for your Azure hosting environment</a></h5>
<div class="paragraph">
<p>The following steps show you how to create a system-assigned managed identity for various web hosting services. The managed identity can securely connect to other Azure Services using the app configurations you set up previously.</p>
</div>
<div class="paragraph">
<p><strong>Service Connector</strong></p>
</div>
<div class="paragraph">
<p>When using Service Connector, it can help to create the system-assigned managed identity to your Azure hosting environment, and then configure the <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong> roles for the managed identity.</p>
</div>
<div class="paragraph">
<p>The following compute services are currently supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure App Service</p>
</li>
<li>
<p>Azure Spring Cloud</p>
</li>
<li>
<p>Azure Container Apps (preview)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this migration guide, you&#8217;ll use App Service, but the steps are similar for Azure Spring Apps and Azure Container Apps.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Azure Spring Apps currently only supports Service Connector using connection strings.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Azure portal, on the main overview page of your App Service instance, select <strong>Service Connector</strong> from the navigation pane.</p>
</li>
<li>
<p>Select <strong>+ Create</strong> from the main menu and the <strong>Create connection</strong> panel will open. Enter the following values:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Service type</strong>: Choose <strong>Event Hubs</strong>.</p>
</li>
<li>
<p><strong>Subscription</strong>: Select the subscription you&#8217;d like to use.</p>
</li>
<li>
<p><strong>Connection Name</strong>: Enter a name for your connection, such as <strong>connector_appservice_eventhub</strong>.</p>
</li>
<li>
<p><strong>Namespace</strong>: Select the Event Hubs namespace you&#8217;d like to use.</p>
</li>
<li>
<p><strong>Client type</strong>: Leave the default value selected or choose the specific client you&#8217;d like to use.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Next: Authentication</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251708-5ce73d0d-852b-4987-ab38-80cf8b63f561.png" alt="Screenshot of Azure portal Service Connector page of App Service resource with Create connection pane showing and Service type field with Event Hubs value highlighted"></span></p>
</div>
</li>
<li>
<p>Make sure <strong>System assigned managed identity (Recommended)</strong> is selected, and then select <strong>Next: Networking</strong>.</p>
</li>
<li>
<p>Leave the default values selected, and then select <strong>Next: Review + Create</strong>.</p>
</li>
<li>
<p>After Azure validates your settings, select <strong>Create</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Service Connector will automatically create a system-assigned managed identity for the app service. The connector will also assign the managed identity roles of <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong> for the Event Hubs instance you selected.</p>
</div>
<div class="paragraph">
<p>You can create a Service Connection between an Azure compute hosting environment and a target service by using the Azure CLI. The Azure CLI automatically handles creating a managed identity and assigns the proper role, as explained in the <a href="#create-the-managed-identity-for-your-azure-hosting-environment">Create the managed identity for your Azure hosting environment</a> section.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using an Azure App Service, use the <code>az webapp connection</code> command, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az webapp connection create eventhub \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;app-service-name&gt;
    --target-id $AZURE_EVENTHUBS_RESOURCE_ID \
    --client-type kafka-springBoot \
    --system-identity</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using Azure Spring Apps, use <code>the az spring connection</code> command, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az spring connection create eventhub \
    --app &lt;spring-app-name&gt; \
    --service &lt;azure-spring-service-name&gt; \
    --resource-group $AZ_RESOURCE_GROUP \
    --deployment &lt;spring-app-deployoment-name&gt; \
    --target-id $AZURE_EVENTHUBS_RESOURCE_ID \
    --client-type kafka-springBoot \
    --system-identity</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using Azure Container Apps, use the <code>az containerapp connection</code> command, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az containerapp connection create eventhub \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;container-app-name&gt;
    --target-id $AZURE_EVENTHUBS_RESOURCE_ID \
    --client-type kafka-springBoot \
    --system-identity</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>App Service</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your App Service, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>Under the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251837-0c7b3bba-d82e-486b-ac92-371f8623a119.png" alt="Screenshot of Azure portal Identity page of App Service resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure App Service with the <a href="https://learn.microsoft.com/cli/azure/webapp/identity">az webapp identity assign</a> command, as shown in the following example.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MANAGED_IDENTITY_ID=$(az webapp identity assign \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;app-service-name&gt; \
    --query principalId \
    --output tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Container Apps</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure Container App, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>Under the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192251946-1b060983-d1c9-4163-b621-275ee6d10e92.png" alt="Screenshot of Azure portal Identity page of Container App resource showing System assigned tab with Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure Container App with the <a href="https://learn.microsoft.com/cli/azure/containerapp/identity">az containerapp identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MANAGED_IDENTITY_ID=$(az containerapp identity assign \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;container-app-name&gt; \
    --system-assigned \
    --query principalId \
    --output tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Spring Apps</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure Spring App, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>Under the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192252066-8bf9327e-1b43-49bf-ae7c-0d81c93da800.png" alt="Screenshot of Azure portal Identity page of App resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to an Azure Spring App with the <a href="https://learn.microsoft.com/cli/azure/spring/app/identity">az spring app identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MANAGED_IDENTITY_ID=$(az spring app identity assign \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;spring-app-name&gt; \
    --service &lt;spring-apps-service-name&gt; \
    --system-assigned \
    --query identity.principalId \
    --output tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Virtual Machines</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the main overview page of your Azure Spring App, select <strong>Identity</strong> from the navigation pane.</p>
</li>
<li>
<p>Under the <strong>System assigned</strong> tab, make sure to set the <strong>Status</strong> field to <strong>on</strong>. A system assigned identity is managed by Azure internally and handles administrative tasks for you. The details and IDs of the identity are never exposed in your code.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192252177-268acda0-cea1-42d0-872d-8e3dd8163896.png" alt="Screenshot of Azure portal Identity page of Virtual machine resource with System assigned tab showing and Status field highlighted"></span></p>
</div>
</li>
<li>
<p>Copy the object (principal) ID.</p>
</li>
<li>
<p>You can assign a managed identity to a Virtual Machine with the <a href="https://learn.microsoft.com/cli/azure/vm/identity">az vm identity assign</a> command, as shown in the following example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MANAGED_IDENTITY_ID=$(az vm identity assign \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;vm-name&gt; \
    --query principalId \
    --output tsv)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>AKS</strong></p>
</div>
<div class="paragraph">
<p>You can assign a managed identity to an Azure Kubernetes Service with the <a href="https://learn.microsoft.com/cli/azure/aks">az aks update</a> command, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">export AZURE_MANAGED_IDENTITY_ID=$(az aks update \
    --resource-group $AZ_RESOURCE_GROUP \
    --name &lt;AKS-cluster-name&gt; \
    --enable-managed-identity \
    --query identityProfile.kubeletidentity.clientId \
    --output tsv)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="assign-roles-to-the-managed-identity-2"><a class="anchor" href="#assign-roles-to-the-managed-identity-2"></a><a class="link" href="#assign-roles-to-the-managed-identity-2">Assign roles to the managed identity</a></h5>
<div class="paragraph">
<p>Next, you need to grant permissions to the managed identity you created to access your Event Hubs namespace. You can do this by assigning a role to the managed identity, just like you did with your local development user.</p>
</div>
<div class="paragraph">
<p><strong>Service Connector</strong></p>
</div>
<div class="paragraph">
<p>If you connected your services using the Service Connector, you don&#8217;t need to complete this step. The following necessary configurations were handled for you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you selected a managed identity while creating the connection, a system-assigned managed identity was created for your app and assigned the <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong> roles on the Event Hubs.</p>
</li>
<li>
<p>If you chose to use a connection string, the connection string was added as an app environment variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Azure portal</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Azure portal, locate your Event Hubs namespace using the main search bar or the navigation pane.</p>
</li>
<li>
<p>On the Event Hubs overview page, select <strong>Access control (IAM)</strong> from the navigation menu.</p>
</li>
<li>
<p>On the <strong>Access control (IAM)</strong> page, select the <strong>Role assignments</strong> tab.</p>
</li>
<li>
<p>Select <strong>+ Add</strong> from the main menu and then <strong>Add role assignment</strong> from the drop-down menu.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/58474919/192252332-c674a41e-9cc8-4eef-8e92-47ca31b42844.png" alt="Screenshot of Azure portal Access control (IAM) page of Event Hubs Namespace resource with Add role assignment menu option highlighted"></span></p>
</div>
</li>
<li>
<p>Use the search box to filter the results to the desired role. For this example, search for <strong>Azure Event Hubs Data Sender</strong> and <strong>Azure Event Hubs Data Receiver</strong>, select the matching result, and then select <strong>Next</strong>.</p>
</li>
<li>
<p>Under <strong>Assign access to</strong>, select <strong>Managed identity</strong>, and then select <strong>+ Select members</strong>.</p>
</li>
<li>
<p>In the flyout, search for the subscription where hosting service is located. Then, select <strong>All system-assigned managed identities</strong>, and select the managed identity of your hosting service. Select the system assigned identity, and then select <strong>Select</strong> to close the flyout menu.</p>
</li>
<li>
<p>Select <strong>Next</strong> a couple of times until you&#8217;re able to select <strong>Review + assign</strong> to finish the role assignment.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Azure CLI</strong></p>
</div>
<div class="paragraph">
<p>To assign a role at the resource level using the Azure CLI, you can use the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">az role assignment create \
    --assignee $AZURE_MANAGED_IDENTITY_ID \
    --role "Azure Event Hubs Data Receiver" \
    --scope $AZURE_EVENTHUBS_RESOURCE_ID
az role assignment create \
    --assignee $AZURE_MANAGED_IDENTITY_ID \
    --role "Azure Event Hubs Data Sender" \
    --scope $AZURE_EVENTHUBS_RESOURCE_ID</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="test-the-app-2"><a class="anchor" href="#test-the-app-2"></a><a class="link" href="#test-the-app-2">Test the app</a></h6>
<div class="paragraph">
<p>After making these code changes, browse to your hosted application in the browser. Your app should be able to connect to the Azure Event Hubs for Kafka successfully. Keep in mind that it may take several minutes for the role assignments to propagate through your Azure environment. Your application is now configured to run both locally and in a production environment without the developers having to manage secrets in the application itself.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="redis-support"><a class="anchor" href="#redis-support"></a><a class="link" href="#redis-support">19. Redis Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to Azure Cache for Redis using Spring Redis libraries. With adding <code>spring-cloud-azure-starter</code> and <code>spring-cloud-azure-resourcemanager</code> to your application, it&#8217;s possible to read the Azure Cache for Redis connection information through Azure Resource Manager and auto-configure the Redis properties.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-17"><a class="anchor" href="#dependency-setup-17"></a><a class="link" href="#dependency-setup-17">19.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>Add the following dependencies if you want to use the Spring Cloud Azure Redis support to your Spring Boot application using Redis.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-17"><a class="anchor" href="#configuration-17"></a><a class="link" href="#configuration-17">19.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. Configurable properties when using Redis support</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A value that indicates whether the Azure Cache for Redis is enabled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cache for Redis instance name.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Cache for Redis.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription id.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication information is also required for authenticating for Azure Resource Manager. The credential related configurations of Resource Manager should be configured under prefix <code>spring.cloud.azure</code>. For more information, see the <a href="index.html#authentication">Authentication</a> section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-14"><a class="anchor" href="#basic-usage-14"></a><a class="link" href="#basic-usage-14">19.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Add the following properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.azure.redis.name=${AZURE_CACHE_REDIS_NAME}
spring.cloud.azure.redis.resource.resource-group=${AZURE_CACHE_REDIS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-19"><a class="anchor" href="#samples-19"></a><a class="link" href="#samples-19">19.4. Samples</a></h3>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-azure-resourcemanager"><a class="anchor" href="#spring-cloud-azure-resourcemanager"></a><a class="link" href="#spring-cloud-azure-resourcemanager">20. Azure Resource Manager</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Azure Resource Manager (ARM) is the deployment and management service for Azure. It provides a management layer that enables you to create, update, and delete resources in your Azure account. Spring Cloud Azure Resource Manager can help provision resources or retrieve resource metadata.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-18"><a class="anchor" href="#dependency-setup-18"></a><a class="link" href="#dependency-setup-18">20.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-18"><a class="anchor" href="#configuration-18"></a><a class="link" href="#configuration-18">20.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 40. Configurable properties of spring-cloud-azure-resourcemanager</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.resource-manager</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the Resource Manager is enabled. Default is true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.cloud-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.environment.active-directory-endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Active Directory endpoint to connect to for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscription id to use when connecting to Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant id for Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace of the Azure service to provision resources with.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group holding an Azure service resource.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="resource-manager-basic-usage"><a class="anchor" href="#resource-manager-basic-usage"></a><a class="link" href="#resource-manager-basic-usage">20.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Spring Cloud Azure Resource Manager can work together with specific Spring Cloud Azure starters to retrieve connection information, such as connection strings, to connect to Azure services. It can also work together with <code>spring-cloud-azure-starter</code> and third-party libraries to retrieve metadata like username/password, and to complete authentication, For more information, see the <a href="#kafka-support">Kafka Support</a> and <a href="#redis-support">Redis Support</a> sections.</p>
</div>
<div class="paragraph">
<p>For example, to retrieve the connection string of an Azure Service, developers can use a service principal as the credential to authenticate and retrieve the connection string. The configuration is listed the follows. The provided service principal should
be assigned a role of <code>Contributor</code> of the associated namespace at least. See <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the principal has been granted the sufficient permission to access the Azure resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      &lt;azure-service&gt;:
        namespace: ${SERVICEBUS_NAMESPACE}
        resource:
          resource-group: ${RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-20"><a class="anchor" href="#samples-20"></a><a class="link" href="#samples-20">20.4. Samples</a></h3>
<div class="paragraph">
<p>See <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.5.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties-2"><a class="anchor" href="#configuration-properties-2"></a><a class="link" href="#configuration-properties-2">21. Configuration Properties</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a><a class="link" href="#appendix">22. Appendix</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration-properties-3"><a class="anchor" href="#configuration-properties-3"></a><a class="link" href="#configuration-properties-3">22.1. <a href="appendix.html##configuration-properties">Configuration properties</a></a></h3>

</div>
<div class="sect2">
<h3 id="migration-guide-for-4-0-2"><a class="anchor" href="#migration-guide-for-4-0-2"></a><a class="link" href="#migration-guide-for-4-0-2">22.2. <a href="appendix.html#migration-guide-for-4-0">Migration guide for 4.0</a></a></h3>

</div>
<div class="sect2">
<h3 id="known-issues"><a class="anchor" href="#known-issues"></a><a class="link" href="#known-issues">22.3. <a href="appendix.html#known-issues">Known issues</a></a></h3>

</div>
<div class="sect2">
<h3 id="create-and-configure-a-managed-identity-on-azure-hosting-services"><a class="anchor" href="#create-and-configure-a-managed-identity-on-azure-hosting-services"></a><a class="link" href="#create-and-configure-a-managed-identity-on-azure-hosting-services">22.4. <a href="appendix.html#create-and-configure-a-managed-identity-on-azure-hosting-services">Create and configure a managed identity on Azure hosting services</a></a></h3>

</div>
<div class="sect2">
<h3 id="deploy-application-to-azure-hosting-services"><a class="anchor" href="#deploy-application-to-azure-hosting-services"></a><a class="link" href="#deploy-application-to-azure-hosting-services">22.5. <a href="appendix.html#deploy-application-to-azure-hosting-services">Deploy application to Azure hosting services</a></a></h3>

</div>
</div>
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>