<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Azure Key Vault certificates</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "b9g1q6wz23"); </script>

</head>
<body class="book">
<div id="header">
</div>
<div id="content">
<div class="sect2">
<h3 id="_azure_key_vault_certificates">Azure Key Vault certificates</h3>
<div class="paragraph">
<p>This tutorial shows you how to secure your Spring Boot (including Azure Spring Cloud) apps with TLS/SSL certificates using Azure Key Vault and managed identities for Azure resources.</p>
</div>
<div class="paragraph">
<p>Production-grade Spring Boot applications, whether in the cloud or on-premises, require end-to-end encryption for network traffic using standard TLS protocols. Most TLS/SSL certificates you come across are discoverable from a public root certificate authority (CA). Sometimes, however, this discovery isn&#8217;t possible. When certificates aren&#8217;t discoverable, the app must have some way to load such certificates, present them to inbound network connections, and accept them from outbound network connections.</p>
</div>
<div class="paragraph">
<p>Spring Boot apps typically enable TLS by installing the certificates. The certificates are installed into the local key store of the JVM that&#8217;s running the Spring Boot app. With Spring on Azure, certificates are not installed locally. Instead, Spring integration for Microsoft Azure provides a secure and frictionless way to enable TLS with help from Azure Key Vault and managed identity for Azure resources.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160548968-523cbb6d-fffe-44a7-9dd7-563ffe6610db.png" alt="Azure KeyVault Certificates"></span></p>
</div>
<div class="paragraph">
<p>In this tutorial, you learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a GNU/Linux VM with system-assigned managed identity</p>
</li>
<li>
<p>Create an Azure Key Vault</p>
</li>
<li>
<p>Create a self-signed TLS/SSL certificate</p>
</li>
<li>
<p>Store the self-signed TLS/SSL certificate in the Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for outbound connection comes from Azure Key Vault</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_prerequisites">Prerequisites</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>The curl command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://curl.se/">the official curl website</a>.</p>
</li>
<li>
<p>The jq command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://stedolan.github.io/jq/">the official jq website</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>, version 2.14.1 or later</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_gnulinux_vm_with_system_assigned_managed_identity">Create a GNU/Linux VM with system-assigned managed identity</h4>
<div class="paragraph">
<p>Use the following steps to create an Azure VM with a system-assigned managed identity and prepare it to run the Spring Boot application. For an overview of managed identities for Azure resources, see <a href="/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Bash shell.</p>
</li>
<li>
<p>Sign out and delete some authentication files to remove any lingering credentials.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az logout
rm ~/.azure/accessTokens.json
rm ~/.azure/azureProfile.json</code></pre>
</div>
</div>
</li>
<li>
<p>Sign in to your Azure CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az login</code></pre>
</div>
</div>
</li>
<li>
<p>Set the subscription ID. Be sure to replace the placeholder with the appropriate value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az account set -s &lt;your subscription ID&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create an Azure resource group. Take note of the resource group name for later use.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group create \
    --name &lt;your resource group name&gt; \
    --location &lt;your resource group region&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Set default resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az configure --defaults group=&lt;your resource group name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create the VM instance with system-assigned managed identity enabled, using the image <code>UbuntuLTS</code> provided by <code>UbuntuServer</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm create \
    --name &lt;your VM name&gt; \
    --debug \
    --generate-ssh-keys \
    --assign-identity \
    --image UbuntuLTS \
    --admin-username azureuser</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the JSON output, note down the value of the <code>publicIpAddress</code> and <code>systemAssignedIdentity</code> properties. You&#8217;ll use these values later in the tutorial.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name <code>UbuntuLTS</code> is a Uniform Resource Name (URN) alias, which is a shortened version created for popular images like <strong>UbuntuLTS</strong>. Run the following command to display a cached list of popular images in table format:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image list --output table</code></pre>
</div>
</div>
</li>
<li>
<p>Install the Microsoft OpenJDK. For complete information about OpenJDK, see [Microsoft Build of OpenJDK](/java/openjdk).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh azureuser@&lt;your VM public IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the repository. Replace the version placeholder in following commands and execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget https://packages.microsoft.com/config/ubuntu/{version}/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the Microsoft Build of OpenJDK by running the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo apt install apt-transport-https
sudo apt update
sudo apt install msopenjdk-11</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another, faster way to get set up the certified Azul Zulu for Azure – Enterprise Edition VM image, which can avoid the installation of Azure SDK. For complete information about Azul Zulu for Azure, see <a href="https://www.azul.com/downloads/azure-only/zulu/">Download Java for Azure</a> Run the following command to obtain the URN name.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image list \
    --offer Zulu \
    --location &lt;your region&gt; \
    --all | grep urn</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command may take a while to complete. When the command completes, it produces output similar to the following lines. Select the value for JDK 11 on Ubuntu.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">"urn": "azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0",
...
"urn": "azul:azul-zulu8-ubuntu-2004:zulu-jdk8-ubtu2004:20.11.0",
"urn": "azul:azul-zulu8-windows-2019:azul-zulu8-windows2019:20.11.0",</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the following command to accept the terms for the image to allow the VM to be created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image terms accept --urn azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_and_configure_an_azure_key_vault">Create and configure an Azure Key Vault</h4>
<div class="paragraph">
<p>Use the following steps to create an Azure Key Vault, and to grant permission for the VM&#8217;s system-assigned managed identity to access the Key Vault for certificates.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an Azure Key Vault within the resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault create \
    --name &lt;your Key Vault name&gt; \
    --location &lt;your resource group region&gt;
export KEY_VAULT_URI=$(az keyvault show --name &lt;your Key Vault name&gt; | jq -r '.properties.vaultUri')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take note of the <code>KEY_VAULT_URI</code> value. You&#8217;ll use it later.</p>
</div>
</li>
<li>
<p>Grant the VM permission to use the Key Vault for certificates.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;your system-assigned identity&gt; \
    --secret-permissions get list \
    --certificate-permissions get list import</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_and_store_a_self_signed_tlsssl_certificate">Create and store a self-signed TLS/SSL certificate</h4>
<div class="paragraph">
<p>The steps in this tutorial apply to any TLS/SSL certificate (including self-signed) stored directly in Azure Key Vault. Self-signed certificates aren&#8217;t suitable for use in production, but are useful for dev and test applications. This tutorial uses a self-signed certificate. To create the certificate, use the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault certificate create \
  –vault-name &lt;your Key Vault name&gt; \
  –name mycert \
  –policy "$(az keyvault certificate get-default-policy)"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_spring_boot_application_with_secure_inbound_connections">Run a Spring Boot application with secure inbound connections</h4>
<div class="paragraph">
<p>In this section, you&#8217;ll create a Spring Boot starter application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault.</p>
</div>
<div class="paragraph">
<p>To create the application, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">https://start.spring.io/</a>.</p>
</li>
<li>
<p>Select the choices as shown in the picture following this list.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: <strong>Maven Project</strong></p>
</li>
<li>
<p><strong>Language</strong>: <strong>Java</strong></p>
</li>
<li>
<p><strong>Spring Boot</strong>: <strong>2.5.10</strong></p>
</li>
<li>
<p><strong>Group</strong>: <strong>com.contoso</strong> (You can put any valid Java package name here.)</p>
</li>
<li>
<p><strong>Artifact</strong>: <strong>ssltest</strong> (You can put any valid Java class name here.)</p>
</li>
<li>
<p><strong>Packaging</strong>: <strong>Jar</strong></p>
</li>
<li>
<p><strong>Java</strong>: <strong>11</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Add Dependencies&#8230;&#8203;</strong>.</p>
</li>
<li>
<p>In the text field, type <strong>Spring Web</strong> and press Ctrl+Enter.</p>
</li>
<li>
<p>In the text field type <strong>Azure Support</strong> and press Enter. Your screen should look like the following.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160551580-c39b27ff-ad45-4f8a-8aca-98f1aa0fe8fd.png" alt="Basic Spring Initializr options"></span></p>
</div>
</li>
<li>
<p>At the bottom of the page, select <strong>Generate</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer. This tutorial uses a <strong>ssltest</strong> directory in the current user&#8217;s home directory. The values above will give you an <strong>ssltest.zip</strong> file in that directory.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_enable_the_spring_boot_app_to_load_the_tlsssl_certificate">Enable the Spring Boot app to load the TLS/SSL certificate</h5>
<div class="paragraph">
<p>To enable the app to load the certificate, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip the <strong>ssltest.zip</strong> file.</p>
</li>
<li>
<p>Remove the <strong>test</strong> directory and its subdirectories. This tutorial ignores the test, so you can safely delete the directory.</p>
</li>
<li>
<p>Rename <strong>application.properties</strong> in <strong>src/main/resources</strong> to <strong>application.yml</strong>.</p>
</li>
<li>
<p>The file layout will look like the following.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">├── HELP.md
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
    └── main
        ├── java
        │   └── com
        │       └── contoso
        │           └── ssltest
        │               └── SsltestApplication.java
        └── resources
            ├── application.yml
            ├── static
            └── templates</code></pre>
</div>
</div>
</li>
<li>
<p>Modify the POM to add a dependency on <code>azure-spring-boot-starter-keyvault-certificates</code>. Add the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;azure-spring-boot-starter-keyvault-certificates&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <strong>src/main/resources/application.yml</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">server:
  ssl:
    key-alias: &lt;the name of the certificate in Azure Key Vault to use&gt;
    key-store-type: AzureKeyVault
    trust-store-type: AzureKeyVault
  port: 8443
azure:
  keyvault:
    uri: &lt;the URI of the Azure Key Vault to use&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These values enable the Spring Boot app to perform the <strong>load</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial. The following table describes the property values. Here is explanation of each property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server.port|The local TCP port on which to listen for HTTPS connections.</p>
</li>
<li>
<p>server.ssl.key-alias|The value of the <code>--name</code> argument you passed to <code>az keyvault certificate create</code>.</p>
</li>
<li>
<p>server.ssl.key-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>server.ssl.trust-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>azure.keyvault.uri|The <code>vaultUri</code> property in the return JSON from <code>az keyvault create</code>. You saved this value in an environment variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only property specific to Key Vault is <code>azure.keyvault.uri</code>. The app is running on a VM whose system-assigned managed identity has been granted access to the Key Vault. Therefore, the app has also been granted access.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>These changes enable the Spring Boot app to load the TLS/SSL certificate. In the next section, you&#8217;ll enable the app to perform the <strong>accept</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial.</p>
</div>
</div>
<div class="sect4">
<h5 id="_create_a_spring_boot_rest_controller">Create a Spring Boot REST controller</h5>
<div class="paragraph">
<p>To create the REST controller, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <strong>src/main/java/com/contoso/ssltest/SsltestApplication.java</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.contoso.ssltest;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling <code>System.exit(0)</code> from within an unauthenticated REST GET call is only for demonstration purposes. Don&#8217;t use <code>System.exit(0)</code> in a real application.</p>
</div>
<div class="paragraph">
<p>This code illustrates the <strong>present</strong> action mentioned at the beginning of this tutorial. The following list highlights some details about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There&#8217;s now a <code>@RestController</code> annotation on the <code>SsltestApplication</code> class generated by Spring Initializr.</p>
</li>
<li>
<p>There&#8217;s a method annotated with <code>@GetMapping</code>, with a <code>value</code> for the HTTP call you&#8217;ll make.</p>
</li>
<li>
<p>The <code>inbound</code> method simply returns a greeting when a browser makes an HTTPS request to the <code>/ssl-test</code> path. The <code>inbound</code> method illustrates how the server presents the TLS/SSL certificate to the browser.</p>
</li>
<li>
<p>The <code>exit</code> method will cause the JVM to exit when invoked. This method is a convenience to make the sample easy to run in the context of this tutorial.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open a new Bash shell and navigate to the <strong>ssltest</strong> directory. Run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven compiles the code and packages it up into an executable JAR file</p>
</div>
</li>
<li>
<p>Verify that the network security group created within <code>&lt;your resource group name&gt;</code> allows inbound traffic on ports 22 and 8443 from your IP address. To learn about configuring network security group rules to allow inbound traffic, see the [Work with security rules](/azure/virtual-network/manage-network-security-group#work-with-security-rules) section of [Create, change, or delete a network security group](/azure/virtual-network/manage-network-security-group).</p>
</li>
<li>
<p>Put the executable JAR file on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd target
sftp azureuser@&lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_run_the_app_on_the_server">Run the app on the server</h5>
<div class="paragraph">
<p>Now that you&#8217;ve built the Spring Boot app and uploaded it to the VM, use the following steps to run it on the VM and call the REST endpoint with curl.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSH to connect to the VM, then run the executable jar.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>Open a new Bash shell and execute the following command to verify that the server presents the TLS/SSL certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve seen the <strong>load</strong> and <strong>present</strong> actions with a self-signed TLS/SSL certificate, you&#8217;ll make some trivial changes to the app to see the <strong>accept</strong> action as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_a_spring_boot_application_with_secure_outbound_connections">Run a Spring Boot application with secure outbound connections</h4>
<div class="paragraph">
<p>In this section, you&#8217;ll modify the code in the previous section so that the TLS/SSL certificate for outbound connection comes from Azure Key Vault. Therefore, the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions are satisfied from the Azure Key Vault.</p>
</div>
<div class="sect4">
<h5 id="_modify_the_ssltestapplication_to_illustrate_outbound_tls_connections">Modify the SsltestApplication to illustrate outbound TLS connections</h5>
<div class="paragraph">
<p>Use the following steps to modify the application:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the dependency on Apache HTTP Client by adding the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
   &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
   &lt;version&gt;4.5.13&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add a new rest endpoint called <code>ssl-test-outbound</code>. This endpoint opens up a TLS socket to itself and verifies that the TLS connection accepts the TLS/SSL certificate.</p>
<div class="paragraph">
<p>Replace the contents of <strong>SsltestApplication.java</strong> with the following code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.contoso.ssltest;

import java.security.KeyStore;
import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import com.azure.security.keyvault.jca.KeyVaultLoadStoreParameter;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.TrustSelfSignedStrategy;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.ssl.SSLContexts;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/ssl-test-outbound")
    public String outbound() throws Exception {
        KeyStore azureKeyVaultKeyStore = KeyStore.getInstance("AzureKeyVault");
        KeyVaultLoadStoreParameter parameter = new KeyVaultLoadStoreParameter(
            System.getProperty("azure.keyvault.uri"));
        azureKeyVaultKeyStore.load(parameter);
        SSLContext sslContext = SSLContexts.custom()
                                           .loadTrustMaterial(azureKeyVaultKeyStore, null)
                                           .build();

        HostnameVerifier allowAll = (String hostName, SSLSession session) -&gt; true;
        SSLConnectionSocketFactory csf = new SSLConnectionSocketFactory(sslContext, allowAll);

        CloseableHttpClient httpClient = HttpClients.custom()
            .setSSLSocketFactory(csf)
            .build();

        HttpComponentsClientHttpRequestFactory requestFactory =
            new HttpComponentsClientHttpRequestFactory();

        requestFactory.setHttpClient(httpClient);
        RestTemplate restTemplate = new RestTemplate(requestFactory);
        String sslTest = "https://localhost:8443/ssl-test";

        ResponseEntity&lt;String&gt; response
            = restTemplate.getForEntity(sslTest, String.class);

        return "Outbound TLS " +
            (response.getStatusCode() == HttpStatus.OK ? "is" : "is not")  + " Working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Build the app.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ssltest
mvn clean package</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the app again using the same <code>sftp</code> command from earlier in this article.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd target
sftp &lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Run the app on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>After the server is running, verify that the server accepts the TLS/SSL certificate. In the same Bash shell where you issued the previous <code>curl</code> command, run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test-outbound</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the message <code>Outbound TLS is working!!</code>.</p>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You&#8217;ve now observed a simple illustration of the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions with a self-signed TLS/SSL certificate stored in Azure Key Vault.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_resources">Clean up resources</h4>
<div class="paragraph">
<p>When you&#8217;re finished with the Azure resources you created in this tutorial, you can delete them using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group delete –name &lt;your resource group name&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-31 16:00:56 UTC
</div>
</div>
<script src="js/highlight/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>