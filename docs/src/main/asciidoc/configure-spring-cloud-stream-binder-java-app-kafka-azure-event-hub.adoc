==== Using Spring Kafka with Azure Event Hubs

Users of link:http://kafka.apache.org[Apache Kafka] with Azure Event Hubs can take advantage of `Spring Cloud Azure` to use various types of credentials to do the authentication. Refer to link:index.html#authentication[Authentication] for details. This article demonstrates how to configure a Java-based Spring Cloud Stream Binder created with the Spring Boot Initializer to use link:http://kafka.apache.org[Apache Kafka] with Azure Event Hubs and deploy to the `Azure Spring Apps` using Managed Identity.

===== Prerequisites

The following prerequisites are required in order to follow the steps in this article:

* An Azure subscription; if you don't already have an Azure subscription, you can activate your link: https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/[MSDN subscriber benefits] or sign up for a link:https://azure.microsoft.com/pricing/free-trial/[free Azure account].
* A supported Java Development Kit (JDK). For more information about the JDKs available for use when developing on Azure, see link:https://docs.microsoft.com/azure/developer/java/fundamentals/java-support-on-azure[Java support on Azure and Azure Stack].
* link:http://maven.apache.org/[Apache Maven], version 3.0 or later.

IMPORTANT: Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.

===== Create an Azure Event Hubs

====== Create an Azure Event Hubs namespace

1. Browse to the Azure portal at <https://portal.azure.com/> and sign in.

2. Select **Create a resource**, then **Search the Marketplace**, then search for *Event Hubs*.

3. Select **Create**.
+
image::https://review.docs.microsoft.com/en-us/azure/developer/java/spring-framework/media/configure-spring-cloud-stream-binder-java-app-kafka-azure-event-hub/create-kafka-event-hub-01.png[create-kafka-event-hub-01]

4. On the **Create Namespace** page, enter the following information:

* Choose the **Subscription** you want to use for your namespace.
* Specify whether to create a new **Resource group** for your namespace, or choose an existing resource group.
* Enter a unique **Namespace name**, which will become part of the URI for your event hub namespace. For example: if you entered *wingtiptoys-space* for the **Name**, the URI would be `wingtiptoys-space.servicebus.windows.net`.
* Specify the **Location** for your event hub namespace.
* Specify the **Pricing tier**, which will limit your usage scenarios.
* You can also specify the **Throughput units** for the namespace.
+
image::https://github.com/MicrosoftDocs/azure-dev-docs-pr/blob/ec384a549021ad5fd858ee0e57f0d65ec86f3be4/articles/java/spring-framework/media/configure-spring-cloud-stream-binder-java-app-kafka-azure-event-hub/create-kafka-event-hub-02.png[create-kafka-event-hub-02]

5. When you have specified the options listed above, select **Review + Create**.

6. Review the specification and select **Create** to create your namespace.

====== Create an Azure Event Hubs in your namespace

After your namespace is deployed, you can create an event hub in the namespace.

1. Navigate to the namespace created in the previous step.

2. Select **Event Hub** in top menu bar.

3. Name the event hub.

4. Select **Create**.

image::https://github.com/MicrosoftDocs/azure-dev-docs-pr/blob/ec384a549021ad5fd858ee0e57f0d65ec86f3be4/articles/java/spring-framework/media/configure-spring-cloud-stream-binder-java-app-kafka-azure-event-hub/create-kafka-event-hub-05.png[create-kafka-event-hub-05]

===== Grant permissions

Azure Event Hubs supports using Azure Active Directory (Azure AD) to authorize requests to Event Hubs resources. With Azure AD, you can use Azure role-based access control (Azure RBAC) to grant permissions to a security principal, which may be a user, or an application service principal.

For this sample to run locally, ensure your user account to have authenticated the account via Azure Toolkit for IntelliJ, Visual Studio Code Azure Account plugin, or Azure CLI and ensure the account granted the sufficient permissions.

NOTE: In this post, the data plane access role, `Azure Event Hubs Data Sender` and `Azure Event Hubs Data Receiver` need to be set.

For example, to authenticate using the Azure CLI, use the following steps:

1. Optionally, sign out and delete some authentication files to remove any lingering credentials:
+
[source,shell script]
----
   az logout
   rm ~/.azure/accessTokens.json
   rm ~/.azure/azureProfile.json
----

2. Sign in to your Azure account using the Azure CLI:
+
[source,shell script]
----
   az login
----
+
Follow the instructions to complete the sign-in process.

3. List your subscriptions:
+
[source,shell script]
----
   az account list
----
+
Azure will return a list of your subscriptions. Copy the `id` value for the subscription that you want to use; for example:
+
[source,json]
----
   [
     {
       "cloudName": "AzureCloud",
       "id": "ssssssss-ssss-ssss-ssss-ssssssssssss",
       "name": "Converted Windows Azure MSDN - Visual Studio Ultimate",
       "state": "Enabled",
       "tenantId": "tttttttt-tttt-tttt-tttt-tttttttttttt",
       "user": {
         "name": "contoso@microsoft.com",
         "type": "user"
       }
     }
   ]
----

4. Specify the GUID for the subscription you want to use with Azure; for example:

[source,shell script]
----
   az account set -s ssssssss-ssss-ssss-ssss-ssssssssssss
----

For details about granting access roles, refer to link:https://docs.microsoft.com/en-us/azure/event-hubs/authorize-access-azure-active-directory[Authorize access to Event Hubs resources using Azure Active Directory].

===== Create a Spring Boot application

1. Browse to <https://start.spring.io/>.

2. Specify the following options:

* Generate a **Maven** project with **Java**.
* Specify a **Spring Boot** version that is equal to **2.7.0**.
* Specify the **Group** and **Artifact** names for your application.
* Select **8** or **11** for the Java version.
* Add the **Web**, **Azure Support**, **Cloud Stream**, **Spring for Apache Kafka** dependency.
+
image::https://github.com/MicrosoftDocs/azure-dev-docs-pr/blob/ec384a549021ad5fd858ee0e57f0d65ec86f3be4/articles/java/spring-framework/media/spring-initializer/2.7.0/mvn-java8-azure-web-cloud-stream-kafka.png[mvn-java8-azure-web-cloud-stream-kafka]

+
NOTE: The Spring Initializr uses the **Group** and **Artifact** names to create the package name; for example: *com.wingtiptoys.kafka*.

3. When you have specified the options listed above, click **Generate Project**.

4. When prompted, download the project to a path on your local computer.

5. After you have extracted the files on your local system, your simple Spring Boot application will be ready for editing.

===== Update configuration

1. Add an *application.yaml* in the *resources* directory of your app; for example:
+
   *C:\SpringBoot\kafka\src\main\resources\application.yaml*
+
-or-
+
   */users/example/home/kafka/src/main/resources/application.yaml*

2. Open the *application.yaml* file in a text editor, add the following lines, and then replace the sample values with the appropriate properties for your event hub:
+
[source,yaml]
----
   spring:
     cloud:
       stream:
         kafka:
           binder:
             brokers: <NAMESPACENAME>.servicebus.windows.net:9093
         function:
           definition: consume;supply
         bindings:
           consume-in-0:
             destination: wingtiptoyshub
             group: $Default
           supply-out-0:
             destination: wingtiptoyshub
         binders:
           kafka:
             environment:
               spring:
                 main:
                   sources: com.azure.spring.cloud.autoconfigure.kafka.AzureKafkaSpringCloudStreamConfiguration
----
+
NOTE: That the property `spring.cloud.stream.binders.kafka.environment.spring.main.sources` is used for adding Spring Cloud Azure configuration for `KafkaBinderConfigurationPropertiesBeanPostProcessor` for each particular binder. The configuration is used for specifing the OAuth security parameters for `KafkaBinderConfigurationProperties` which is used in `KafkaOAuth2AuthenticateCallbackHandler` to take the Spring Cloud Azure token credentials. Following is the scenarios:
+
- When running locally for developing purpose, it will read the credential from local environments like IntelliJ, Visual Studio Code, or Azure CLI.
- When deployed to Azure Managed Identity enabled hosting environments, like `Azure Spring Apps`, it will load the credential from the Managed Identity.
+
[cols="2*", options="header"]
|===
|Property
|Description
| `spring.cloud.stream.kafka.binder.brokers`               | Specifies the Azure Event Hubs endpoint.
| `spring.cloud.stream.bindings.consume-in-0.destination`  | Specifies the input destination Azure Event Hubs, which for this tutorial is the hub you created earlier in this tutorial.
| `spring.cloud.stream.bindings.consume-in-0.group`       | Specifies a Consumer Group from Azure Event Hubs, which can be set to '$Default' in order to use the basic consumer group that was created when you created your Azure Event Hubs.
| `spring.cloud.stream.bindings.supply-out-0:.destination` | Specifies the output destination Azure Event Hubs, which for this tutorial will be the same as the input destination.
| `spring.cloud.stream.binders.kafka.environment.spring.main.sources` | Specifies additional configurations for the particular binder.
|===
+
NOTE: If you enable automatic topic creation, be sure to add the configuration item `spring.cloud.stream.kafka.binder.replicationFactor`, with the value set to at least 1. For more information, see link:https://docs.spring.io/spring-cloud-stream-binder-kafka/docs/3.1.2/reference/html/spring-cloud-stream-binder-kafka.html[Spring Cloud Stream Kafka Binder Reference Guide].

3. Save and close the *application.yaml* file.

===== Produce and consume messages

In this section, you create the necessary Java classes for sending events to your event hub.

====== Modify the main application class

1. Locate the main application Java file in the package directory of your app; for example:
+
   *C:\SpringBoot\kafka\src\main\java\com\wingtiptoys\kafka\EventhubApplication.java*
+
-or-
+
   */users/example/home/kafka/src/main/java/com/wingtiptoys/kafka/EventhubApplication.java*

2. Open the main application Java file in a text editor, and add the following lines to the file:
+
[source,java]
----
   package com.wingtiptoys.kafka;

   import org.slf4j.Logger;
   import org.slf4j.LoggerFactory;
   import org.springframework.boot.SpringApplication;
   import org.springframework.boot.autoconfigure.SpringBootApplication;
   import org.springframework.context.annotation.Bean;
   import org.springframework.messaging.Message;
   import reactor.core.publisher.Flux;
   import reactor.core.publisher.Sinks;

   import java.util.function.Consumer;
   import java.util.function.Supplier;

   @SpringBootApplication
   public class KafkaApplication {

       private static final Logger LOGGER = LoggerFactory.getLogger(KafkaApplication.class);

       public static void main(String[] args) {
           SpringApplication.run(KafkaApplication.class, args);
       }

       @Bean
       public Sinks.Many<Message<String>> many() {
           return Sinks.many().unicast().onBackpressureBuffer();
       }

       @Bean
       public Supplier<Flux<Message<String>>> supply(Sinks.Many<Message<String>> many) {
           return () -> many.asFlux()
                            .doOnNext(m -> LOGGER.info("Manually sending message {}", m))
                            .doOnError(t -> LOGGER.error("Error encountered", t));
       }

       @Bean
       public Consumer<Message<String>> consume() {
           return message -> LOGGER.info("New message received: '{}'", message.getPayload());
       }
   }
----

3. Save and close the main application Java file.


====== Create a new class for the source connector

1. Create a new Java file named *KafkaSource.java* in the package directory of your app, then open the file in a text editor and add the following lines:
+
[source,java]
----
   package com.wingtiptoys.kafka;

   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.messaging.Message;
   import org.springframework.messaging.support.GenericMessage;
   import org.springframework.web.bind.annotation.PostMapping;
   import org.springframework.web.bind.annotation.RequestParam;
   import org.springframework.web.bind.annotation.RestController;
   import reactor.core.publisher.Sinks;

   @RestController
   public class KafkaSource {

       @Autowired
       private Sinks.Many<Message<String>> many;

       @PostMapping("/messages")
       public String sendMessage(@RequestParam String message) {
           many.emitNext(new GenericMessage<>(message), Sinks.EmitFailureHandler.FAIL_FAST);
           return message;
       }
   }
----

2. Save and close the *KafkaSource.java* file.

===== Build and test

1. Open a command prompt and change directory to the folder where your *pom.xml* file is located; for example:
+
[source,shell script]
----
   cd C:\SpringBoot\kafka
----
+
-or-
+
[source,shell script]
----
   cd /users/example/home/kafka
----

2. Build your Spring Boot application with Maven and run it; for example:
+
[source,shell script]
----
   mvn clean package -Dmaven.test.skip=true
   mvn spring-boot:run
----

3. Once your application is running, you can use *curl* to test your application; for example:

[source,shell script]
----
   curl -X POST http://localhost:8080/messages?message=hello
----

You should see "hello" posted to your application's logs. For example:

[source,shell script]
----
   2021-06-02 14:47:13.956  INFO 23984 --- [oundedElastic-1] o.a.kafka.common.utils.AppInfoParser     : Kafka version: 2.6.0
   2021-06-02 14:47:13.957  INFO 23984 --- [oundedElastic-1] o.a.kafka.common.utils.AppInfoParser     : Kafka commitId: 62abe01bee039651
   2021-06-02 14:47:13.957  INFO 23984 --- [oundedElastic-1] o.a.kafka.common.utils.AppInfoParser     : Kafka startTimeMs: 1622616433956
   2021-06-02 14:47:16.668  INFO 23984 --- [container-0-C-1] com.wingtiptoys.kafka.KafkaApplication   : New message received: 'hello'
----

=====  Deploy to Azure Spring Apps

As above, we have tested and ran the application locally, however, in production, we can deploy the application to Azure hosting environments like `Azure Spring Apps`.

Azure Spring Apps is an Azure host with Managed Identity enabled and the application can be deployed to it for production. To connect with managed identities, you should enable the managed identity on Azure Spring Apps and grant the access permissions.

Please refer the following steps:

1. Create Azure Spring Apps and enable enable system-assigned managed identity, refer to link:https://docs.microsoft.com/azure/spring-cloud/how-to-enable-system-assigned-managed-identity?tabs=azure-portal[Enable system-assigned managed identity].

2. Assign roles to the managed identity, refer to link:https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal[Assign Azure roles].

3. For deployment, refer to link:https://docs.microsoft.com/azure/spring-cloud/how-to-maven-deploy-apps[Deploy Spring Boot applications using Maven].
