== Resource Handling

Spring project provides link:https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#resources[Spring Resources] abstraction to access a number of low-level resources. It provides interfaces like `Resource`, `ResourceLoader` and `ResourcePatternResolver`. Spring Cloud Azure implements these interfaces for Azure Storage Service which allows you to interact with Azure storage Blob and File Share using Spring programming model. It provides `spring-cloud-azure-starter-storage-blob` and `spring-cloud-azure-starter-storage-file-share` to auto-configure Azure Storage Blob and Azure Storage File Share.


.Azure Storage related libraries.
[cols="2,1,5", options="header"]
|===
|Starter 
|Service 
|Description

|spring-cloud-azure-starter-storage-blob
|Azure Blobs
|Allows unstructured data to be stored and accessed at a massive scale in block blobs.

|spring-cloud-azure-starter-storage-file-share
|Azure Files
|Offers fully managed cloud file shares that you can access from anywhere via the industry standard Server Message Block (SMB) protocol.
|===

=== Dependency Setup

[source,xml]
----
<dependencies>
    <dependency>
        <groupId>com.azure.spring</groupId>
        <artifactId>spring-cloud-azure-starter-storage-blob</artifactId> # <1>
    </dependency>
    <dependency>
        <groupId>com.azure.spring</groupId>
        <artifactId>spring-cloud-azure-starter-storage-file-share</artifactId> # <2>
    </dependency>
</dependencies>
----
<1> Only required when you're using Azure Storage Blob.
<2> Only required when you're using Azure Storage File Share.

=== Configuration

NOTE: If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to link:index.html#authorize-access-with-azure-active-directory[Authorize access with Azure AD] to make sure the security principal has been granted the sufficient permission to access the Azure resource.

.Configurable properties of spring-cloud-azure-starter-storage-blob
[cols="3,1,5", options="header"]
|===
|Property  |Default | Description

|*spring.cloud.azure.storage.blob*.enabled
|true
|Whether an Azure Blob Storage Service is enabled

|*spring.cloud.azure.storage.blob*.endpoint
|  
|Uri to connect Azure Blob Storage

|*spring.cloud.azure.storage.blob*.account-key
|  
|Private key to connect Azure Blob Storage

|*spring.cloud.azure.storage.blob*.account-name
|  
|Azure Storage Account Name
|===

.Configurable properties of spring-cloud-azure-starter-storage-file-share
[cols="3,1,5", options="header"]
|===
|Property  | Default | Description

|*spring.cloud.azure.storage.fileshare*.enabled
|true 
|Whether Azure File Storage Service is enabled

|*spring.cloud.azure.storage.fileshare*.endpoint
|  
|Uri to connect Azure File Storage

|*spring.cloud.azure.storage.fileshare*.account-key
|  
|Private key to connect Azure File Storage

|*spring.cloud.azure.storage.fileshare*.account-name
|  
|Azure Storage Account Name
|===


=== Basic Usage


Provide the properties below in your configuration file.

[source,yaml]
----
spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_PRIVATE_KEY}
          endpoint: ${STORAGE_BLOB_ENDPOINT}
        fileshare:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_PRIVATE_KEY}
          endpoint:  ${STORAGE_FILESHARE_ENDPOINT}
----

==== Get a resource 

===== Get a resource with @Value
You can use the annotation of `@Value("azure-blob://[your-container-name]/[your-blob-name]")` to autowire a blob Resource.
----
@Value("azure-blob://[your-container-name]/[your-blob-name]") 
private Resource storageResource;
----

You can use the annotation of @Value("azure-file://[your-fileshare-name]/[your-file-name]") to autowire a file Resource.

----
@Value("azure-file://[your-fileshare-name]/[your-file-name]") 
private Resource storageResource;
----

===== Get a resource with ResourceLoader

----
@Autowired
private ResourceLoader resourceLoader;
...
// get a BlobResource
Resource storageBlobResource = resourceLoader.getResource("azure-blob://[your-container-name]/[your-blob-name]");
// get a FileResource
Resource storageFileResource = resourceLoader.getResource("azure-file://[your-fileshare-name]/[your-file-name]");
----

===== Get resources by searching pattern
You can use implementation class `AzureStorageBlobProtocolResolver` of `ResourcePatternResolver` to search `blob` resource, and `AzureStorageFileProtocolResolver` of `ResourcePatternResolver` to search `file` resource

- Pattern search, the **searchPattern** should start with `azure-blob://` or `azure-file://`. Such as `azure-blob://**/**`, it means list all blobs in all containers; `azure-blob://demo-container/**`, it means list all blobs in the demo-container container, including any sub-folder.
- Location search, the **searchLocation** should start with `azure-blob://` or `azure-file://`, the remaining file path should exist, otherwise an exception will be thrown.

----
@Autowire 
private AzureStorageBlobProtocolResolver azureStorageBlobProtocolResolver;

@Autowire 
private AzureStorageFileProtocolResolver azureStorageFileProtocolResolver;

// get all text blobs
Resource[] blobTextResources = azureStorageBlobProtocolResolver.getResources("azure-blob://[container-pattern]/*.txt"); 
// get all text files
Resource[] fileTextResources = azureStorageFileProtocolResolver.getResources("azure-file://[fileshare-pattern]/*.txt"); 

----


==== Handling with resource 

===== Download data from specific resource.

You can download a resource from Azure Blob or file storage with the `getInputStream()` method of Resource.

----
@Value("azure-blob://[your-container-name]/[your-blob-name]") 
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]") 
private Resource storageFileResource;
....
// download data as stream from blob resource
InputStream inputblobStream = storageBlobResource.getInputStream();
// download data as stream from file resource
InputStream inputfileStream = storageFileResource.getInputStream();
----

===== Upload data to specific resource.

You can upload to a resource to Azure Blob or file storage by casting the Spring `Resource` to `WritableResource`.

----
@Value("azure-blob://[your-container-name]/[your-blob-name]") 
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]") 
private Resource storageFileResource;

String data = "sampledata";

// upload string data to blob
try (OutputStream blobos = ((WritableResource) this.storageBlobResource).getOutputStream()) {
  blobos.write(data.getBytes());
}
// upload string data to file
try (OutputStream fileos = ((WritableResource) this.storageFileResource).getOutputStream()) {
  fileos.write(data.getBytes());
}

----

#### Multipart upload
Files larger than 4 MiB will be uploaded to Azure Storage in parallel.

=== Samples

Please refer to link:https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0.0-beta.2/storage/spring-cloud-azure-starter-storage-blob/storage-blob-sample[storage-blob-sample] and link:https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0.0-beta.2/storage/spring-cloud-azure-starter-storage-file-share/storage-file-sample[storage-file-sample] for more details.
