<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Reference</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "b9g1q6wz23"); </script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Reference</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#getting-help">1. Getting Help</a></li>
<li><a href="#what-is-new-in-4-0-since-3-10-x">2. What Is New in 4.0 Since 3.10.x</a>
<ul class="sectlevel2">
<li><a href="#unified-development-experience">2.1. Unified Development Experience</a></li>
<li><a href="#simplified-dependency-management">2.2. Simplified Dependency Management</a></li>
<li><a href="#expanded-support-scope-of-azure-support-on-start-spring-io">2.3. Expanded Support Scope of Azure Support on start.spring.io</a></li>
<li><a href="#untethered-and-unrestrained">2.4. Untethered and Unrestrained</a></li>
<li><a href="#more-control-and-secure">2.5. More Control and Secure</a></li>
<li><a href="#more-options-exposed-in-a-spring-idiomatic-way">2.6. More Options Exposed in a Spring Idiomatic Way</a></li>
<li><a href="#more-production-ready">2.7. More Production Ready</a></li>
</ul>
</li>
<li><a href="#migration-guide-for-4-0">3. Migration Guide for 4.0</a></li>
<li><a href="#getting-started">4. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#setting-up-dependencies">4.1. Setting up Dependencies</a>
<ul class="sectlevel3">
<li><a href="#bill-of-material-bom">4.1.1. Bill of Material (BOM)</a></li>
<li><a href="#starter-dependencies">4.1.2. Starter Dependencies</a></li>
</ul>
</li>
<li><a href="#learning-spring-cloud-azure">4.2. Learning Spring Cloud Azure</a></li>
</ul>
</li>
<li><a href="#configuration">5. Configuration</a></li>
<li><a href="#authentication">6. Authentication</a>
<ul class="sectlevel2">
<li><a href="#defaultazurecredential">6.1. DefaultAzureCredential</a></li>
<li><a href="#managed-identities">6.2. Managed Identities</a>
<ul class="sectlevel3">
<li><a href="#managed-identity-types">6.2.1. Managed Identity Types</a></li>
</ul>
</li>
<li><a href="#other-credential-types">6.3. Other Credential Types</a>
<ul class="sectlevel3">
<li><a href="#authentication-and-authorization-with-azure-active-directory">6.3.1. Authentication and Authorization with Azure Active Directory</a>
<ul class="sectlevel4">
<li><a href="#authenticate-with-azure-active-directory">Authenticate with Azure Active Directory</a></li>
<li><a href="#authorize-access-with-azure-active-directory">Authorize Access with Azure Active Directory</a></li>
</ul>
</li>
<li><a href="#sas-tokens">6.3.2. SAS tokens</a></li>
<li><a href="#connection-strings">6.3.3. Connection Strings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#production-ready">7. Production Ready</a>
<ul class="sectlevel2">
<li><a href="#enable-health-indicator">7.1. Enable Health Indicator</a></li>
<li><a href="#enable-sleuth">7.2. Enable Sleuth</a></li>
</ul>
</li>
<li><a href="#autoconfigure-azure-sdk-clients">8. Autoconfigure Azure SDK Clients</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup">8.1. Dependency Setup</a></li>
<li><a href="#configuration-2">8.2. Configuration</a></li>
<li><a href="#basic-usage">8.3. Basic Usage</a></li>
<li><a href="#samples">8.4. Samples</a></li>
</ul>
</li>
<li><a href="#resource-handling">9. Resource Handling</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-2">9.1. Dependency Setup</a></li>
<li><a href="#configuration-3">9.2. Configuration</a></li>
<li><a href="#basic-usage-2">9.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#get-a-resource">9.3.1. Get a Resource</a>
<ul class="sectlevel4">
<li><a href="#get-a-resource-with-value">Get a Resource with @Value</a></li>
<li><a href="#get-a-resource-with-resourceloader">Get a Resource with ResourceLoader</a></li>
<li><a href="#get-resources-by-searching-pattern">Get Resources by Searching Pattern</a></li>
</ul>
</li>
<li><a href="#handling-with-resource">9.3.2. Handling with Resource</a>
<ul class="sectlevel4">
<li><a href="#download-data-from-specific-resource">Download Data from Specific Resource</a></li>
<li><a href="#upload-data-to-specific-resource">Upload Data to Specific Resource</a></li>
</ul>
</li>
<li><a href="#multipart-upload">9.3.3. Multipart Upload</a></li>
</ul>
</li>
<li><a href="#samples-2">9.4. Samples</a></li>
</ul>
</li>
<li><a href="#secret-management">10. Secret Management</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-3">10.1. Dependency Setup</a></li>
<li><a href="#basic-usage-3">10.2. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#configuration-properties">10.2.1. Configuration Properties</a></li>
<li><a href="#java-code">10.2.2. Java Code</a></li>
</ul>
</li>
<li><a href="#advanced-usage">10.3. Advanced Usage</a>
<ul class="sectlevel3">
<li><a href="#special-characters-in-property-name">10.3.1. Special Characters in Property Name</a></li>
<li><a href="#case-sensitive">10.3.2. Case Sensitive</a></li>
<li><a href="#not-retrieve-all-secrets-in-key-vault">10.3.3. Not Retrieve All Secrets In Key Vault</a></li>
<li><a href="#setting-refresh-interval">10.3.4. Setting Refresh Interval</a></li>
<li><a href="#propertysource-priority">10.3.5. PropertySource Priority</a></li>
<li><a href="#all-configurable-properties">10.3.6. All Configurable Properties</a></li>
</ul>
</li>
<li><a href="#samples-3">10.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-data-support">11. Spring Data Support</a>
<ul class="sectlevel2">
<li><a href="#spring-data-cosmosdb-support">11.1. Spring Data CosmosDB Support</a></li>
<li><a href="#dependency-setup-4">11.2. Dependency Setup</a></li>
<li><a href="#configuration-4">11.3. Configuration</a></li>
<li><a href="#key-concepts">11.4. Key Concepts</a></li>
<li><a href="#basic-usage-4">11.5. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-private-key-to-access-cosmosdb">11.5.1. Use Private Key to Access CosmosDB</a></li>
<li><a href="#define-an-entity">11.5.2. Define an Entity</a></li>
<li><a href="#create-repositories">11.5.3. Create Repositories</a></li>
<li><a href="#create-an-application-class">11.5.4. Create an Application Class</a></li>
</ul>
</li>
<li><a href="#samples-4">11.6. Samples</a></li>
</ul>
</li>
<li><a href="#spring-security-support">12. Spring Security Support</a>
<ul class="sectlevel2">
<li><a href="#spring-security-with-azure-active-directory">12.1. Spring Security With Azure Active Directory</a>
<ul class="sectlevel3">
<li><a href="#accessing-a-web-application">12.1.1. Accessing a Web Application</a>
<ul class="sectlevel4">
<li><a href="#system-diagram">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies">Add Required Dependencies</a></li>
<li><a href="#add-required-properties">Add Required Properties</a></li>
<li><a href="#advanced-usages">Advanced Usages</a></li>
<li><a href="#samples-5">Samples</a></li>
</ul>
</li>
<li><a href="#web-application-accessing-resource-servers">12.1.2. Web Application Accessing Resource Servers</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-2">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-2">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-2">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-2">Add Required Properties</a></li>
<li><a href="#use-oauth2authorizedclient-in-your-application">Use OAuth2AuthorizedClient in Your Application</a></li>
<li><a href="#advanced-usages-2">Advanced Usages</a></li>
<li><a href="#samples-6">Samples</a></li>
</ul>
</li>
<li><a href="#accessing-a-resource-server">12.1.3. Accessing a Resource Server</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-3">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-3">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-3">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-3">Add Required Properties</a></li>
<li><a href="#advanced-usages-3">Advanced Usages</a></li>
<li><a href="#samples-7">Samples</a></li>
</ul>
</li>
<li><a href="#resource-server-visiting-other-resource-servers">12.1.4. Resource Server Visiting Other Resource Servers</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-4">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-4">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-4">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-4">Add Required Properties</a></li>
<li><a href="#use-oauth2authorizedclient-in-your-application-2">Use OAuth2AuthorizedClient in Your Application</a></li>
<li><a href="#samples-8">Samples</a></li>
</ul>
</li>
<li><a href="#web-application-and-resource-server-in-one-application">12.1.5. Web Application and Resource Server in One Application</a>
<ul class="sectlevel4">
<li><a href="#create-required-resources-in-azure-5">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-5">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-5">Add Required Properties</a></li>
<li><a href="#define-securityconfigurationadapter">Define SecurityConfigurationAdapter</a></li>
</ul>
</li>
<li><a href="#configuration-5">12.1.6. Configuration</a>
<ul class="sectlevel4">
<li><a href="#application-type">Application Type</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-security-with-azure-active-directory-b2c">12.2. Spring Security With Azure Active Directory B2C</a>
<ul class="sectlevel3">
<li><a href="#dependency-setup-5">12.2.1. Dependency Setup</a></li>
<li><a href="#configuration-6">12.2.2. Configuration</a></li>
<li><a href="#basic-usage-5">12.2.3. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#usage-1-accessing-a-web-application">Usage 1: Accessing a Web Application</a></li>
<li><a href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a></li>
<li><a href="#usage-3-accessing-a-resource-server">Usage 3: Accessing a Resource Server</a></li>
<li><a href="#usage-4-resource-server-accessing-other-resource-servers">Usage 4: Resource Server Accessing Other Resource Servers</a></li>
</ul>
</li>
<li><a href="#samples-9">12.2.4. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-integration-support">13. Spring Integration Support</a>
<ul class="sectlevel2">
<li><a href="#spring-integration-with-azure-event-hubs">13.1. Spring Integration with Azure Event Hubs</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-2">13.1.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#consumer-group">Consumer Group</a></li>
<li><a href="#partitioning-support">Partitioning Support</a></li>
<li><a href="#batch-consumer-support">Batch Consumer Support</a></li>
</ul>
</li>
<li><a href="#dependency-setup-6">13.1.2. Dependency Setup</a></li>
<li><a href="#configuration-7">13.1.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties">Connection Configuration Properties</a></li>
<li><a href="#checkpoint-configuration-properties">Checkpoint Configuration Properties</a></li>
<li><a href="#event-hub-processor-configuration-properties">Event Hub Processor Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-6">13.1.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-event-hubs">Send messages to Azure Event Hubs</a></li>
<li><a href="#receive-from-eh">Receive Messages from Azure Event Hubs</a></li>
<li><a href="#configure-eventhubsmessageconverter-to-customize-objectmapper">Configure EventHubsMessageConverter to Customize ObjectMapper</a></li>
<li><a href="#si-eh-batch">Batch Consumer Support</a></li>
<li><a href="#si-eh-headers">Event Hubs Message Headers</a></li>
</ul>
</li>
<li><a href="#samples-10">13.1.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-integration-with-azure-service-bus">13.2. Spring Integration with Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-3">13.2.1. Key Concepts</a></li>
<li><a href="#dependency-setup-7">13.2.2. Dependency Setup</a></li>
<li><a href="#configuration-8">13.2.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties-2">Connection Configuration Properties</a></li>
<li><a href="#service-bus-processor-configuration-properties">Service Bus Processor Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-7">13.2.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-service-bus">Send Messages to Azure Service Bus</a></li>
<li><a href="#receive-from-sb">Receive Messages from Azure Service Bus</a></li>
<li><a href="#configure-servicebusmessageconverter-to-customize-objectmapper">Configure ServiceBusMessageConverter to Customize ObjectMapper</a></li>
<li><a href="#si-sb-headers">Service Bus Message Headers</a></li>
<li><a href="#partition-key-support">Partition Key Support</a></li>
<li><a href="#session-support">Session Support</a></li>
</ul>
</li>
<li><a href="#samples-11">13.2.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-integration-with-azure-storage-queue">13.3. Spring Integration with Azure Storage Queue</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-4">13.3.1. Key Concepts</a></li>
<li><a href="#dependency-setup-8">13.3.2. Dependency Setup</a></li>
<li><a href="#configuration-9">13.3.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties-3">Connection Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-8">13.3.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-storage-queue">Send messages to Azure Storage Queue</a></li>
<li><a href="#receive-messages-from-azure-storage-queue">Receive Messages from Azure Storage Queue</a></li>
</ul>
</li>
<li><a href="#samples-12">13.3.5. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-cloud-stream-support">14. Spring Cloud Stream Support</a>
<ul class="sectlevel2">
<li><a href="#spring-cloud-stream-binder-for-azure-event-hubs">14.1. Spring Cloud Stream Binder for Azure Event Hubs</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-5">14.1.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#consumer-group-2">Consumer Group</a></li>
<li><a href="#partitioning-support-2">Partitioning Support</a></li>
<li><a href="#batch-consumer-support-2">Batch Consumer Support</a></li>
</ul>
</li>
<li><a href="#dependency-setup-9">14.1.2. Dependency Setup</a></li>
<li><a href="#configuration-10">14.1.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#eventhubs-connection-configuration">Connection Configuration Properties</a></li>
<li><a href="#checkpoint-configuration-properties-2">Checkpoint Configuration Properties</a></li>
<li><a href="#azure-event-hubs-binding-configuration-properties">Azure Event Hubs Binding Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-9">14.1.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#sending-and-receiving-messages-fromto-event-hubs">Sending and Receiving Messages from/to Event Hubs</a></li>
<li><a href="#partitioning-support-3">Partitioning Support</a></li>
<li><a href="#batch-consumer-support-3">Batch Consumer Support</a></li>
<li><a href="#error-channels">Error Channels</a></li>
<li><a href="#scs-eh-headers">Event Hubs Message Headers</a></li>
<li><a href="#multiple-binder-support">Multiple Binder Support</a></li>
<li><a href="#resource-provision">Resource Provision</a></li>
</ul>
</li>
<li><a href="#samples-13">14.1.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-cloud-stream-binder-for-azure-service-bus">14.2. Spring Cloud Stream Binder for Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-6">14.2.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#scheduled-message">Scheduled Message</a></li>
<li><a href="#consumer-group-3">Consumer Group</a></li>
</ul>
</li>
<li><a href="#dependency-setup-10">14.2.2. Dependency Setup</a></li>
<li><a href="#configuration-11">14.2.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#servicebus-connection-configuration">Connection Configuration Properties</a></li>
<li><a href="#azure-service-bus-binding-configuration-properties">Azure Service Bus Binding Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-10">14.2.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#sending-and-receiving-messages-fromto-service-bus">Sending and Receiving Messages from/to Service Bus</a></li>
<li><a href="#partition-key-support-2">Partition Key Support</a></li>
<li><a href="#session-support-2">Session Support</a></li>
<li><a href="#error-channels-2">Error Channels</a></li>
<li><a href="#scs-sb-headers">Service Bus Message Headers</a></li>
<li><a href="#multiple-binder-support-2">Multiple Binder Support</a></li>
<li><a href="#resource-provision-2">Resource Provision</a></li>
</ul>
</li>
<li><a href="#samples-14">14.2.5. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-jms-support">15. Spring JMS Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-11">15.1. Dependency Setup</a></li>
<li><a href="#configuration-12">15.2. Configuration</a></li>
<li><a href="#basic-usage-11">15.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-service-bus-connection-string">15.3.1. Use Service Bus Connection String</a></li>
</ul>
</li>
<li><a href="#samples-15">15.4. Samples</a></li>
</ul>
</li>
<li><a href="#kafka-support">16. Kafka Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-12">16.1. Dependency Setup</a></li>
<li><a href="#configuration-13">16.2. Configuration</a></li>
<li><a href="#basic-usage-12">16.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-event-hubs-connection-string">16.3.1. Use Event Hubs Connection String</a></li>
<li><a href="#use-azure-resource-manager-to-retrieve-connection-string">16.3.2. Use Azure Resource Manager to Retrieve Connection String</a></li>
</ul>
</li>
<li><a href="#samples-16">16.4. Samples</a></li>
</ul>
</li>
<li><a href="#redis-support">17. Redis Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-13">17.1. Dependency Setup</a></li>
<li><a href="#configuration-14">17.2. Configuration</a></li>
<li><a href="#basic-usage-13">17.3. Basic Usage</a></li>
<li><a href="#samples-17">17.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-cloud-azure-resourcemanager">18. Resource Manager</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-14">18.1. Dependency Setup</a></li>
<li><a href="#configuration-15">18.2. Configuration</a></li>
<li><a href="#resource-manager-basic-usage">18.3. Basic Usage</a></li>
<li><a href="#samples-18">18.4. Samples</a></li>
</ul>
</li>
<li><a href="#configuration-properties-2">19. Configuration Properties</a></li>
<li><a href="#appendix">20. Appendix</a>
<ul class="sectlevel2">
<li><a href="#configuration-properties-3">20.1. Configuration properties</a></li>
<li><a href="#migration-guide-for-4-0-2">20.2. Migration guide for 4.0</a></li>
<li><a href="#known-issues">20.3. Known issues</a></li>
</ul>
</li>
<li><a href="#spring-boot">21. Spring Boot</a></li>
<li><a href="#spring-project-references">22. Spring Project References</a></li>
<li><a href="#spring-boot-starters-for-azure">23. Spring Boot Starters for Azure</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document is only for Spring Cloud Azure: <strong>{project-version}</strong>. Please refer to <a href="https://github.com/Azure/azure-sdk-for-java/wiki/Spring-Versions-Mapping">Spring Versions Mapping</a> to get more information about supported versions.</p>
</div>
<div class="paragraph">
<p>&#169; 2016-2022 the original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring is an open-source application framework developed by VMware that provides a simplified, modular approach for creating Java applications. Spring Cloud Azure is an open-source project that provides seamless Spring integration with Azure services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-help"><a class="anchor" href="#getting-help"></a>1. Getting Help</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have any questions about this document, please ask by creating GitHub issues. And Pull Request is welcome.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 1. GitHub repositories</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">GitHub repositories</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_{project-version}/sdk/spring">Azure/azure-sdk-for-java</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the source code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/microsoft/spring-cloud-azure">microsoft/spring-cloud-azure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the document which is displaying in current page.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="what-is-new-in-4-0-since-3-10-x"><a class="anchor" href="#what-is-new-in-4-0-since-3-10-x"></a>2. What Is New in 4.0 Since 3.10.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page covers changes made in 4.0 since 3.10. With this major release, we aim to bring better security, leaner dependencies, support for production readiness, and more.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="unified-development-experience"><a class="anchor" href="#unified-development-experience"></a>2.1. Unified Development Experience</h3>
<div class="paragraph">
<p>We constantly challenge ourselves on how we can make things more consistent and easier to understand, so our customers are not confronted with haphazard development choices. This is a long and self-evolving journey as consistency is relative and there will be things that are outside our control. We now humbly take another step in this direction to improve our developer experience by unifying project name, artifact ID and properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="simplified-dependency-management"><a class="anchor" href="#simplified-dependency-management"></a>2.2. Simplified Dependency Management</h3>
<div class="paragraph">
<p>Dependency management is one of the core value pillars that has helped Spring establish preeminence over to other Java frameworks. In that spirit, we have also been exploring ways to make dependency management easier for Spring developers on Azure. In this release, we have codified best practices and expertise from Spring experts and condensed all of our dependency BOMs into one, <code>spring-cloud-azure-dependencies</code>, which we believe will further bring down the learning curve and avoid ill-handling of dependencies.</p>
</div>
</div>
<div class="sect2">
<h3 id="expanded-support-scope-of-azure-support-on-start-spring-io"><a class="anchor" href="#expanded-support-scope-of-azure-support-on-start-spring-io"></a>2.3. Expanded Support Scope of Azure Support on start.spring.io</h3>
<div class="paragraph">
<p>The Azure Support module in <a href="https://start.spring.io">Spring Initializr</a> provides auto-configuration of many Azure services.</p>
</div>
<div class="paragraph">
<p>In this release we have expanded the scope of Azure Support to cover the additional 4 more services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>Event Hubs</p>
</li>
<li>
<p>Azure Cache for Redis</p>
</li>
<li>
<p>App Configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our journey does end here and over time we will bring even more Azure services into the fold.</p>
</div>
</div>
<div class="sect2">
<h3 id="untethered-and-unrestrained"><a class="anchor" href="#untethered-and-unrestrained"></a>2.4. Untethered and Unrestrained</h3>
<div class="paragraph">
<p>One feedback that we consistently hear is our Spring modules are unnecessarily stacked on top of too many layers of dependencies, which has prevented broader adoption. As an example, all of our early Spring modules rely on Spring Boot, and many of our customers are running Spring MVC apps in Tomcat, leveraging nothing but Spring Data, as an example, to communicate with data services. We now realize the flaw in our original design, and have rearchitected our Spring module dependencies from the ground up, untethered from layers of excess and entanglement.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-control-and-secure"><a class="anchor" href="#more-control-and-secure"></a>2.5. More Control and Secure</h3>
<div class="paragraph">
<p>At the heart of every real-world application, is identity and secret management. Support for managed identity has become an Azure fundamental that are getting mandated as a security baseline at individual services. We believe aligning on those guidelines will also benefit Spring developers at large, and have added Managed Identity support for App Configuration, Event Hub, Service Bus, Cosmos, Key Vault, Storage Blob, and Storage Queue. This enables building credential-free applications, which is a pattern that has picked up tremendous momentum both at Microsoft and in the community. In addition to Managed Identity, you can use any authentication methods supported in the underlying Azure SDK from our Spring libraries. For instance, you use SAS token and token credential to authenticate with Service Bus and Event Hubs. <a href="https://docs.microsoft.com/java/api/overview/azure/identity-readme?view=azure-java-stable#defaultazurecredential">Credential chain</a> is now enabled by default, allowing applications to obtain credentials from application properties, environment variables, managed identity, IDEs, etc. Lastly providing granular level access control at the resource level (i.e.: Service Bus queue), is often of paramount importance when it comes to meeting the needs of our enterprise customers. We’ve now unlocked these controls to our customers for better security governance and adherence to IT policies.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-options-exposed-in-a-spring-idiomatic-way"><a class="anchor" href="#more-options-exposed-in-a-spring-idiomatic-way"></a>2.6. More Options Exposed in a Spring Idiomatic Way</h3>
<div class="paragraph">
<p>Spring developers have long enjoyed the convenience of defining client options in application configuration files. We certainly do not want to take that privilege away and burden Spring developers with setting options via client objects. To that end, we’ve significantly improved autoconfiguration coverage of Azure SDK clients for both synchronous and asynchronous scenarios.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-production-ready"><a class="anchor" href="#more-production-ready"></a>2.7. More Production Ready</h3>
<div class="paragraph">
<p>Lastly all the above would be in vain if we do not have enough feature coverage to support our customers in production. Many things come to my mind to make an application production-ready, but observability often arrives at the top. We’ve added health indicators for App Configuration, Event Hubs, Cosmos, Key Vault, Storage Blob, Storage Queue, Storage File, as well as Spring Cloud Sleuth support for all HTTP-based Azure SDKs. As an example, you now can prob if storage blob is up or down via Spring Boot actuator endpoint, as well as track dependencies and latencies going from your application to Cosmos DB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migration-guide-for-4-0"><a class="anchor" href="#migration-guide-for-4-0"></a>3. Migration Guide for 4.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>4. Getting Started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="setting-up-dependencies"><a class="anchor" href="#setting-up-dependencies"></a>4.1. Setting up Dependencies</h3>
<div class="sect3">
<h4 id="bill-of-material-bom"><a class="anchor" href="#bill-of-material-bom"></a>4.1.1. Bill of Material (BOM)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
      &lt;version&gt;version&lt;/version&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The version for spring-cloud-azure-dependencies is {project-version}.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="starter-dependencies"><a class="anchor" href="#starter-dependencies"></a>4.1.2. Starter Dependencies</h4>
<div class="paragraph">
<p>Spring Cloud Azure Starters are a set of convenient dependency descriptors to include in your application. Each starter includes all the dependencies and transitive dependencies needed to begin using its corresponding Spring Cloud Azure module. They boost your Spring Boot application development with Azure services.</p>
</div>
<div class="paragraph">
<p>For example, if you want to get started using Azure Cosmos DB for data persistence, include the <code>spring-cloud-azure-starter-cosmos</code> dependency in your project.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Azure provides the following starters under the <code>com.azure.spring</code> group:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Spring Cloud Azure starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core starter, including autoconfiguration support</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory-b2c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory B2C with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-appconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure App Configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault-secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Key Vault Secrets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus-jms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and JMS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Blob</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage File Share</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-actuator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Spring Boot’s Actuator which provides production ready features</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Data</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Spring Data related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-data-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB and Spring Data Cosmos DB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Integration</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Spring Integration related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue and Spring Integration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Cloud Stream</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Spring Cloud Stream related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starters for using Azure Event Hubs and Spring Cloud Stream Binder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Cloud Stream Binder</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="learning-spring-cloud-azure"><a class="anchor" href="#learning-spring-cloud-azure"></a>4.2. Learning Spring Cloud Azure</h3>
<div class="paragraph">
<p>We prepared a full list of samples to show the usages, can be found at <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">Spring Cloud Azure Samples</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>5. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of Azure SDKs could be divided into two categories by transport type, HTTP-based and AMQP-based. There are properties that are common to all SDKs such as authentication principals and Azure environment settings. Or common to HTTP-based clients, such as logging level to log HTTP requests and responses. Spring Cloud Azure 4.0 provides five common categories of configuration properties, which could be specified to each Azure service.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Service common properties</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients underneath one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to one Azure service SDK. The retry options has supported part of the SDKs, there&#8217;s no <code>spring.cloud.azure.cosmos.retry</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are some properties that could be shared among different Azure services, for example using the same service principal to access Azure Cosmos DB and Azure Event Hubs. Spring Cloud Azure 4.0 allows application developers to specify properties that apply to all Azure SDKs with the prefix <code>spring.cloud.azure</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Global properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients apply to all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options apply to all Azure SDK clients by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to all Azure SDK clients by default.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties configured under each Azure service will override the global configurations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Cloud Azure unifies configuration properties' prefixes to <code>spring.cloud.azure</code> since 4.0, which will make configuration properties more consistent and more intuitive. Here&#8217;s a quick review of the serivce specific properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Service specific properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Configuration Property Prefix</th>
<th class="tableblock halign-left valign-top">Configuration Properties Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>appconfiguration</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_app_configuration_proeprties">App Configuration Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>cosmos</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_cosmos_proeprties">Cosmos Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>eventhubs</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_event_hubs_proeprties">Event Hubs Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.certificate</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_key_vault_certificates_proeprties">Key Vault Certificates Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.secret</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_key_vault_secrets_proeprties">Key Vault Secrets Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>servicebus</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_service_bus_proeprties">Service Bus Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.blob</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_blob_proeprties">Storage Blob Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.fileshare</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_file_share_proeprties">Storage File Share Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.queue</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_queue_proeprties">Storage Queue Properties</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a>6. Authentication</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defaultazurecredential"><a class="anchor" href="#defaultazurecredential"></a>6.1. DefaultAzureCredential</h3>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> is appropriate for most scenarios where the application is intended to be run in the Azure Cloud. This is because the DefaultAzureCredential combines credentials commonly used to authenticate when deployed, with credentials used to authenticate in a development environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DefaultAzureCredential is intended to simplify getting started with the SDK by handling common scenarios with reasonable default behaviors. Developers who want more control or whose scenario isn&#8217;t served by the default settings should use other credential types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> will attempt to authenticate via the following mechanisms in order.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://user-images.githubusercontent.com/13167207/143148654-f3a37180-85e2-4360-a47d-c1af2da8fada.png" alt="DefaultAzureCredential">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment - The <code>DefaultAzureCredential</code> will read account information specified via environment variables and use it to authenticate.</p>
</li>
<li>
<p>Managed Identity - If the application is deployed to an Azure host with Managed Identity enabled, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>IntelliJ - If the developer has authenticated via Azure Toolkit for IntelliJ, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Visual Studio Code - If the developer has authenticated via the Visual Studio Code Azure Account plugin, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Azure CLI - If the developer has authenticated an account via the Azure CLI az login command, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-identities"><a class="anchor" href="#managed-identities"></a>6.2. Managed Identities</h3>
<div class="paragraph">
<p>A common challenge for developers is the management of secrets and credentials used to secure communication between different components making up a solution. Managed identities eliminate the need for developers to manage credentials. Managed identities provide an identity for applications to use when connecting to resources that support Azure Active Directory (Azure AD) authentication. Applications may use the managed identity to obtain Azure AD tokens. For example, an application may use a managed identity to access resources like Azure Key Vault where developers can store credentials in a secure manner or to access storage accounts.</p>
</div>
<div class="paragraph">
<p>We encourage using managed identity instead of using connection string or key in your application for it&#8217;s more secure and will save the trouble of managing secrets and credentials. In this case, <code>DefaultAzureCredential</code> could better serve the scenario of developing locally using account information stored locally and deploying the application to Azure Cloud and using Managed Identity.</p>
</div>
<div class="sect3">
<h4 id="managed-identity-types"><a class="anchor" href="#managed-identity-types"></a>6.2.1. Managed Identity Types</h4>
<div class="paragraph">
<p>There are two types of managed identities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System-assigned</strong> Some Azure services allow you to enable a managed identity directly on a service instance. When you enable a system-assigned managed identity an identity is created in Azure AD that&#8217;s tied to the lifecycle of that service instance. So when the resource is deleted, Azure automatically deletes the identity for you. By design, only that Azure resource can use this identity to request tokens from Azure AD.</p>
</li>
<li>
<p><strong>User-assigned</strong> You may also create a managed identity as a standalone Azure resource. You can create a user-assigned managed identity and assign it to one or more instances of an Azure service. In the case of user-assigned managed identities, the identity is managed separately from the resources that use it.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using a user-assigned managed identity, you can specify the client ID by <code>spring.cloud.azure.credential.client-id</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential.client-id</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a> for more details about managed identity.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="other-credential-types"><a class="anchor" href="#other-credential-types"></a>6.3. Other Credential Types</h3>
<div class="paragraph">
<p>Developers who want more control or whose scenario isn&#8217;t served by the <code>DefaultAzureCredential</code> or whose scenario isn&#8217;t served by the default settings should use other credential types.</p>
</div>
<div class="sect3">
<h4 id="authentication-and-authorization-with-azure-active-directory"><a class="anchor" href="#authentication-and-authorization-with-azure-active-directory"></a>6.3.1. Authentication and Authorization with Azure Active Directory</h4>
<div class="paragraph">
<p>With Azure AD, you can use Azure role-based access control (Azure RBAC) to grant permissions to a security principal, which may be a user or an application service principal. When a security principal (a user, or an application) attempts to access an Azure resource, for example, an Event Hubs resource, the request must be authorized. With Azure AD, access to a resource is a two-step process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, the security principal&#8217;s identity is authenticated, and an OAuth 2.0 token is returned.</p>
</li>
<li>
<p>Next, the token is passed as part of a request to the Azure service to authorize access to the specified resource.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="authenticate-with-azure-active-directory"><a class="anchor" href="#authenticate-with-azure-active-directory"></a>Authenticate with Azure Active Directory</h5>
<div class="paragraph">
<p>For applications want to connect to resources that support Azure AD authentication, below configurations could be set with prefix <code>spring.cloud.azure.credential</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Authentication properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="authorize-access-with-azure-active-directory"><a class="anchor" href="#authorize-access-with-azure-active-directory"></a>Authorize Access with Azure Active Directory</h5>
<div class="paragraph">
<p>The authorization step requires that one or more Azure roles be assigned to the security principal. The roles that are assigned to a security principal decide the permissions that the principal will have.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Azure built-in roles please check <a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles">Azure built-in roles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Following are the Azure built-in roles for authorizing access to Azure services supported in Spring Cloud Azure:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Azure built-in roles</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-owner">App Configuration Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows full access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-reader">App Configuration Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows read access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-owner">Azure Event Hubs Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-receiver">Azure Event Hubs Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows receive access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-send">Azure Event Hubs Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows send access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-owner">Azure Service Bus Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-receiver">Azure Service Bus Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for receive access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-sender">Azure Service Bus Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for send access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-owner">Storage Blob Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides full access to Azure Storage blob containers and data, including assigning POSIX access control.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-reader">Storage Blob Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage containers and blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-queue-data-reader">Storage Queue Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage queues and queue messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#redis-cache-contributor">Redis Cache Contributor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Redis caches.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using Spring Cloud Azure Resource Manager to get the connection strings of Event Hubs, Service Bus, and Storage Queue, or properties of Cache for Redis, assign the Azure built-in role <code>Contributor</code>. Azure Cache for Redis is special, and you can also assign the <code>Redis Cache Contributor</code> role to get the Redis properties.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Key Vault access policy determines whether a given security principal, namely a user, application or user group, can perform different operations on Key Vault secrets, keys, and certificates. You can assign access policies using the Azure portal, the Azure CLI, or Azure PowerShell. Check <a href="https://docs.microsoft.com/azure/key-vault/general/assign-access-policy">here</a> for more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Azure Cosmos DB exposes 2 built-in role definitions: <code>Cosmos DB Built-in Data Reader</code> and <code>Cosmos DB Built-in Data Contributor</code>. However, Azure portal support for role management isn&#8217;t available yet. Check <a href="https://docs.microsoft.com/azure/cosmos-db/how-to-setup-rbac">here</a> for more details about the permission model, role definitions, and role assignment.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sas-tokens"><a class="anchor" href="#sas-tokens"></a>6.3.2. SAS tokens</h4>
<div class="paragraph">
<p>It&#8217;s also configurable for services support authenticating with Shared Access Signature (SAS). <code>spring.cloud.azure.&lt;azure-service&gt;.sas-token</code> is the property to configure. For example, using <code>spring.cloud.azure.storage.blob.sas-token</code> to authenticate to Storage Blob service.</p>
</div>
</div>
<div class="sect3">
<h4 id="connection-strings"><a class="anchor" href="#connection-strings"></a>6.3.3. Connection Strings</h4>
<div class="paragraph">
<p>Connection strings are supported by some Azure services to provide connection information as well as credentials. To connect to those Azure services using a connection string, just configure <code>spring.cloud.azure.&lt;azure-service&gt;.connection-string</code> will do. For example, <code>spring.cloud.azure.eventhubs.connection-string</code> to connect to Event Hubs service.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="production-ready"><a class="anchor" href="#production-ready"></a>7. Production Ready</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure 4.0 supports health indicators for App Configuration, Event Hubs, Cosmos, Key Vault Certificate, Key Vault Secret, Storage Blob, Storage Queue, and Storage File Share. It also provides integrations with Spring Cloud Sleuth for all HTTP-based Azure SDKs. As an example, you now can prob if storage blob is up or down via Spring Boot actuator endpoint, as well as track dependencies and latencies going from your application to Key Vault.</p>
</div>
<div class="sect2">
<h3 id="enable-health-indicator"><a class="anchor" href="#enable-health-indicator"></a>7.1. Enable Health Indicator</h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Actuator Starter dependency. This dependency will also include the <code>spring-boot-starter-actuator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Configurable properties to enable or disable health indicators for each Azure service</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Property</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-appconfiguration</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-cosmos</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-eventhubs</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-certificate</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-secret</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-blob</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-fileshare</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-queue</strong>.enabled</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Calling the health endpoint of Azure services may cause extra charge. For example, calling <code><a href="http://HOST_NAME:{port}/actuator/health/cosmos" class="bare">HOST_NAME:{port}/actuator/health/cosmos</a></code> to get the Cosmos DB health info, it will calculate <a href="https://docs.microsoft.com/azure/cosmos-db/request-units">RUs</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="enable-sleuth"><a class="anchor" href="#enable-sleuth"></a>7.2. Enable Sleuth</h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Trace Sleuth dependency when you want to trace Azure SDK activities with using Spring Cloud Sleuth.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-trace-sleuth&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only HTTP-based Azure SDK clients are supported now, for example, Eventhub and ServiceBus with AMQP transport are currently not supported, we recommend to use <a href="https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview">Azure Application Insights</a> for such requirement.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="autoconfigure-azure-sdk-clients"><a class="anchor" href="#autoconfigure-azure-sdk-clients"></a>8. Autoconfigure Azure SDK Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Boot simplifies the Spring Cloud Azure development experience. Spring Cloud Azure starters are a set of convenient dependency descriptors to include in your application. They handle the object instantiation and configuration logic, so you don’t have to. Every starter depends on the <code>spring-cloud-azure-starter</code> to provide critical bits of configuration, like the Azure cloud environment and authentication information. You can configure these as properties in, for example, a yaml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        cloud-type: Azure <i class="conum" data-value="1"></i><b>(1)</b>
      credential:
        client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>cloud-type</code> is optional for it has default value set to <code>Azure</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These properties are optional and, if not specified, Spring Boot will try to automatically find them for you. For details on how Spring Boot finds these properties, refer to the documentation.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup"><a class="anchor" href="#dependency-setup"></a>8.1. Dependency Setup</h3>
<div class="paragraph">
<p>There are two ways to use Spring Cloud Azure starters. One is using Azure SDKs with this <code>spring-cloud-azure-starter</code> dependency. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or including the Spring Cloud Azure starter directly without adding Azure SDK dependencies. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#starter-dependencies">Starter Dependencies</a> for the list of starters Spring Cloud Azure supports.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-2"><a class="anchor" href="#configuration-2"></a>8.2. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuration properties for each Azure service are under prefix <code>spring.cloud.azure.&lt;azure-service&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage"><a class="anchor" href="#basic-usage"></a>8.3. Basic Usage</h3>
<div class="paragraph">
<p>Adding below properties to your <code>application.yaml</code> will autoconfigure the Cosmos clients for you, both <code>CosmosClient</code> and <code>CosmosAsyncClient</code> are available in the context and could be autowired.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      cosmos:
        database: ${AZURE_COSMOS_DATABASE_NAME}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        consistency-level: eventual
        connection-mode: direct</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @Autowired
    private CosmosClient cosmosClient;

    @Override
    public void run() {
        User item = User.randomUser();
        CosmosContainer container = cosmosClient.getDatabase(databaseName).getContainer(containerName);
        container.createItem(item);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples"><a class="anchor" href="#samples"></a>8.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-handling"><a class="anchor" href="#resource-handling"></a>9. Resource Handling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring project provides <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#resources">Spring Resources</a> abstraction to access a number of low-level resources. It provides interfaces like <code>Resource</code>, <code>ResourceLoader</code> and <code>ResourcePatternResolver</code>. Spring Cloud Azure implements these interfaces for Azure Storage services which allows you to interact with Azure Storage Blob and File Share using Spring programming model. It provides <code>spring-cloud-azure-starter-storage-blob</code> and <code>spring-cloud-azure-starter-storage-file-share</code> to autoconfigure Azure Storage Blob and Azure Storage File Share.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Azure Storage related libraries.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 12.5%;">
<col style="width: 62.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Starter</th>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows unstructured data to be stored and accessed at a massive scale in block blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offers fully managed cloud file shares that you can access from anywhere via the industry standard Server Message Block (SMB) protocol.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="dependency-setup-2"><a class="anchor" href="#dependency-setup-2"></a>9.1. Dependency Setup</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-blob&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-file-share&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only required when you&#8217;re using Azure Storage Blob.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only required when you&#8217;re using Azure Storage File Share.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-3"><a class="anchor" href="#configuration-3"></a>9.2. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Configurable properties of spring-cloud-azure-starter-storage-blob</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage Blob service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob account name.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Configurable properties of spring-cloud-azure-starter-storage-file-share</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage File Share service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share account name.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="basic-usage-2"><a class="anchor" href="#basic-usage-2"></a>9.3. Basic Usage</h3>
<div class="paragraph">
<p>Provide the properties below in your configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint: ${STORAGE_BLOB_ENDPOINT}
        fileshare:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint:  ${STORAGE_FILESHARE_ENDPOINT}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="get-a-resource"><a class="anchor" href="#get-a-resource"></a>9.3.1. Get a Resource</h4>
<div class="sect4">
<h5 id="get-a-resource-with-value"><a class="anchor" href="#get-a-resource-with-value"></a>Get a Resource with @Value</h5>
<div class="paragraph">
<p>You can use the annotation of <code>@Value("azure-blob://[your-container-name]/[your-blob-name]")</code> to autowire a blob resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the annotation of @Value("azure-file://[your-fileshare-name]/[your-file-name]") to autowire a file resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-a-resource-with-resourceloader"><a class="anchor" href="#get-a-resource-with-resourceloader"></a>Get a Resource with ResourceLoader</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private ResourceLoader resourceLoader;
...
// get a BlobResource
Resource storageBlobResource = resourceLoader.getResource("azure-blob://[your-container-name]/[your-blob-name]");
// get a FileResource
Resource storageFileResource = resourceLoader.getResource("azure-file://[your-fileshare-name]/[your-file-name]");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-resources-by-searching-pattern"><a class="anchor" href="#get-resources-by-searching-pattern"></a>Get Resources by Searching Pattern</h5>
<div class="paragraph">
<p>You can use implementation class of <code>ResourcePatternResolver</code> to search resources. Use <code>AzureStorageBlobProtocolResolver</code> to search <code>blob</code> resources, and <code>AzureStorageFileProtocolResolver</code> to search <code>file</code> resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pattern search, the <strong>searchPattern</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>. Such as <code>azure-blob://**/**</code>, it means list all blobs in all containers; <code>azure-blob://demo-container/**</code>, it means list all blobs in the demo-container container, including any sub-folders.</p>
</li>
<li>
<p>Location search, the <strong>searchLocation</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>, the remaining file path should exist, otherwise an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired
private AzureStorageBlobProtocolResolver azureStorageBlobProtocolResolver;

@Autowired
private AzureStorageFileProtocolResolver azureStorageFileProtocolResolver;

// get all text blobs
Resource[] blobTextResources = azureStorageBlobProtocolResolver.getResources("azure-blob://[container-pattern]/*.txt");
// get all text files
Resource[] fileTextResources = azureStorageFileProtocolResolver.getResources("azure-file://[fileshare-pattern]/*.txt");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling-with-resource"><a class="anchor" href="#handling-with-resource"></a>9.3.2. Handling with Resource</h4>
<div class="sect4">
<h5 id="download-data-from-specific-resource"><a class="anchor" href="#download-data-from-specific-resource"></a>Download Data from Specific Resource</h5>
<div class="paragraph">
<p>You can download a resource from Azure Stroage Blob or File Share with the <code>getInputStream()</code> method of <code>Resource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

....

// download data as stream from blob resource
InputStream inputblobStream = storageBlobResource.getInputStream();
// download data as stream from file resource
InputStream inputfileStream = storageFileResource.getInputStream();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="upload-data-to-specific-resource"><a class="anchor" href="#upload-data-to-specific-resource"></a>Upload Data to Specific Resource</h5>
<div class="paragraph">
<p>You can upload to a resource to Azure Storage Blob or File Share by casting the Spring <code>Resource</code> to <code>WritableResource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

String data = "sampledata";

// upload string data to blob
try (OutputStream blobos = ((WritableResource) this.storageBlobResource).getOutputStream()) {
  blobos.write(data.getBytes());
}
// upload string data to file
try (OutputStream fileos = ((WritableResource) this.storageFileResource).getOutputStream()) {
  fileos.write(data.getBytes());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multipart-upload"><a class="anchor" href="#multipart-upload"></a>9.3.3. Multipart Upload</h4>
<div class="paragraph">
<p>Files larger than 4 MiB will be uploaded to Azure Storage in parallel.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-2"><a class="anchor" href="#samples-2"></a>9.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/storage/spring-cloud-azure-starter-storage-blob/storage-blob-sample">storage-blob-sample</a> and <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/storage/spring-cloud-azure-starter-storage-file-share/storage-file-sample">storage-file-sample</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secret-management"><a class="anchor" href="#secret-management"></a>10. Secret Management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure construct <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-property-source-abstraction">PropertySource</a> which holds secrets stored in Azure Key Vault Secrets.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-3"><a class="anchor" href="#dependency-setup-3"></a>10.1. Dependency Setup</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-3"><a class="anchor" href="#basic-usage-3"></a>10.2. Basic Usage</h3>
<div class="paragraph">
<p>If you want to authenticate by <code>client-id</code> and <code>client-secret</code>, the following properties are required:</p>
</div>
<div class="sect3">
<h4 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a>10.2.1. Configuration Properties</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml hljs" data-lang="yml">spring:
  cloud:
    azure:
      keyvault:
        secret:
          property-sources:
            - name: key-vault-property-souece-1
              endpoint: ${ENDPOINT_1}
            - name: key-vault-property-souece-2
              endpoint: ${ENDPOINT_2}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-code"><a class="anchor" href="#java-code"></a>10.2.2. Java Code</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SpringBootApplication
public class SampleApplication implements CommandLineRunner {

    @Value("${sampleProperty1}")
    private String sampleProperty1;
    @Value("${sampleProperty2}")
    private String sampleProperty2;
    @Value("${samplePropertyInMultipleKeyVault}")
    private String samplePropertyInMultipleKeyVault;

    public static void main(String[] args) {
        SpringApplication.run(SampleApplication.class, args);
    }

    public void run(String[] args) {
        System.out.println("sampleProperty1: " + sampleProperty1);
        System.out.println("sampleProperty2: " + sampleProperty2);
        System.out.println("samplePropertyInMultipleKeyVault: " + samplePropertyInMultipleKeyVault);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a>10.3. Advanced Usage</h3>
<div class="sect3">
<h4 id="special-characters-in-property-name"><a class="anchor" href="#special-characters-in-property-name"></a>10.3.1. Special Characters in Property Name</h4>
<div class="paragraph">
<p>Key Vault secret name only support characters in <code>[0-9a-zA-Z-]</code>. Refs: <a href="https://docs.microsoft.com/azure/key-vault/general/about-keys-secrets-certificates#vault-name-and-object-name">Vault-name and Object-name</a>. If your property name contains other characters, you can use these workarounds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>-</code> instead of <code>.</code> in secret name. <code>.</code> isn&#8217;t supported in secret name. If your application have property name which contains <code>.</code>, like <code>spring.datasource.url</code>, just replace <code>.</code> to <code>-</code> when save secret in Azure Key Vault. For example: Save <code>spring-datasource-url</code> in Azure Key Vault. In your application, you can still use <code>spring.datasource.url</code> to retrieve property value.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This method can not satisfy requirement like <code>spring.datasource-url</code>. When you save <code>spring-datasource-url</code> in Key Vault, only <code>spring.datasource.url</code> and <code>spring-datasource-url</code> is supported to retrieve property value, <code>spring.datasource-url</code> isn&#8217;t supported. To handle this case, please refer to the following option: Use property placeholders.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Use property placeholders. For example: setting this property in your application.properties: <code>property.with.special.character_=${propertyWithoutSpecialCharacter}</code>. The application will get  <code>propertyWithoutSpecialCharacter</code> key name and assign its value to <code>property.with.special.character_</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="case-sensitive"><a class="anchor" href="#case-sensitive"></a>10.3.2. Case Sensitive</h4>
<div class="paragraph">
<p>By default, the secret names are case-insensitive. To enable case-sensitive mode, just set the following property: <code>spring.cloud.azure.keyvault.secret.property-sources[].case-sensitive=true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-retrieve-all-secrets-in-key-vault"><a class="anchor" href="#not-retrieve-all-secrets-in-key-vault"></a>10.3.3. Not Retrieve All Secrets In Key Vault</h4>
<div class="paragraph">
<p>If you stored 1000 secrets in the Key Vault, and you just want to use 3 of them. You can list the 3 secret names by <code>spring.cloud.azure.keyvault.secret.property-sources[].secret-keys</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setting-refresh-interval"><a class="anchor" href="#setting-refresh-interval"></a>10.3.4. Setting Refresh Interval</h4>
<div class="paragraph">
<p>By default, the secrets in <code>KeyVaultPropertySource</code> will refresh every 30 minutes. You can configure the time by <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval</code>. For example: <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval=60m</code> means refresh every 60 minutes. Set to <code>0</code> to disable auto refresh.</p>
</div>
</div>
<div class="sect3">
<h4 id="propertysource-priority"><a class="anchor" href="#propertysource-priority"></a>10.3.5. PropertySource Priority</h4>
<div class="paragraph">
<p>If key exists in multiple PropertySources, which will take effect is decided by the priority.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is no <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>KeyVaultPropertySource</code> will take the highest priority.</p>
</li>
<li>
<p>If there is <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>SystemEnvironmentPropertySource</code> have higher priority than KeyVaultPropertySource. Which means you can use environment variable to override the Key Vault secret value in your application.</p>
</li>
<li>
<p>If there are multiple KeyVaultPropertySource in PropertySource list, then the definition order is the priority order. Take above sample as example, <code>key-vault-property-souece-1</code> has higher priority than <code>key-vault-property-souece-2</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="all-configurable-properties"><a class="anchor" href="#all-configurable-properties"></a>10.3.6. All Configurable Properties</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Configurable properties of Key Vault Secret PropertySource</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-source-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Key Vault property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of this property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].case-sensitive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the secret keys are case-sensitive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].secret-keys</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret keys supported for this property source. All keys be retrieved if this property is missing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].refresh-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time interval to refresh all Key Vault secrets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].service-version</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secret service version used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].client</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].proxy</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proxy related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].retry</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retry related properties.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the <a href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object">security principal</a> has been granted the sufficient permission to access the Azure Key Vault Secrets.</p>
</li>
<li>
<p>If common properties like <code>client</code>, <code>credential</code>, <code>profile</code>, <code>proxy</code>, <code>retry</code> aren&#8217;t configured in <code>spring.cloud.azure.keyvault.secret.property-sources[].xxx</code>, <code>spring.cloud.azure.xxx</code> will be used. Please refer to <a href="index.html#configuration">Configuration</a> to get more information about these common properties.</p>
</li>
<li>
<p>Please refer to <a href="appendix.html#_configuration_properties">Configuration Properties</a> to get more information about nested properties.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-3"><a class="anchor" href="#samples-3"></a>10.4. Samples</h3>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/keyvault/spring-cloud-azure-starter-keyvault-secrets/property-source">property-source</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-support"><a class="anchor" href="#spring-data-support"></a>11. Spring Data Support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-data-cosmosdb-support"><a class="anchor" href="#spring-data-cosmosdb-support"></a>11.1. Spring Data CosmosDB Support</h3>
<div class="paragraph">
<p><a href="https://azure.microsoft.com/services/cosmos-db/">Azure Cosmos DB</a> is a globally-distributed database service that allows developers to work with data using a variety of standard APIs, such as SQL, MongoDB, Graph, and Azure Table storage.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependency-setup-4"><a class="anchor" href="#dependency-setup-4"></a>11.2. Dependency Setup</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
   &lt;artifactId&gt;spring-cloud-azure-starter-data-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-4"><a class="anchor" href="#configuration-4"></a>11.3. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Configurable properties of spring-cloud-azure-starter-data-cosmos</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether Azure Cosmos Service is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.database</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cosmos DB database id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uri to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.username</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.populate-query-metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Populate Diagnostics Strings and Query metrics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.consistency-level</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/cosmos-db/consistency-levels">Consistency levels</a> in Azure Cosmos DB.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="key-concepts"><a class="anchor" href="#key-concepts"></a>11.4. Key Concepts</h3>
<div class="ulist">
<ul>
<li>
<p>Spring Data CrudRepository and ReactiveCrudRepository basic CRUD functionality</p>
<div class="ulist">
<ul>
<li>
<p>save</p>
</li>
<li>
<p>findAll</p>
</li>
<li>
<p>findOne by Id</p>
</li>
<li>
<p>deleteAll</p>
</li>
<li>
<p>delete by Id</p>
</li>
<li>
<p>delete entity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Data <a href="https://github.com/spring-projects/spring-data-commons/blob/db62390de90c93a78743c97cc2cc9ccd964994a5/src/main/java/org/springframework/data/annotation/Id.java">@Id</a> annotation.
There&#8217;re 2 ways to map a field in domain class to <code>id</code> of Azure Cosmos DB document.</p>
<div class="ulist">
<ul>
<li>
<p>annotate a field in domain class with @Id, this field will be mapped to document <code>id</code> in Cosmos DB.</p>
</li>
<li>
<p>set name of this field to <code>id</code>, this field will be mapped to document <code>id</code> in Cosmos DB.
[Note] if both way applied,</p>
</li>
</ul>
</div>
</li>
<li>
<p>Custom collection Name.
By default, collection name will be class name of user domain class. To customize it, add annotation <code>@Document(collection="myCustomCollectionName")</code> to your domain class, that&#8217;s all.</p>
</li>
<li>
<p>Supports <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview">Azure Cosmos DB partition</a>. To specify a field of your domain class to be partition key field, just annotate it with <code>@PartitionKey</code>. When you do CRUD operation, please specify your partition value. For more sample on partition CRUD, please refer to <a href="https://github.com/Azure/azure-sdk-for-java/blob/main/sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/AddressRepositoryIT.java">test here</a></p>
</li>
<li>
<p>Supports <a href="https://docs.spring.io/spring-data/commons/docs/current/reference/html/#repositories.query-methods.details">Spring Data custom query</a> find operation.</p>
</li>
<li>
<p>Supports <a href="https://spring.io/projects/spring-data-rest">spring-boot-starter-data-rest</a>.</p>
</li>
<li>
<p>Supports List and nested type in domain class.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-4"><a class="anchor" href="#basic-usage-4"></a>11.5. Basic Usage</h3>
<div class="sect3">
<h4 id="use-private-key-to-access-cosmosdb"><a class="anchor" href="#use-private-key-to-access-cosmosdb"></a>11.5.1. Use Private Key to Access CosmosDB</h4>
<div class="paragraph">
<p>The simplest way to connect CosmosDB with <code>spring-cloud-azure-starter-data-cosmos</code> is primary key, add below properties, and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      cosmos:
        key: ${AZURE_COSMOS_KEY}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        database: ${AZURE_COSMOS_DATABASE}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="define-an-entity"><a class="anchor" href="#define-an-entity"></a>11.5.2. Define an Entity</h4>
<div class="paragraph">
<p>Define a simple entity as Document in Cosmos DB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Container(containerName = "mycollection")
public class User {
    @Id
    private String id;
    private String firstName;
    @PartitionKey
    private String lastName;
    private String address;

    public User() {
    }

    public User(String id, String firstName, String lastName, String address) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.address = address;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    @Override
    public String toString() {
        return String.format("%s %s, %s", firstName, lastName, address);
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p><code>id</code> field will be used as document <code>id</code> in Azure Cosmos DB. Or you can annotate any field with <code>@Id</code> to map it to document <code>id</code>.</p>
</div>
<div class="paragraph">
<p>Annotation <code>@Container(containerName = "mycollection")</code> is used to specify the collection name of your document in Azure Cosmos DB.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-repositories"><a class="anchor" href="#create-repositories"></a>11.5.3. Create Repositories</h4>
<div class="paragraph">
<p>Extends ReactiveCosmosRepository interface, which provides Spring Data repository support.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Repository
public interface UserRepository extends ReactiveCosmosRepository&lt;User, String&gt; {

    Flux&lt;User&gt; findByFirstName(String firstName);
}</pre>
</div>
</div>
<div class="paragraph">
<p>So far ReactiveCosmosRepository provides basic save, delete and find operations. More operations will be supported later.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-an-application-class"><a class="anchor" href="#create-an-application-class"></a>11.5.4. Create an Application Class</h4>
<div class="paragraph">
<p>Here create an application class with all the components</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@SpringBootApplication
public class CosmosSampleApplication implements CommandLineRunner {

   private static final Logger LOGGER = LoggerFactory.getLogger(CosmosSampleApplication.class);

    @Autowired
    private UserRepository repository;

    @Autowired
    private CosmosProperties properties;

    public static void main(String[] args) {
        SpringApplication.run(CosmosSampleApplication.class, args);
    }

    public void run(String... var1) {
        final User testUser = new User("testId", "testFirstName",
                "testLastName", "test address line one");

        // Save the User class to Azure Cosmos DB database.
        final Mono&lt;User&gt; saveUserMono = repository.save(testUser);

        final Flux&lt;User&gt; firstNameUserFlux = repository.findByFirstName("testFirstName");

        //  Nothing happens until we subscribe to these Monos.
        //  findById will not return the user as user is not present.
        final Mono&lt;User&gt; findByIdMono = repository.findById(testUser.getId());
        final User findByIdUser = findByIdMono.block();
        Assert.isNull(findByIdUser, "User must be null");

        final User savedUser = saveUserMono.block();
        Assert.state(savedUser != null, "Saved user must not be null");
        Assert.state(savedUser.getFirstName().equals(testUser.getFirstName()),
                "Saved user first name doesn't match");

        firstNameUserFlux.collectList().block();

        final Optional&lt;User&gt; optionalUserResult = repository.findById(testUser.getId()).blockOptional();
        Assert.isTrue(optionalUserResult.isPresent(), "Cannot find user.");

        final User result = optionalUserResult.get();
        Assert.state(result.getFirstName().equals(testUser.getFirstName()),
                "query result firstName doesn't match!");
        Assert.state(result.getLastName().equals(testUser.getLastName()),
                "query result lastName doesn't match!");
        LOGGER.info("findOne in User collection get result: {}", result.toString());

    }

    @PostConstruct
    public void setup() {
        // For this example, remove all of the existing records.
        this.repository.deleteAll().block();
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Autowired UserRepository interface, then can do save, delete and find operations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-4"><a class="anchor" href="#samples-4"></a>11.6. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/cosmos">azure-spring-boot-samples</a> for more details.</p>
</div>
<div class="paragraph">
<p>Apart from using the <code>spring-cloud-azure-starter-data-cosmos</code> library, you can directly use <code>azure-spring-data-cosmos</code> library for more complex scenarios. Please refer to <a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_{project-version}/sdk/cosmos/azure-spring-data-cosmos">Spring Data for Azure Cosmos DB</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-security-support"><a class="anchor" href="#spring-security-support"></a>12. Spring Security Support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory"><a class="anchor" href="#spring-security-with-azure-active-directory"></a>12.1. Spring Security With Azure Active Directory</h3>
<div class="paragraph">
<p>When you are building a web application, identity and access management will always be foundational pieces.</p>
</div>
<div class="paragraph">
<p>Azure offers a great platform to democratize your application development journey, as it not only offers a cloud-base identity service, but also deep integration with the rest of the Azure ecosystem.</p>
</div>
<div class="paragraph">
<p>Spring Security has made it easy to secure your Spring based applications with powerful abstractions and extensible interfaces. However, as powerful as the Spring framework can be, it is not tailored to a specific identity provider.</p>
</div>
<div class="paragraph">
<p>The <code>spring-cloud-azure-starter-active-directory</code> (<code>aad-starter</code> for short) provides the most optimal way to connect your <code>web application</code> to an Azure Active Directory (AAD for short) tenant and protect <code>resource server</code> with AAD. It uses the Oauth 2.0 protocol to protect <code>web applications</code> and <code>resource servers</code>.</p>
</div>
<div class="sect3">
<h4 id="accessing-a-web-application"><a class="anchor" href="#accessing-a-web-application"></a>12.1.1. Accessing a Web Application</h4>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with a Microsoft account.</p>
</div>
<div class="sect4">
<h5 id="system-diagram"><a class="anchor" href="#system-diagram"></a>System Diagram</h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617664-f1704adb-db64-49e0-b1b6-078c62b6945b.png" alt="Standalone Web Application"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure"><a class="anchor" href="#create-required-resources-in-azure"></a>Create Required Resources in Azure</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies"><a class="anchor" href="#add-required-dependencies"></a>Add Required Dependencies</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties"><a class="anchor" href="#add-required-properties"></a>Add Required Properties</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages"><a class="anchor" href="#advanced-usages"></a>Advanced Usages</h5>
<div class="sect5">
<h6 id="add-extra-security-configurations"><a class="anchor" href="#add-extra-security-configurations"></a>Add Extra Security Configurations</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @EnableWebSecurity
    @EnableGlobalMethodSecurity(prePostEnabled = true)
    public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {

        /**
         * Add configuration logic as needed.
         */
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            http.authorizeRequests()
                    .anyRequest().authenticated();
            // Do some custom configuration
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-app-roles"><a class="anchor" href="#authorize-access-by-app-roles"></a>Authorize Access by App Roles</h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: Admin</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: Admin</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to use app role based access control, you can&#8217;t put group names in <code>role</code> claim . Refs: <a href="https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims#configuring-groups-optional-claims">Configuring groups optional claims</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("Admin")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_Admin')")
    public String admin() {
        return "Admin message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-group-name-or-group-id"><a class="anchor" href="#authorize-access-by-group-name-or-group-id"></a>Authorize Access by Group Name Or Group ID</h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add related configuration properties.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        user-group:
          allowed-group-names: group1_name_1, group2_name_2
          # 1. If allowed-group-ids == all, then all group id will take effect.
          # 2. If "all" is used, we should not configure other group ids.
          # 3. "all" is only supported for allowed-group-ids, not supported for allowed-group-names.
          allowed-group-ids: group_id_1, group_id_2</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Controller
public class RoleController {
    @GetMapping("group1")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group1')")
    public String group1() {
        return "group1 message";
    }

    @GetMapping("group2")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group2')")
    public String group2() {
        return "group2 message";
    }

    @GetMapping("group1Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group1-id&gt;')")
    public String group1Id() {
        return "group1Id message";
    }

    @GetMapping("group2Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group2-id&gt;')")
    public String group2Id() {
        return "group2Id message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-national-azure-instead-of-global-azure"><a class="anchor" href="#use-national-azure-instead-of-global-azure"></a>Use National Azure Instead of Global Azure</h6>
<div class="paragraph">
<p>Now except global Azure cloud, Azure Active Directory is deployed in the following national clouds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Government</p>
</li>
<li>
<p>Azure China 21Vianet</p>
</li>
<li>
<p>Azure Germany</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a sample of you want to use Azure China 21Vianet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        base-uri: https://login.partner.microsoftonline.cn
        graph-base-uri: https://microsoftgraph.chinacloudapi.cn</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can refer to these MS doc to get more information from <a href="https://docs.microsoft.com/en-us/graph/deployments">MS docs about National cloud deployments</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="configure-redirect-uri-template"><a class="anchor" href="#configure-redirect-uri-template"></a>Configure Redirect URI Template</h6>
<div class="paragraph">
<p>Developers can customize the redirect-uri.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149295662-072ca3d5-f9e1-4f25-bb0e-be7bb751e9af.png" alt="redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add <code>redirect-uri-template</code> properties in application.yml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory
        redirect-uri-template: ${REDIRECT-URI-TEMPLATE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Update redirect-uri in Azure portal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149296913-a4259df9-e0c3-4e38-8d4e-77ee845de4ad.png" alt="web-application-config-redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Update WebSecurityConfigurerAdapter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After we set redirect-uri-template, we need to update <code>WebSecurityConfigurerAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.oauth2Login()
                .loginProcessingUrl("${REDIRECT-URI-TEMPLATE}")
                .and()
            .authorizeRequests()
                .anyRequest().authenticated();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-5"><a class="anchor" href="#samples-5"></a>Samples</h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-accessing-resource-servers"><a class="anchor" href="#web-application-accessing-resource-servers"></a>12.1.2. Web Application Accessing Resource Servers</h4>
<div class="sect4">
<h5 id="system-diagram-2"><a class="anchor" href="#system-diagram-2"></a>System Diagram</h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617853-0526205f-fdef-47f9-ac01-77963f8c34be.png" alt="web-application-visiting-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-2"><a class="anchor" href="#create-required-resources-in-azure-2"></a>Create Required Resources in Azure</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-2"><a class="anchor" href="#add-required-dependencies-2"></a>Add Required Dependencies</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-2"><a class="anchor" href="#add-required-properties-2"></a>Add Required Properties</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>graph</code> is the name of <code>OAuth2AuthorizedClient</code>, <code>scopes</code> means the scopes need to consent when login.</p>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application"></a>Use OAuth2AuthorizedClient in Your Application</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Demo {
    @GetMapping("/graph")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graphClient) {
        // toJsonString() is just a demo.
        // oAuth2AuthorizedClient contains access_token. We can use this access_token to access resource server.
        return toJsonString(graphClient);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-2"><a class="anchor" href="#advanced-usages-2"></a>Advanced Usages</h5>
<div class="sect5">
<h6 id="client-credential-flow"><a class="anchor" href="#client-credential-flow"></a>Client Credential Flow</h6>
<div class="paragraph">
<p>The default flow is <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">authorization code flow</a>, if you want to use <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">client credentials flow</a>, you can configure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            authorization-grant-type: client_credentials # Change type to client_credentials
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="access-multiple-resource-servers"><a class="anchor" href="#access-multiple-resource-servers"></a>Access Multiple Resource Servers</h6>
<div class="paragraph">
<p>In one web application, you can access multiple resource server by configuring like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use OAuth2AuthorizedClient in application like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Demo {
    @GetMapping("/resource-server-1")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-1") OAuth2AuthorizedClient client) {
        return callResourceServer1(client);
    }

    @GetMapping("/resource-server-2")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-2") OAuth2AuthorizedClient client) {
        return callResourceServer2(client);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="incremental-consent"><a class="anchor" href="#incremental-consent"></a>Incremental Consent</h6>
<div class="paragraph">
<p>In previous sample, all scopes will be consented when customer first login, no matter it&#8217;s belong to resource-server-1 or resource-server-2. If you don&#8217;t want to let customer consent all scopes, you can do like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            on-demand: true  # means incremental consent
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-6"><a class="anchor" href="#samples-6"></a>Samples</h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="accessing-a-resource-server"><a class="anchor" href="#accessing-a-resource-server"></a>12.1.3. Accessing a Resource Server</h4>
<div class="paragraph">
<p>This scenario doesn&#8217;t support login, just protect the server by validating the access token. If the access token is valid, the server serves the request.</p>
</div>
<div class="sect4">
<h5 id="system-diagram-3"><a class="anchor" href="#system-diagram-3"></a>System Diagram</h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617910-1ee3eb6a-ddc7-4b85-af4e-71344c91b248.png" alt="Standalone resource server usage"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-3"><a class="anchor" href="#create-required-resources-in-azure-3"></a>Create Required Resources in Azure</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_CLIENT_ID</code>.</p>
</li>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope-1</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-3"><a class="anchor" href="#add-required-dependencies-3"></a>Add Required Dependencies</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-3"><a class="anchor" href="#add-required-properties-3"></a>Add Required Properties</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        credential:
          client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start your application and access your application&#8217;s web api.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You will get 401 without an access token.</p>
</li>
<li>
<p>Access your application with an access token, the following claims in access token will be validated:</p>
<div class="ulist">
<ul>
<li>
<p><code>iss</code>: The access token must be issued by Azure AD.</p>
</li>
<li>
<p><code>nbf</code>: Current time can not before <code>nbf</code>.</p>
</li>
<li>
<p><code>exp</code>: Current time can not after <code>exp</code>.</p>
</li>
<li>
<p><code>aud</code>: If <code>spring.cloud.azure.active-directory.credential.client-id</code> or <code>spring.cloud.azure.active-directory.credential.app-id-uri</code> configured, the audience must equal to the configured <code>client-id</code> or <code>app-id-uri</code>. If the 2 properties are not configured, this claim will not be validated.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens">MS docs about Microsoft identity platform access tokens</a> to get more information about access token.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-3"><a class="anchor" href="#advanced-usages-3"></a>Advanced Usages</h5>
<div class="sect5">
<h6 id="add-extra-security-configurations-2"><a class="anchor" href="#add-extra-security-configurations-2"></a>Add Extra Security Configurations</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2ResourceServerSecurityConfig extends AadResourceServerWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-scopes"><a class="anchor" href="#validate-permission-by-scopes"></a>Validate Permission by Scopes</h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: : Create Required Resources in Azure</p>
<div class="ulist">
<ul>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("scope1")
    @ResponseBody
    @PreAuthorize("hasAuthority('SCOPE_Scope1')")
    public String scope1() {
        return "Congratulations, you can access `scope1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/scope1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scp</code>: The value must contains <code>Scope1</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-app-roles"><a class="anchor" href="#validate-permission-by-app-roles"></a>Validate Permission by App Roles</h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: AppRole1</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: AppRole1</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("app-role1")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_AppRole1')")
    public String appRole1() {
        return "Congratulations, you can access `app-role1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/app-role1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>roles</code>: The value must contains <code>AppRole1</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-7"><a class="anchor" href="#samples-7"></a>Samples</h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server">aad-resource-server</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resource-server-visiting-other-resource-servers"><a class="anchor" href="#resource-server-visiting-other-resource-servers"></a>12.1.4. Resource Server Visiting Other Resource Servers</h4>
<div class="sect4">
<h5 id="system-diagram-4"><a class="anchor" href="#system-diagram-4"></a>System Diagram</h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142618294-aa546ced-d241-4fbd-97ac-fb06881503b1.png" alt="resource-server-visiting-other-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-4"><a class="anchor" href="#create-required-resources-in-azure-4"></a>Create Required Resources in Azure</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-4"><a class="anchor" href="#add-required-dependencies-4"></a>Add Required Dependencies</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-4"><a class="anchor" href="#add-required-properties-4"></a>Add Required Properties</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes:
              - https://graph.microsoft.com/User.Read</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application-2"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application-2"></a>Use OAuth2AuthorizedClient in Your Application</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    @GetMapping("call-graph")
    public String callGraph(@RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graph) {
        return callMicrosoftGraphMeEndpoint(graph);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-8"><a class="anchor" href="#samples-8"></a>Samples</h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server-obo">aad-resource-server-obo</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-and-resource-server-in-one-application"><a class="anchor" href="#web-application-and-resource-server-in-one-application"></a>12.1.5. Web Application and Resource Server in One Application</h4>
<div class="sect4">
<h5 id="create-required-resources-in-azure-5"><a class="anchor" href="#create-required-resources-in-azure-5"></a>Create Required Resources in Azure</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-5"><a class="anchor" href="#add-required-dependencies-5"></a>Add Required Dependencies</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-5"><a class="anchor" href="#add-required-properties-5"></a>Add Required Properties</h5>
<div class="paragraph">
<p>Set property <code>spring.cloud.azure.active-directory.application-type</code> to <code>web_application_and_resource_server</code>, and specify the authorization type for each authorization client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        app-id-uri: ${WEB_API_ID_URI}
        application-type: web_application_and_resource_server  # This is required.
        authorization-clients:
          graph:
            authorizationGrantType: authorization_code # This is required.
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="define-securityconfigurationadapter"><a class="anchor" href="#define-securityconfigurationadapter"></a>Define SecurityConfigurationAdapter</h5>
<div class="paragraph">
<p>Configure multiple HttpSecurity instances, <code>AadWebApplicationAndResourceServerConfig</code> contain two security configurations for resource server and web application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadWebApplicationAndResourceServerConfig {

    @Order(1)
    @Configuration
    public static class ApiWebSecurityConfigurationAdapter extends AadResourceServerWebSecurityConfigurerAdapter {
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // All the paths that match `/api/**`(configurable) work as `Resource Server`, other paths work as `Web application`.
            http.antMatcher("/api/**")
                .authorizeRequests().anyRequest().authenticated();
        }
    }

    @Configuration
    public static class HtmlWebSecurityConfigurerAdapter extends AadWebSecurityConfigurerAdapter {

        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // @formatter:off
            http.authorizeRequests()
                    .antMatchers("/login").permitAll()
                    .anyRequest().authenticated();
            // @formatter:on
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-5"><a class="anchor" href="#configuration-5"></a>12.1.6. Configuration</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Configurable properties of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of an id_token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.application-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the AAD application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add additional parameters to the Authorization URL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The OAuth2 authorization clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lifespan of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-refresh-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The refresh time of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.post-logout-redirect-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The redirect uri after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.cloud-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to. Supported types are: AZURE, AZURE_CHINA, AZURE_GERMANY, AZURE_US_GOVERNMENT, OTHER.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.environment</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties to Azure Active Directory endpoints.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.tenant-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Tenant ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.redirect-uri-template</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirection Endpoint: Used by the authorization server to return responses containing authorization credentials to the client via the resource owner user-agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.claim-to-authority-prefix-map</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim will be used to build GrantedAuthority, and prefix of the GrantedAuthority&#8217;s string value. Default value is: "scp" &#8594; "SCOPE_", "roles" &#8594; "APPROLE_".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.principal-claim-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim in access token be returned in AuthenticatedPrincipal#getName. Default value is "sub".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.session-stateless</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true activates the stateless auth filter AadAppRoleStatelessAuthenticationFilter. The default is false which activates AadAuthenticationFilter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-ids</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group ids can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-names</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group names can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.use-transitive-members</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If "true", use "v1.0/me/transitiveMemberOf" to get members. Otherwise, use "v1.0/me/memberOf".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-name-attribute</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decide which claim to be principal&#8217;s name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some examples about how to use these properties:</p>
</div>
<div class="sect4">
<h5 id="application-type"><a class="anchor" href="#application-type"></a>Application Type</h5>
<div class="paragraph">
<p>THe application type can be inferred from the dependencies: spring-security-oauth2-client or spring-security-oauth2-resource-server. If the inferred value is not the value you want, you can specify the application type. Here is the table about valid values and inferred value:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Application type of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-client</th>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-resource-server</th>
<th class="tableblock halign-left valign-top">Valid values of application type</th>
<th class="tableblock halign-left valign-top">Inferred value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code>, <code>resource_server</code>, <code>resource_server_with_obo</code>, <code>web_application_and_resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server_with_obo</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory-b2c"><a class="anchor" href="#spring-security-with-azure-active-directory-b2c"></a>12.2. Spring Security With Azure Active Directory B2C</h3>
<div class="paragraph">
<p>Azure Active Directory (Azure AD) B2C is an identity management service that enables you to customize and control how customers sign up, sign in, and manage their profiles when using your applications. Azure AD B2C enables these actions while protecting the identities of your customers at the same time.</p>
</div>
<div class="sect3">
<h4 id="dependency-setup-5"><a class="anchor" href="#dependency-setup-5"></a>12.2.1. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-6"><a class="anchor" href="#configuration-6"></a>12.2.2. Configuration</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Configurable properties of spring-cloud-azure-starter-active-directory-b2c</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of a token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional parameters for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify client configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.base-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C endpoint base uri.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C credential information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.login-flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sign-up-or-sign-in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the primary sign-in flow key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.logout-success-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:8080/login" class="bare">localhost:8080/login</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect url after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C profile information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.reply-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply url after get authorization code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-flows</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User flows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-name-attribute-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User name attribute name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For full configurations, check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-5"><a class="anchor" href="#basic-usage-5"></a>12.2.3. Basic Usage</h4>
<div class="paragraph">
<p>A <code>web application</code> is any web based application that allows user to login Azure AD, whereas a <code>resource server</code> will either accept or deny access after validating access_token obtained from Azure AD. We will cover 4 scenarios in this guide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Accessing a web application.</p>
</li>
<li>
<p>Web application accessing resource servers.</p>
</li>
<li>
<p>Accessing a resource server.</p>
</li>
<li>
<p>Resource server accessing other resource servers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620440-f970b572-2646-4f50-9f77-db62d6e965f1.png" alt="B2C Web application &amp; Web Api Overall"></span></p>
</div>
<div class="sect4">
<h5 id="usage-1-accessing-a-web-application"><a class="anchor" href="#usage-1-accessing-a-web-application"></a>Usage 1: Accessing a Web Application</h5>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with your Azure AD B2C user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webapp</code>, add <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code> for the <strong>Reply URL</strong>, record the
<strong>Application ID</strong> as your <code>WEB_APP_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_APP_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>User flows</strong> on your left, and then Click <strong>New user flow</strong>.</p>
</li>
<li>
<p>Step 5: Choose <strong>Sign up or in</strong>, <strong>Profile editing</strong> and <strong>Password reset</strong> to create user flows
respectively. Specify your user flow <strong>Name</strong> and <strong>User attributes and claims</strong>, click <strong>Create</strong>.</p>
</li>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>Microsoft APIs</strong>, select <strong><em>Microsoft Graph</em></strong>,
select <strong>Delegated permissions</strong>, check <strong>offline_access</strong> and <strong>openid</strong> permissions, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>Graph</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620491-8c8a82ea-c920-43a8-aa0a-dd028f1b8553.png" alt="Add Graph permissions"></span></p>
</li>
<li>
<p>Step 8: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
        &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add properties in <em>application.yml</em> using the values you created earlier, for example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        b2c:
          authenticate-additional-parameters:
            domain_hint: xxxxxxxxx         # optional
            login_hint: xxxxxxxxx          # optional
            prompt: [login,none,consent]   # optional
          base-uri: ${BASE_URI}
          credential:
            client-id: ${WEBAPP_AZURE_CLIENT_ID}
            client-secret: ${WEBAPP_AZURE_CLIENT_SECRET}
          login-flow: ${LOGIN_USER_FLOW_KEY}               # default to sign-up-or-sign-in, will look up the user-flows map with provided key.
          logout-success-url: ${LOGOUT_SUCCESS_URL}
          user-flows:
            ${YOUR_USER_FLOW_KEY}: ${USER_FLOW_NAME}
          user-name-attribute-name: ${USER_NAME_ATTRIBUTE_NAME}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Controller
public class WebController {

    private void initializeModel(Model model, OAuth2AuthenticationToken token) {
        if (token != null) {
            final OAuth2User user = token.getPrincipal();
            model.addAllAttributes(user.getAttributes());
            model.addAttribute("grant_type", user.getAuthorities());
            model.addAttribute("name", user.getName());
        }
    }

    @GetMapping(value = { "/", "/home" })
    public String index(Model model, OAuth2AuthenticationToken token) {
        initializeModel(model, token);
        return "home";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

    private final AadB2cOidcLoginConfigurer configurer;

    public WebSecurityConfiguration(AadB2cOidcLoginConfigurer configurer) {
        this.configurer == configurer;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
            .apply(configurer);
        // @formatter:off
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <em>home.html</em> from <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/blob/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory-b2c/aad-b2c-web-application/src/main/resources/templates/home.html">aad-b2c-web-application sample</a>, and replace the <code>PROFILE_EDIT_USER_FLOW</code> and <code>PASSWORD_RESET_USER_FLOW</code> with your user flow name respectively that completed earlier.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> run on port <em>8080</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>After your application is built and started by Maven, open <code><a href="http://localhost:8080/" class="bare">localhost:8080/</a></code> in a web browser; you should be redirected to login page.</p>
</li>
<li>
<p>Click link with the login user flow, you should be redirected Azure AD B2C to start the authentication process.</p>
</li>
<li>
<p>After you have logged in successfully, you should see the sample <code>home page</code> from the browser.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="usage-2-web-application-accessing-resource-servers"><a class="anchor" href="#usage-2-web-application-accessing-resource-servers"></a>Usage 2: Web Application Accessing Resource Servers</h5>
<div class="paragraph">
<p>This scenario is based on <strong>Accessing a web application</strong> scenario to allow application to access other resources, that is [The OAuth 2.0 client credentials grant] flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webApiA</code>, record the <strong>Application ID</strong> as your <code>WEB_API_A_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_API_A_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>Expose an API</strong> on your left, and then Click the <strong>Set</strong> link,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 5: Select <strong>Manifest</strong> on your left, and then paste the below json segment into <code>appRoles</code> array,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, record the value of the app role as your <code>WEB_API_A_ROLE_VALUE</code>, then <strong>save</strong>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "allowedMemberTypes": [
    "Application"
  ],
  "description": "WebApiA.SampleScope",
  "displayName": "WebApiA.SampleScope",
  "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
  "isEnabled": true,
  "value": "WebApiA.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620567-59a91df7-7a97-4027-b525-1f422f25fb22.png" alt="Configure WebApiA appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>My APIs</strong>, select <strong><em>WebApiA</em></strong> application name, select <strong>Application Permissions</strong>, select <strong>WebApiA.SampleScope</strong> permission, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>WebApiA</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620601-660400fa-7cff-4989-9d7f-2b32a9aa1244.png" alt="Add WebApiA permission"></span></p>
</li>
<li>
<p>Step 8: Add the following dependency on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add the following configuration on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          authorization-clients:
            ${RESOURCE_SERVER_A_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_A_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your <code>Webapp</code> Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    /**
     * Access to protected data from Webapp to WebApiA through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi A.
     */
    @GetMapping("/webapp/webApiA")
    public String callWebApiA() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_A_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiA"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiA(), request '/webApiA/sample' returned: {}", body);
        return "Request '/webApiA/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a web application</strong> scenario, another bean <code>webClient</code> is added as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Please refer to <strong>Accessing a resource server</strong> section to write your <code>WebApiA</code> Java code.</p>
</li>
<li>
<p>Step 12: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> and <code>WebApiA</code> run on port <em>8080</em> and <em>8081</em> respectively.
 Start <code>Webapp</code> and <code>WebApiA</code> application, return to the home page after logging successfully, you can access <code><a href="http://localhost:8080/webapp/webApiA" class="bare">localhost:8080/webapp/webApiA</a></code> to get <strong>WebApiA</strong> resource response.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-3-accessing-a-resource-server"><a class="anchor" href="#usage-3-accessing-a-resource-server"></a>Usage 3: Accessing a Resource Server</h5>
<div class="paragraph">
<p>This scenario not support login. Just protect the server by validating the access token, and if valid, serves the request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Refer to <a href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a> to build your <code>WebApiA</code> permission.</p>
</li>
<li>
<p>Step 2: Add <code>WebApiA</code> permission and grant admin consent for your web application.</p>
</li>
<li>
<p>Step 3: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          app-id-uri: ${APP_ID_URI}         # If you are using v1.0 token, please configure app-id-uri for `aud` verification
          credential:
            client-id: ${AZURE_CLIENT_ID}           # If you are using v2.0 token, please configure client-id for `aud` verification</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    /**
     * webApiA resource api for web app
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    @GetMapping("/webApiA/sample")
    public String webApiASample() {
        LOGGER.info("Call webApiASample()");
        return "Request '/webApiA/sample'(WebApi A) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class ResourceServerConfiguration extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated())
            .oauth2ResourceServer()
            .jwt()
            .jwtAuthenticationConverter(new AadJwtBearerTokenAuthenticationConverter());
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> run on port <em>8081</em>.
 Get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/sample" class="bare">localhost:8081/webApiA/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-4-resource-server-accessing-other-resource-servers"><a class="anchor" href="#usage-4-resource-server-accessing-other-resource-servers"></a>Usage 4: Resource Server Accessing Other Resource Servers</h5>
<div class="paragraph">
<p>This scenario is an upgrade of <strong>Accessing a resource server</strong>, supports access to other application resources, based on OAuth2 client credentials flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Referring to the previous steps, we create a <code>WebApiB</code> application and expose an application permission <code>WebApiB.SampleScope</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "allowedMemberTypes": [
        "Application"
    ],
    "description": "WebApiB.SampleScope",
    "displayName": "WebApiB.SampleScope",
    "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "WebApiB.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620648-cfbf5220-9736-4050-a3ef-1370c522e672.png" alt="Configure WebApiB appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Grant admin consent for <strong><em>WebApiB</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620691-b1a7fcda-fc92-41af-9515-812139f26ee0.png" alt="Add WebApiB permission"></span></p>
</li>
<li>
<p>Step 3: On the basis of <strong>Accessing a resource server</strong>, add a dependency in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
 &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration on the basis of <strong>Accessing a resource server</strong> scenario configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          credential:
            client-secret: ${WEB_API_A_AZURE_CLIENT_SECRET}
          authorization-clients:
            ${RESOURCE_SERVER_B_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_B_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebApiA controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    /**
     * Access to protected data from WebApiA to WebApiB through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi B.
     */
    @GetMapping("/webApiA/webApiB/sample")
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    public String callWebApiB() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_B_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiB"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiB(), request '/webApiB/sample' returned: {}", body);
        return "Request 'webApiA/webApiB/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WebApiB controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    /**
     * webApiB resource api for other web application
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiB.SampleScope')")
    @GetMapping("/webApiB/sample")
    public String webApiBSample() {
        LOGGER.info("Call webApiBSample()");
        return "Request '/webApiB/sample'(WebApi B) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a resource server</strong> scenario, another bean <code>webClient</code> is added as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> and <code>WebApiB</code> run on port <em>8081</em> and <em>8082</em> respectively.
 Start <code>WebApiA</code> and <code>WebApiB</code> application, get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/webApiB/sample" class="bare">localhost:8081/webApiA/webApiB/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-9"><a class="anchor" href="#samples-9"></a>12.2.4. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/aad/spring-cloud-azure-starter-active-directory-b2c">spring-cloud-azure-starter-active-directory-b2c samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-integration-support"><a class="anchor" href="#spring-integration-support"></a>13. Spring Integration Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Integration Extension for Azure provides Spring Integration adapters for the various services provided by the <a href="https://github.com/Azure/azure-sdk-for-java/">Azure SDK for Java</a>. We provide Spring Integration support for these Azure services: Event Hubs, Service Bus, Storage Queue. Below is a list of supported adapters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-starter-integration-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-servicebus</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-storage-queue</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-event-hubs"><a class="anchor" href="#spring-integration-with-azure-event-hubs"></a>13.1. Spring Integration with Azure Event Hubs</h3>
<div class="sect3">
<h4 id="key-concepts-2"><a class="anchor" href="#key-concepts-2"></a>13.1.1. Key Concepts</h4>
<div class="paragraph">
<p>Azure Event Hubs is a big data streaming platform and event ingestion service. It can receive and process millions of events per second. Data sent to an event hub can be transformed and stored by using any real-time analytics provider or batching/storage adapters.</p>
</div>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters. Those adapters provide a higher-level of abstraction over Spring’s support for remoting, messaging, and scheduling. The <strong>Spring Integration for Event Hubs</strong> extension project provides inbound and outbound channel adapters and gateways for Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
RxJava support APIs are dropped from version 4.0.0.
Please refer to Javadoc for details.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="consumer-group"><a class="anchor" href="#consumer-group"></a>Consumer Group</h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support"><a class="anchor" href="#partitioning-support"></a>Partitioning Support</h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support"><a class="anchor" href="#batch-consumer-support"></a>Batch Consumer Support</h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> supports the batch-consuming mode. To enable it, users can specify the listener mode as <code>ListenerMode.BATCH</code> when constructing an <code>EventHubsInboundChannelAdapter</code> instance.
When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the downstream channel. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#si-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch consuming policy can be specified by properties of <code>max-size</code> and <code>max-wait-time</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional.
To specify the batch consuming strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-6"><a class="anchor" href="#dependency-setup-6"></a>13.1.2. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-7"><a class="anchor" href="#configuration-7"></a>13.1.3. Configuration</h4>
<div class="paragraph">
<p>This starter provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties"><a class="anchor" href="#connection-configuration-properties"></a>Connection Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Connection configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.shared-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the underlying EventProcessorClient and EventHubProducerAsyncClient use the same connection. By
default, a new connection is constructed and used created for each Event Hub client created.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties"><a class="anchor" href="#checkpoint-configuration-properties"></a>Checkpoint Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Checkpointing configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="event-hub-processor-configuration-properties"><a class="anchor" href="#event-hub-processor-configuration-properties"></a>Event Hub Processor Configuration Properties</h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> uses the <code>EventProcessorClient</code> to consume messages from an event hub, to configure the overall properties of an <code>EventProcessorClient</code>,
developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> about how to work with <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-6"><a class="anchor" href="#basic-usage-6"></a>13.1.4. Basic Usage</h4>
<div class="sect4">
<h5 id="send-messages-to-azure-event-hubs"><a class="anchor" href="#send-messages-to-azure-event-hubs"></a>Send messages to Azure Event Hubs</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT-CONTAINER}
            account-name: ${CHECKPOINT-STORAGE-ACCOUNT}
            account-key: ${CHECKPOINT-ACCESS-KEY}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>EventHubsTemplate</code> to send messages to Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    private static final String OUTPUT_CHANNEL = "output";
    private static final String EVENTHUB_NAME = "eh1";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(EventHubsTemplate eventHubsTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(EVENTHUB_NAME, eventHubsTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }
            @Override
            public void onFailure(Throwable ex) {
                LOGGER.error("There was an error sending the message.", ex);
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @Autowired
    EventHubOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface EventHubOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-eh"><a class="anchor" href="#receive-from-eh"></a>Receive Messages from Azure Event Hubs</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class Demo {
    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>EventHubsInboundChannelAdapter</code> with the bean of <code>EventHubsMessageListenerContainer</code> to receive messages from Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with EventHubsInboundChannelAdapter via the message channel created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-eventhubsmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-eventhubsmessageconverter-to-customize-objectmapper"></a>Configure EventHubsMessageConverter to Customize ObjectMapper</h5>
<div class="paragraph">
<p><code>EventHubsMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-batch"><a class="anchor" href="#si-eh-batch"></a>Batch Consumer Support</h5>
<div class="paragraph">
<p>To consume messages from Event Hubs in batches is similar with the above sample, besides users should set the batch-consuming related configuration options for <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
<div class="paragraph">
<p>When create <code>EventHubsInboundChannelAdapter</code>, the listener mode should be set as <code>BATCH</code>. When create bean of <code>EventHubsMessageListenerContainer</code>, set the checkpoint mode as either <code>MANUAL</code> or <code>BATCH</code>, and the batch options can be configured as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer, ListenerMode.BATCH);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.getBatch().setMaxSize(100);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-headers"><a class="anchor" href="#si-eh-headers"></a>Event Hubs Message Headers</h5>
<div class="paragraph">
<p>The following table illustrates how Event Hubs message properties are mapped to Spring message headers. For Azure Event Hubs, message is called as <code>event</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Record Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The instant, in UTC, of when the event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset of the event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition hashing key if it was set when originally publishing the event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#RAW_PARTITION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition id of the Event Hub.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sequence number assigned to the event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last enqueued event properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#LAST_ENQUEUED_EVENT_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastEnqueuedEventProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The properties of the last enqueued event in this partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#CHECKPOINTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpointer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The header for checkpoint the specific message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Users can parse the message headers for the related information of each event. To set a message header for the event, all customized headers will be put as an application property of an event, where the header is set as the property key. When events are received from Event Hubs, all application properties will be converted to the message header.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Message headers of partition key, enqueued time, offset and sequence number is not supported to be set manually.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the batch-consumer mode is enabled, the specific headers of batched messages are listed as below, which contains a list of values from each single Event Hubs event.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Batch Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Batch Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the instant, in UTC, of when each event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the offset of each event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the partition hashing key if it was set when originally publishing each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the sequence number assigned to each event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">System properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_SYSTEM_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the system properties of each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_APPLICATION_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the application properties of each event, where all customized message headers or event properties are placed.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When publish messages, all the above batch headers will be removed from the messages if exist.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-10"><a class="anchor" href="#samples-10"></a>13.1.5. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/eventhubs/spring-cloud-azure-starter-integration-eventhubs/eventhubs-integration">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-service-bus"><a class="anchor" href="#spring-integration-with-azure-service-bus"></a>13.2. Spring Integration with Azure Service Bus</h3>
<div class="sect3">
<h4 id="key-concepts-3"><a class="anchor" href="#key-concepts-3"></a>13.2.1. Key Concepts</h4>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters.</p>
</div>
<div class="paragraph">
<p>The Spring Integration for Azure Service Bus extension project provides inbound and outbound channel adapters for Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
CompletableFuture support APIs have been deprecated from version 2.10.0, and is replaced by Reactor Core from version 4.0.0.
Please refer to Javadoc for details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-7"><a class="anchor" href="#dependency-setup-7"></a>13.2.2. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-8"><a class="anchor" href="#configuration-8"></a>13.2.3. Configuration</h4>
<div class="paragraph">
<p>This starter provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-2"><a class="anchor" href="#connection-configuration-properties-2"></a>Connection Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. Connection configurable properties of spring-cloud-azure-starter-integration-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="service-bus-processor-configuration-properties"><a class="anchor" href="#service-bus-processor-configuration-properties"></a>Service Bus Processor Configuration Properties</h5>
<div class="paragraph">
<p>The <code>ServiceBusInboundChannelAdapter</code> uses the <code>ServiceBusProcessorClient</code> to consume messages, to configure the overall properties of an <code>ServiceBusProcessorClient</code>,
developers can use <code>ServiceBusContainerProperties</code> for the configuration. See <a href="#receive-from-sb">the below section</a> about how to work with <code>ServiceBusInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-7"><a class="anchor" href="#basic-usage-7"></a>13.2.4. Basic Usage</h4>
<div class="sect4">
<h5 id="send-messages-to-azure-service-bus"><a class="anchor" href="#send-messages-to-azure-service-bus"></a>Send Messages to Azure Service Bus</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>ServiceBusTemplate</code> to send messages to Service Bus,
set the entity type for the ServiceBusTemplate. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    private static final String OUTPUT_CHANNEL = "queue.output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler queueMessageSender(ServiceBusTemplate serviceBusTemplate) {
        serviceBusTemplate.setDefaultEntityType(ServiceBusEntityType.QUEUE);
        DefaultMessageHandler handler = new DefaultMessageHandler(QUEUE_NAME, serviceBusTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });

        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @Autowired
    QueueOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface QueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-sb"><a class="anchor" href="#receive-from-sb"></a>Receive Messages from Azure Service Bus</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>ServiceBusInboundChannelAdapter</code> with the bean of <code>ServiceBusMessageListenerContainer</code> to receive messages to Service Bus. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class Demo {
    private static final String QUEUE_NAME = "queue1";

    @Bean
    public ServiceBusMessageListenerContainer messageListenerContainer(ServiceBusProcessorFactory processorFactory) {
        ServiceBusContainerProperties containerProperties = new ServiceBusContainerProperties();
        containerProperties.setEntityName(QUEUE_NAME);
        containerProperties.setAutoComplete(false);
        return new ServiceBusMessageListenerContainer(processorFactory, containerProperties);
    }

    @Bean
    public ServiceBusInboundChannelAdapter queueMessageChannelAdapter(
        @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
        ServiceBusMessageListenerContainer listenerContainer) {
        ServiceBusInboundChannelAdapter adapter = new ServiceBusInboundChannelAdapter(listenerContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with ServiceBusInboundChannelAdapter via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-servicebusmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-servicebusmessageconverter-to-customize-objectmapper"></a>Configure ServiceBusMessageConverter to Customize ObjectMapper</h5>
<div class="paragraph">
<p><code>ServiceBusMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-sb-headers"><a class="anchor" href="#si-sb-headers"></a>Service Bus Message Headers</h5>
<div class="paragraph">
<p>For some Service Bus headers that can be mapped to multiple Spring header constants, the priority of different Spring headers is listed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. Mapping between Service Bus Headers and Spring Headers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Bus Message Headers and Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Configurable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The RFC2045 Content-Type descriptor of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Correlation id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#CORRELATION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The correlation id of the message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#MESSAGE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has higher priority than <code>MessageHeaders#ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has lower priority than <code>ServiceBusMessageHeaders#MESSAGE_ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition key for sending the message to a partitioned entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#REPLY_CHANNEL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The address of an entity to send replies to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#REPLY_TO_SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ReplyToGroupId property value of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has higher priority than <code>AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has lower priority than <code>ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The session identifier for a session-aware entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to live</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TIME_TO_LIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration of time before this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "to" address of the message, reserved for future use in routing scenarios and presently ignored by the broker itself.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SUBJECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subject for the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter error description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_ERROR_DESCRIPTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The description for a message that has been dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter reason</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_REASON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reason a message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_SOURCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity in which the message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DELIVERY_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of the times this message was delivered to clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The enqueued sequence number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message was enqueued in Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expires at</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#EXPIRES_AT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message will expire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lock token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCK_TOKEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lock token for the current message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Locked until</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCKED_UNTIL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the lock of this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">State</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#STATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageState</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The state of the message, which can be Active, Deferred, or Scheduled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="partition-key-support"><a class="anchor" href="#partition-key-support"></a>Partition Key Support</h5>
<div class="paragraph">
<p>This starter supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p><em>Recommended:</em> Use <code>ServiceBusMessageHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Not recommended but currently supported:</em> <code>AzureHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(AzureHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When both <code>ServiceBusMessageHeaders.PARTITION_KEY</code> and <code>AzureHeaders.PARTITION_KEY</code> are set in the message headers,
<code>ServiceBusMessageHeaders.PARTITION_KEY</code> is preferred.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="session-support"><a class="anchor" href="#session-support"></a>Session Support</h5>
<div class="paragraph">
<p>This example demonstrates how to manually set the session id of a message in the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the <code>ServiceBusMessageHeaders.SESSION_ID</code> is set in the message headers, and a different <code>ServiceBusMessageHeaders.PARTITION_KEY</code> (or <code>AzureHeaders.PARTITION_KEY</code>) header is also set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-11"><a class="anchor" href="#samples-11"></a>13.2.5. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/servicebus/spring-cloud-azure-starter-integration-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-storage-queue"><a class="anchor" href="#spring-integration-with-azure-storage-queue"></a>13.3. Spring Integration with Azure Storage Queue</h3>
<div class="sect3">
<h4 id="key-concepts-4"><a class="anchor" href="#key-concepts-4"></a>13.3.1. Key Concepts</h4>
<div class="paragraph">
<p>Azure Queue Storage is a service for storing large numbers of messages. You access messages from anywhere in the world via authenticated calls using HTTP or HTTPS. A queue message can be up to 64 KB in size. A queue may contain millions of messages, up to the total capacity limit of a storage account. Queues are commonly used to create a backlog of work to process asynchronously.</p>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-8"><a class="anchor" href="#dependency-setup-8"></a>13.3.2. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-storage-queue&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-9"><a class="anchor" href="#configuration-9"></a>13.3.3. Configuration</h4>
<div class="paragraph">
<p>This starter provides the following configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-3"><a class="anchor" href="#connection-configuration-properties-3"></a>Connection Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Storage Queue.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. Connection configurable properties of spring-cloud-azure-starter-integration-storage-queue</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Storage Queue is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue service endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.sasToken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sas token credential</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.serviceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion that is used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.messageEncoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queue message encoding.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-8"><a class="anchor" href="#basic-usage-8"></a>13.3.4. Basic Usage</h4>
<div class="sect4">
<h5 id="send-messages-to-azure-storage-queue"><a class="anchor" href="#send-messages-to-azure-storage-queue"></a>Send messages to Azure Storage Queue</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      storage:
        queue:
          connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>StorageQueueTemplate</code> to send messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";
    private static final String OUTPUT_CHANNEL = "output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(StorageQueueTemplate storageQueueTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(STORAGE_QUEUE_NAME, storageQueueTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a Message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @Autowired
    StorageQueueOutboundGateway storageQueueOutboundGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface StorageQueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    public void demo() {
        this.storageQueueOutboundGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-messages-from-azure-storage-queue"><a class="anchor" href="#receive-messages-from-azure-storage-queue"></a>Receive Messages from Azure Storage Queue</h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>StorageQueueMessageSource</code> with the bean of <code>StorageQueueTemplate</code> to receive messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";

    @Bean
    @InboundChannelAdapter(channel = INPUT_CHANNEL, poller = @Poller(fixedDelay = "1000"))
    public StorageQueueMessageSource storageQueueMessageSource(StorageQueueTemplate storageQueueTemplate) {
        return new StorageQueueMessageSource(STORAGE_QUEUE_NAME, storageQueueTemplate);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with StorageQueueMessageSource created in the last step via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
            .doOnError(Throwable::printStackTrace)
            .doOnSuccess(t -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
            .block();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-12"><a class="anchor" href="#samples-12"></a>13.3.5. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/storage/spring-cloud-azure-starter-integration-storage-queue">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-stream-support"><a class="anchor" href="#spring-cloud-stream-support"></a>14. Spring Cloud Stream Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Stream is a framework for building highly scalable event-driven microservices connected with shared messaging systems.</p>
</div>
<div class="paragraph">
<p>The framework provides a flexible programming model built on already established and familiar Spring idioms and best practices, including support for persistent pub/sub semantics, consumer groups, and stateful partitions.</p>
</div>
<div class="paragraph">
<p>Current binder implementations include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-stream-binder-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-stream-binder-servicebus</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-event-hubs"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-event-hubs"></a>14.1. Spring Cloud Stream Binder for Azure Event Hubs</h3>
<div class="sect3">
<h4 id="key-concepts-5"><a class="anchor" href="#key-concepts-5"></a>14.1.1. Key Concepts</h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Event Hubs provides the binding implementation for the Spring Cloud Stream framework.
This implementation uses Spring Integration Event Hubs Channel Adapters at its foundation. From design&#8217;s perspective,
Event Hubs is similar as Kafka. Also, Event Hubs could be accessed via Kafka API. If your project has tight dependency
on Kafka API, you can try <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/eventhubs/spring-cloud-azure-starter/spring-cloud-azure-sample-eventhubs-kafka">Events Hub with Kafka API Sample</a></p>
</div>
<div class="sect4">
<h5 id="consumer-group-2"><a class="anchor" href="#consumer-group-2"></a>Consumer Group</h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-2"><a class="anchor" href="#partitioning-support-2"></a>Partitioning Support</h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, properties of <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.load-balancing.*</code> are provided. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-2"><a class="anchor" href="#batch-consumer-support-2"></a>Batch Consumer Support</h5>
<div class="paragraph">
<p>Spring Cloud Azure Stream Event Hubs binder supports <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_batch_consumers">Spring Cloud Stream Batch Consumer feature</a>.</p>
</div>
<div class="paragraph">
<p>To work with the batch-consumer mode, the property of <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.consumer.batch-mode</code> should be set as <code>true</code>. When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the <code>Consumer</code> function. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#scs-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received by the binder. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch size can be specified by properties of <code>max-size</code> and <code>max-wait-time</code> with prefix as <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.batch.</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-9"><a class="anchor" href="#dependency-setup-9"></a>14.1.2. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Event Hubs Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-10"><a class="anchor" href="#configuration-10"></a>14.1.3. Configuration</h4>
<div class="paragraph">
<p>The binder provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="eventhubs-connection-configuration"><a class="anchor" href="#eventhubs-connection-configuration"></a>Connection Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. Connection configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Event Hubs binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, please refer to the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties-2"><a class="anchor" href="#checkpoint-configuration-properties-2"></a>Checkpoint Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically with the name from <strong>spring.cloud.stream.bindings.&lt;binding-name&gt;.destination</strong>.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. Checkpointing configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="azure-event-hubs-binding-configuration-properties"><a class="anchor" href="#azure-event-hubs-binding-configuration-properties"></a>Azure Event Hubs Binding Configuration Properties</h5>
<div class="paragraph">
<p>Below options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="eventhubs-consumer-properties"><a class="anchor" href="#eventhubs-consumer-properties"></a>Consumer Properties</h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Consumer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CheckpointMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpoint mode used when consumer decide how to checkpoint message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the amount of message for each partition to do one checkpoint. Will take effect only when <code>PARTITION_COUNT</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the time interval to do one checkpoint. Will take effect only when <code>TIME</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of events in a batch. Required for the batch-consumer mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-wait-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum time duration for batch consuming. Will take effect only when the batch-consumer mode is enabled and is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.update-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval time duration for updating.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LoadBalancingStrategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The load balancing strategy.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.partition-ownership-expiration-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time duration after which the ownership of partition expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.track-last-enqueued-event-properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the event processor should request information on the last enqueued event on its associated partition, and track that information as events are received.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The count used by the consumer to control the number of events the Event Hub consumer will actively receive and queue locally.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.initial-partition-event-position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map with the key as the partition id, and values of <code>StartPositionProperties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The map containing the event position to use for each partition if a checkpoint for the partition does not exist in checkpoint store. This map is keyed off of the partition id.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>initial-partition-event-position</code> configuration accepts a <code>map</code> to specify the initial position for each event hub. Thus, its key is the partition id, and the value is of <code>StartPositionProperties</code> which includes properties of offset, sequence number, enqueued date time and whether inclusive. For example, you can set it as
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    stream:
      eventhubs:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              initial-partition-event-position:
                0:
                  offset: earliest
                1:
                  sequence-number: 100
                2:
                  enqueued-date-time: 2022-01-12T13:32:47.650005Z
                4:
                  inclusive: false</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration"><a class="anchor" href="#advanced-consumer-configuration"></a>Advanced Consumer Configuration</h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a>, <a href="#checkpoint-configuration-properties">checkpoint</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties"><a class="anchor" href="#producer-properties"></a>Producer Properties</h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 30. Producer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The switch flag for sync of producer. If true, the producer will wait for a response after a send operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to wait for a response after a send operation. Will take effect only when a sync producer is enabled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration"><a class="anchor" href="#advanced-producer-configuration"></a>Advanced Producer Configuration</h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-9"><a class="anchor" href="#basic-usage-9"></a>14.1.4. Basic Usage</h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-event-hubs"><a class="anchor" href="#sending-and-receiving-messages-fromto-event-hubs"></a>Sending and Receiving Messages from/to Event Hubs</h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT_CONTAINER}
            account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
            account-key: ${CHECKPOINT_ACCESS_KEY}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identites, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}

      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload(),
                message.getHeaders().get(EventHubsHeaders.PARTITION_KEY),
                message.getHeaders().get(EventHubsHeaders.SEQUENCE_NUMBER),
                message.getHeaders().get(EventHubsHeaders.OFFSET),
                message.getHeaders().get(EventHubsHeaders.ENQUEUED_TIME)
        );

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-3"><a class="anchor" href="#partitioning-support-3"></a>Partitioning Support</h5>
<div class="paragraph">
<p>A <code>PartitionSupplier</code> with user-provided partition information will be created to configure the partition information about the message to be sent, the following is the process of obtaining different priorities of the partition ID and key:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/63028776/145347877-fa8afa90-ec28-4c0a-8277-63b9fdaa5d0f.png" alt="145347877 fa8afa90 ec28 4c0a 8277 63b9fdaa5d0f"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-3"><a class="anchor" href="#batch-consumer-support-3"></a>Batch Consumer Support</h5>
<div class="paragraph">
<p>Step 1. Fill the batch configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume
      bindings:
        consume-in-0:
          destination: ${AZURE_EVENTHUB_NAME}
          group: ${AZURE_EVENTHUB_CONSUMER_GROUP}
          consumer:
            batch-mode: true
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              batch:
                max-batch-size: 10 # Required for batch-consumer mode
                max-wait-time: 1m # Optional, the default value is null
              checkpoint:
                mode: BATCH # or MANUAL as needed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>BATCH</code>, you can use below code to send messages and consume in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
            for (int i = 0; i &lt; message.getPayload().size(); i++) {
                LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                        message.getPayload().get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
            }

        };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>MANUAL</code>, you can use below code to send messages and consume/checkpoint in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
        for (int i = 0; i &lt; message.getPayload().size(); i++) {
            LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload().get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
        }

        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        checkpointer.success()
                    .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                    .doOnError(error -&gt; LOGGER.error("Exception found", error))
                    .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the batch-consuming mode, the default content type of Spring Cloud Stream binder is <code>application/json</code>, so make sure the message payload is aligned with the content type. For example, when using the default content type of <code>application/json</code> to receive messages with <code>String</code> payload, the payload should be JSON String, surrounded with double quotes for the original String text. While for <code>text/plain</code> content type, it can be a <code>String</code> object directly. For more details, please refer to the official doc of <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#content-type-management">Spring Cloud Stream Content Type Negotiation</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels"><a class="anchor" href="#error-channels"></a>Error Channels</h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, you can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-eh-headers"><a class="anchor" href="#scs-eh-headers"></a>Event Hubs Message Headers</h5>
<div class="paragraph">
<p>See the <a href="#si-eh-headers">Event Hubs message headers</a> for the basic message headers supported.</p>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support"><a class="anchor" href="#multiple-binder-support"></a>Multiple Binder Support</h5>
<div class="paragraph">
<p>Connection to multiple Event Hubs namespaces is also supported by using multiple binders.This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of EventHubs, we need to configure below properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${EVENTHUB_NAME_01}
          group: ${CONSUMER_GROUP_01}
        supply1-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_01_AS_ABOVE}
        consume2-in-0:
          binder: eventhub-2
          destination: ${EVENTHUB_NAME_02}
          group: ${CONSUMER_GROUP_02}
        supply2-out-0:
          binder: eventhub-2
          destination: ${THE_SAME_EVENTHUB_NAME_02_AS_ABOVE}
      binders:
        eventhub-1:
          type: eventhubs
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_01_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_01}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
        eventhub-2:
          type: eventhubs
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_02_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_02}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
      eventhubs:
        bindings:
          consume1-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
          consume2-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message1 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message2 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision"><a class="anchor" href="#resource-provision"></a>Resource Provision</h5>
<div class="paragraph">
<p>Event Hubs binder supports provisioning of event hub and consumer group, users could use below properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURECE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-13"><a class="anchor" href="#samples-13"></a>14.1.5. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/eventhubs/spring-cloud-azure-stream-binder-eventhubs">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-service-bus"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-service-bus"></a>14.2. Spring Cloud Stream Binder for Azure Service Bus</h3>
<div class="sect3">
<h4 id="key-concepts-6"><a class="anchor" href="#key-concepts-6"></a>14.2.1. Key Concepts</h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Service Bus provides the binding implementation for the Spring Cloud Stream Framework.
This implementation uses Spring Integration Service Bus Channel Adapters at its foundation.</p>
</div>
<div class="sect4">
<h5 id="scheduled-message"><a class="anchor" href="#scheduled-message"></a>Scheduled Message</h5>
<div class="paragraph">
<p>This binder supports submitting messages to a topic for delayed processing. Users can send scheduled messages with header <code>x-delay</code>
expressing in milliseconds a delay time for the message. The message will be delivered to the respective topics after <code>x-delay</code> milliseconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-group-3"><a class="anchor" href="#consumer-group-3"></a>Consumer Group</h5>
<div class="paragraph">
<p>Service Bus Topic provides similar support of consumer group as Apache Kafka, but with slight different logic.
This binder relies on <code>Subscription</code> of a topic to act as a consumer group.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-10"><a class="anchor" href="#dependency-setup-10"></a>14.2.2. Dependency Setup</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Service Bus Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-11"><a class="anchor" href="#configuration-11"></a>14.2.3. Configuration</h4>
<div class="paragraph">
<p>The binder provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="servicebus-connection-configuration"><a class="anchor" href="#servicebus-connection-configuration"></a>Connection Configuration Properties</h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. Connection configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Service Bus binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.servicebus.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, please refer to the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="azure-service-bus-binding-configuration-properties"><a class="anchor" href="#azure-service-bus-binding-configuration-properties"></a>Azure Service Bus Binding Configuration Properties</h5>
<div class="paragraph">
<p>Below options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="consumer-properties"><a class="anchor" href="#consumer-properties"></a>Consumer Properties</h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. Consumer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.requeue-rejected</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the failed messages are routed to the DLQ.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-calls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max concurrent messages that the Service Bus processor client should process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-sessions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of concurrent sessions to process at any given time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.session-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether session is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prefetch count of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.sub-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SubQueue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the sub queue to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-auto-lock-renew-duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to continue auto-renewing the lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.receive-mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusReceiveMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">peek_lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The receive mode of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.auto-complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to settle messages automatically. If set as false, a message header of <code>Checkpointer</code> will be added
to enable developers to settle messages manually.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration-2"><a class="anchor" href="#advanced-consumer-configuration-2"></a>Advanced Consumer Configuration</h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties-2"><a class="anchor" href="#producer-properties-2"></a>Producer Properties</h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. Producer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Switch flag
for sync of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout
value for sending of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.entity-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusEntityType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus entity type of the producer, required for the binding producer.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using the binding producer, property of <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.entity-type</code> is required to be configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration-2"><a class="anchor" href="#advanced-producer-configuration-2"></a>Advanced Producer Configuration</h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-10"><a class="anchor" href="#basic-usage-10"></a>14.2.4. Basic Usage</h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-service-bus"><a class="anchor" href="#sending-and-receiving-messages-fromto-service-bus"></a>Sending and Receiving Messages from/to Service Bus</h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${SERVICEBUS_NAMESPACE_CONNECTION_STRING}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload(),
                message.getHeaders().get(EventHubsHeaders.PARTITION_KEY),
                message.getHeaders().get(EventHubsHeaders.SEQUENCE_NUMBER),
                message.getHeaders().get(EventHubsHeaders.OFFSET),
                message.getHeaders().get(EventHubsHeaders.ENQUEUED_TIME)
        );

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partition-key-support-2"><a class="anchor" href="#partition-key-support-2"></a>Partition Key Support</h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Stream provides a partition key SpEL expression property <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code>. For example, setting this property as <code>&quot;&#39;partitionKey-&#39; + headers[&lt;message-header-key&gt;]&quot;</code> and add a header called &lt;message-header-key&gt;. Spring Cloud Stream will use the value for this header when evaluating the above expression to assign a partition key. Here is an example producer code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = “random payload”;
        return MessageBuilder.withPayload(value)
            .setHeader("&lt;message-header-key&gt;", value.length() % 4)
            .build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="session-support-2"><a class="anchor" href="#session-support-2"></a>Session Support</h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/message-sessions">message sessions</a> of Service Bus. Session id of a message could be set via the message header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = “random payload”;
        return MessageBuilder.withPayload(value)
            .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
            .build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
According to <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a>, session id has higher priority than partition key. So when both of <code>ServiceBusMessageHeaders#SESSION_ID</code> and <code>ServiceBusMessageHeaders#PARTITION_KEY</code> (or <code>AzureHeaders#PARTITION_KEY</code>) headers are set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels-2"><a class="anchor" href="#error-channels-2"></a>Error Channels</h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, and a default consumer error channel handler is used to send failed messages to the dead-letter queue when <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.requeue-rejected</code> is enabled, otherwise the failed messages will be abandoned.</p>
</div>
<div class="paragraph">
<p>To customize the consumer error channel handler, you can register you own error handler to the related consumer error channel in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-sb-headers"><a class="anchor" href="#scs-sb-headers"></a>Service Bus Message Headers</h5>
<div class="paragraph">
<p>See the <a href="#si-sb-headers">Service Bus message headers</a> for the basic message headers supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When setting the partiton key, the priority of message header is higher than Spring Cloud Stream property. So <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code> will take effect only when none of the headers of <code>ServiceBusMessageHeaders#SESSION_ID</code>, <code>ServiceBusMessageHeaders#PARTITION_KEY</code>, <code>AzureHeaders#PARTITION_KEY</code> is configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support-2"><a class="anchor" href="#multiple-binder-support-2"></a>Multiple Binder Support</h5>
<div class="paragraph">
<p>Connection to multiple Service Bus namespaces is also supported by using multiple binders. This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of ServiceBus, we need to configure below properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${SERVICEBUS_TOPIC_NAME}
          group: ${SUBSCRIPTION_NAME}
        supply1-out-0:
          destination: ${SERVICEBUS_TOPIC_NAME_SAME_AS_ABOVE}
        consume2-in-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME}
        supply2-out-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME_SAME_AS_ABOVE}
      binders:
        servicebus-1:
          type: servicebus
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_01_CONNECTION_STRING}
        servicebus-2:
          type: servicebus
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_02_CONNECTION_STRING}
      servicebus:
        bindings:
          consume1-in-0:
            consumer:
              auto-complete: false
          supply1-out-0:
            producer:
              entity-type: topic
          consume2-in-0:
            consumer:
              auto-complete: false
          supply2-out-0:
            producer:
              entity-type: queue
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision-2"><a class="anchor" href="#resource-provision-2"></a>Resource Provision</h5>
<div class="paragraph">
<p>Service bus binder supports provisioning of queue, topic and subscription, users could use below properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      servicebus:
        resource:
          resource-group: ${AZURE_SERVICEBUS_RESOURECE_GROUP}
    stream:
      servicebus:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              entity-type: ${SERVICEBUS_CONSUMER_ENTITY_TYPE}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-14"><a class="anchor" href="#samples-14"></a>14.2.5. Samples</h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}/servicebus/spring-cloud-azure-stream-binder-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-jms-support"><a class="anchor" href="#spring-jms-support"></a>15. Spring JMS Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use Azure Service Bus by the JMS API integrated into the Spring JMS framework.
Azure Service Bus connection string have to be provided which is to be parsed into the login username, password and remote URI for the AMQP broker.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-11"><a class="anchor" href="#dependency-setup-11"></a>15.1. Dependency Setup</h3>
<div class="paragraph">
<p>Adding below dependencies if you want to migrate your Spring JMS application to use Azure Service Bus.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-servicebus-jms&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-12"><a class="anchor" href="#configuration-12"></a>15.2. Configuration</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. Configurable properties when using Spring JMS support</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus connection string. Should be provided when want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.topic-client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS clientID. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration for idle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pricing-tier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Service Bus Price Tier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-pub-sub-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the reply destination type is topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the phase in which this container should be started and stopped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-qos-settings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure the QosSettings to use when sending a reply.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-durable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription durable. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-shared</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription shared. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login password of the AMQP broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="jms-servicebus-pool-configuration"></a> Whether to block when a connection is requested and the pool is full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blocking period before throwing an exception if the pool is still full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether a JmsPoolConnectionFactory should be created, instead of a regularConnectionFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection idle timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-connections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-sessions-per-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled sessions per connection in the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.time-between-expiration-check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to sleep between runs of the idle connection eviction thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.use-anonymous-producers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use only one anonymous "MessageProducer" instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fallback value for prefetch option in this Service Bus namespace.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.durable-topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for durable topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-browser-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue browser.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.remote-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL of the AMQP broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login user of the AMQP broker.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring JMS general configuration is omited for short.
Please refer to <a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/jms.html">Spring JMS Document</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-11"><a class="anchor" href="#basic-usage-11"></a>15.3. Basic Usage</h3>
<div class="sect3">
<h4 id="use-service-bus-connection-string"><a class="anchor" href="#use-service-bus-connection-string"></a>15.3.1. Use Service Bus Connection String</h4>
<div class="paragraph">
<p>The simplest way to connect to Service Bus for Spring JMS application is with the connection string.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  jms:
    servicebus:
      connection-string: ${AZURE_SERVICEBUS_CONNECTION_STRING}
      pricing-tier: ${PRICING_TIER}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default enabled <code>ConnectionFactory</code> is the <code>CachingConnectionFactory</code> which adds Session caching as well MessageProducer caching. If you want to activate the connection pooling featured one of JmsPoolConnectionFactory, the property of <code>spring.jms.servicebus.pool.enabled</code> should be specified <code>true</code>. You can find other pooling configuration options (properties with prefix <code>spring.jms.servicebus.pool.</code>) from the above
<a href="#jms-servicebus-pool-configuration">Configuration</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-15"><a class="anchor" href="#samples-15"></a>15.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka-support"><a class="anchor" href="#kafka-support"></a>16. Kafka Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to Azure Event Hubs (<a href="https://azure.microsoft.com/pricing/details/event-hubs/#explore-pricing-options">Basic pricing tier is not supported</a>) using Spring Kafka libraries. There are two approaches to connect to Azure Event Hubs for Kafka, the first one is to provide the Azure Event Hubs connection string directly, the other is to use Azure Resource Manager to retrieve the connection string.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-12"><a class="anchor" href="#dependency-setup-12"></a>16.1. Dependency Setup</h3>
<div class="paragraph">
<p>Adding below dependencies if you want to migrate your Apache Kafka application to use Azure Event Hubs for Kafka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to retrieve the connection string using Azure Resource Manager, please also add below dependency</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-13"><a class="anchor" href="#configuration-13"></a>16.2. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 35. Configurable properties when using Kafka support</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.kafka.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Azure Event Hubs Kafka support, default to true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs connection string. Should be provided when want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs namespace. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Event Hubs namespace. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription id. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication information is also required for authenticating for Azure Resource Manager. The credential related configurations of Resource Manager should be configured under prefix <code>spring.cloud.azure</code>. Please refer to <a href="index.html#authentication">Authentication</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-12"><a class="anchor" href="#basic-usage-12"></a>16.3. Basic Usage</h3>
<div class="sect3">
<h4 id="use-event-hubs-connection-string"><a class="anchor" href="#use-event-hubs-connection-string"></a>16.3.1. Use Event Hubs Connection String</h4>
<div class="paragraph">
<p>The simplest way to connect to Event Hubs for Kafka is with the connection string.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${AZURE_EVENTHUBS_CONNECTION_STRING}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="use-azure-resource-manager-to-retrieve-connection-string"><a class="anchor" href="#use-azure-resource-manager-to-retrieve-connection-string"></a>16.3.2. Use Azure Resource Manager to Retrieve Connection String</h4>
<div class="paragraph">
<p>If you don&#8217;t want to configure connection string in your application, it&#8217;s also possible to use Azure Resource Manager to retrieve the connection string. And you could use credentials stored in Azure CLI or other local development tool, like Visual Studio Code or Intellij IDEA to authenticate with Azure Resource Manager. Or Managed Identity if your application is deployed to Azure Cloud. Just make sure the principal have sufficient permission to read resource metadata.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        namespace: ${AZURE_EVENTHUBS_NAMESPACE}
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-16"><a class="anchor" href="#samples-16"></a>16.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="redis-support"><a class="anchor" href="#redis-support"></a>17. Redis Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to Azure Cache for Redis using Spring Redis libraries. With adding <code>spring-cloud-azure-starter</code> and <code>spring-cloud-azure-resourcemanager</code> to your application, it&#8217;s possible to read the Azure Cache for Redis connection information through Azure Resource Manager and auto-configure the Redis properties.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-13"><a class="anchor" href="#dependency-setup-13"></a>17.1. Dependency Setup</h3>
<div class="paragraph">
<p>Adding below dependencies if you want to use the Spring Cloud Azure Redis support to your Spring Boot application using Redis.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-14"><a class="anchor" href="#configuration-14"></a>17.2. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. Configurable properties when using Redis support</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cache for Redis instance name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cache for Redis instance name.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Cache for Redis.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription id.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication information is also required for authenticating for Azure Resource Manager. The credential related configurations of Resource Manager should be configured under prefix <code>spring.cloud.azure</code>. Please refer to <a href="index.html#authentication">Authentication</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-13"><a class="anchor" href="#basic-usage-13"></a>17.3. Basic Usage</h3>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.cloud.azure.redis.name=${AZURE_CACHE_REDIS_NAME}
spring.cloud.azure.redis.resource.resource-group=${AZURE_CACHE_REDIS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-17"><a class="anchor" href="#samples-17"></a>17.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-azure-resourcemanager"><a class="anchor" href="#spring-cloud-azure-resourcemanager"></a>18. Resource Manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Azure Resource Manager (ARM) is the deployment and management service for Azure. It provides a management layer that enables you to create, update, and delete resources in your Azure account. Spring Cloud Azure Resourcemanger can help provision resources or retrieve resource metadata.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-14"><a class="anchor" href="#dependency-setup-14"></a>18.1. Dependency Setup</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-15"><a class="anchor" href="#configuration-15"></a>18.2. Configuration</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Configurable properties of spring-cloud-azure-resourcemanager</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.resource-manager</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the Resource Manager is enabled. Default is true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.cloud-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.environment.active-directory-endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Active Directory endpoint to connect to for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscription id to use when connecting to Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant id for Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace of the Azure service to provision resources with.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group holding an Azure service resource.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="resource-manager-basic-usage"><a class="anchor" href="#resource-manager-basic-usage"></a>18.3. Basic Usage</h3>
<div class="paragraph">
<p>Spring Cloud Azure Resource Manager can work together with specific Spring Cloud Azure starters to retrieve connection information, such as connection strings, to connect to Azure services. It can also together with <code>spring-cloud-azure-starter</code> and third-party libraries to retrieve metadata like username/password, to complete authentication, such as: <a href="#kafka-support">Kafka Support</a>, <a href="#redis-support">Redis Support</a>.</p>
</div>
<div class="paragraph">
<p>For example, to retrieve the connection string of an Azure Service, developers can use a service principal as the credential to authenticate and retrieve the connection string. The configuration is listed as below. The provided service principal should
be assigned a role of <code>Contributor</code> of the associated namespace at least. Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the principal has been granted the sufficient permission to access the Azure resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      &lt;azure-service&gt;:
        namespace: ${SERVICEBUS_NAMESPACE}
        resource:
          resource-group: ${RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-18"><a class="anchor" href="#samples-18"></a>18.4. Samples</h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_{project-version}">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties-2"><a class="anchor" href="#configuration-properties-2"></a>19. Configuration Properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a>20. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration-properties-3"><a class="anchor" href="#configuration-properties-3"></a>20.1. <a href="appendix.html##configuration-properties">Configuration properties</a></h3>

</div>
<div class="sect2">
<h3 id="migration-guide-for-4-0-2"><a class="anchor" href="#migration-guide-for-4-0-2"></a>20.2. <a href="appendix.html#migration-guide-for-4-0">Migration guide for 4.0</a></h3>

</div>
<div class="sect2">
<h3 id="known-issues"><a class="anchor" href="#known-issues"></a>20.3. <a href="appendix.html#known-issues">Known issues</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-boot"><a class="anchor" href="#spring-boot"></a>21. <a href="https://projects.spring.io/spring-boot/">Spring Boot</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="spring-project-references"><a class="anchor" href="#spring-project-references"></a>22. <a href="https://spring.io/projects">Spring Project References</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="spring-boot-starters-for-azure"><a class="anchor" href="#spring-boot-starters-for-azure"></a>23. <a href="https://github.com/Microsoft/azure-spring-boot/">Spring Boot Starters for Azure</a></h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-31 22:38:59 +0800
</div>
</div>
<script src="js/highlight/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>